<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Monitoring & Manajemen Tahfidz Santri</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script><!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyAxoe-Bg6WUn59KjzaunvkCRVUbi1X95PQ",
      authDomain: "tahfidzmabash.firebaseapp.com",
      projectId: "tahfidzmabash",
      storageBucket: "tahfidzmabash.firebasestorage.app",
      messagingSenderId: "113529956394",
      appId: "1:113529956394:web:d6c9eedda4014fae937b53",
      measurementId: "G-GN5B5DLSPH"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.firestore = { collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, onSnapshot };
  </script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    .scrollable-nav {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .scrollable-nav::-webkit-scrollbar {
      display: none;
    }
    
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .btn-loading {
      position: relative;
      color: transparent;
    }
    
    .btn-loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .pembimbing-card {
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .pembimbing-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    
    .pembimbing-card.active {
      border: 3px solid #6366f1;
      background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
      box-shadow: 0 10px 25px rgba(99, 102, 241, 0.3);
    }
    
    /* Responsive styles */
    @media (max-width: 768px) {
      .toast {
        max-width: 90%;
        font-size: 0.875rem;
      }
      
      /* Responsive table wrapper */
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      
      .table-responsive table {
        min-width: 600px;
      }
      
      /* Mobile modal adjustments */
      .modal-backdrop > div {
        max-height: 90vh;
        overflow-y: auto;
      }
    }
    
    @media (max-width: 640px) {
      /* Adjust stats cards text size on mobile */
      .stat-card-value {
        font-size: 1.75rem !important;
      }
      
      .stat-card-label {
        font-size: 0.75rem !important;
      }
      
      /* Menu grid responsive */
      .menu-grid {
        grid-template-columns: repeat(2, 1fr) !important;
      }
      
      /* Adjust form inputs */
      input, select, textarea {
        font-size: 16px !important; /* Prevents zoom on iOS */
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto" style="background: #FFFFFF;"><!-- Top Navigation -->
   <nav class="bg-white sticky top-0 z-50 border-b-2">
    <div class="px-3 sm:px-4 py-2 sm:py-3">
     <div class="flex items-center justify-between mb-2 sm:mb-3">
      <div class="flex items-center space-x-2 sm:space-x-3"><img src="https://ypwi.or.id/assets/setting/front/meta/image.png" alt="Logo Pondok" class="w-10 h-10 sm:w-14 sm:h-14 object-contain flex-shrink-0">
       <div class="min-w-0">
        <h1 id="app-title" class="text-sm sm:text-lg md:text-xl font-bold text-gray-800 leading-tight">Sistem Monitoring & Manajemen Tahfidz Santri</h1>
        <p id="madrasah-name" class="text-xs text-gray-600 truncate">Ma'had Abu Bakar Ash-Shiddiq Anabanua, Kab. Wajo</p>
       </div>
      </div>
     </div>
     <div class="scrollable-nav overflow-x-auto">
      <div class="flex space-x-1 sm:space-x-2 pb-2" style="min-width: max-content;"><button onclick="window.showPage('dashboard', event)" class="nav-btn px-2 sm:px-4 py-1.5 sm:py-2 rounded-md bg-gray-800 text-white text-xs sm:text-sm font-medium whitespace-nowrap transition"> <i class="fas fa-home mr-1"></i><span class="hidden xs:inline">Dashboard</span><span class="xs:hidden">Home</span> </button> <button onclick="window.showPage('kelola-pembimbing', event)" class="nav-btn px-2 sm:px-4 py-1.5 sm:py-2 rounded-md bg-gray-200 text-gray-700 text-xs sm:text-sm font-medium whitespace-nowrap hover:bg-gray-300 transition"> <i class="fas fa-users mr-1"></i><span class="hidden sm:inline">Kelola Pembimbing</span><span class="sm:hidden">Pembimbing</span> </button> <button onclick="window.showPage('pembimbing', event)" class="nav-btn px-2 sm:px-4 py-1.5 sm:py-2 rounded-md bg-gray-200 text-gray-700 text-xs sm:text-sm font-medium whitespace-nowrap hover:bg-gray-300 transition"> <i class="fas fa-chalkboard-teacher mr-1"></i><span class="hidden sm:inline">Menu Pembimbing</span><span class="sm:hidden">Menu</span> </button> <button onclick="window.showPage('kelola-sesi', event)" class="nav-btn px-2 sm:px-4 py-1.5 sm:py-2 rounded-md bg-gray-200 text-gray-700 text-xs sm:text-sm font-medium whitespace-nowrap hover:bg-gray-300 transition"> <i class="fas fa-clock mr-1"></i><span class="hidden sm:inline">Kelola Sesi</span><span class="sm:hidden">Sesi</span> </button>
      </div>
     </div>
    </div>
   </nav><!-- Toast Container -->
   <div id="toast-container" class="fixed top-20 right-4 z-50 space-y-2"></div><!-- Edit Pembimbing Modal -->
   <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
     <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-edit mr-2 text-indigo-600"></i>Edit Pembimbing</h3>
     <form id="form-edit-pembimbing" class="space-y-4"><input type="hidden" id="edit-pembimbing-id">
      <div><label for="edit-nama-pembimbing" class="block text-sm font-medium text-gray-700 mb-1">Nama Pembimbing</label> <input type="text" id="edit-nama-pembimbing" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>
      <div><label for="edit-nama-halaqah" class="block text-sm font-medium text-gray-700 mb-1">Nama Halaqah</label> <input type="text" id="edit-nama-halaqah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>
      <div class="flex space-x-2"><button type="submit" id="btn-update-pembimbing" class="flex-1 bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Update </button> <button type="button" onclick="window.closeEditModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium hover:bg-gray-400"> <i class="fas fa-times mr-2"></i>Batal </button>
      </div>
     </form>
    </div>
   </div><!-- Main Content -->
   <div class="p-3 sm:p-4 md:p-6"><!-- Dashboard Page -->
    <div id="page-dashboard" class="page-content">
     <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4 mb-4 sm:mb-6">
      <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl shadow-lg p-4 sm:p-6 transform hover:scale-105 transition duration-300">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-blue-100 text-xs sm:text-sm mb-1 stat-card-label">Total Pembimbing</p>
         <p id="total-pembimbing" class="text-2xl sm:text-3xl font-bold stat-card-value">0</p>
        </div>
        <div class="bg-white bg-opacity-20 rounded-full p-3 sm:p-4"><i class="fas fa-chalkboard-teacher text-2xl sm:text-3xl"></i>
        </div>
       </div>
      </div>
      <div class="bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl shadow-lg p-4 sm:p-6 transform hover:scale-105 transition duration-300">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-green-100 text-xs sm:text-sm mb-1 stat-card-label">Total Santri</p>
         <p id="total-santri" class="text-2xl sm:text-3xl font-bold stat-card-value">0</p>
        </div>
        <div class="bg-white bg-opacity-20 rounded-full p-3 sm:p-4"><i class="fas fa-user-graduate text-2xl sm:text-3xl"></i>
        </div>
       </div>
      </div>
      <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl shadow-lg p-4 sm:p-6 transform hover:scale-105 transition duration-300 sm:col-span-2 lg:col-span-1">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-purple-100 text-xs sm:text-sm mb-1 stat-card-label">Rata-rata Hafalan</p>
         <p id="avg-hafalan" class="text-2xl sm:text-3xl font-bold stat-card-value">0 Juz</p>
        </div>
        <div class="bg-white bg-opacity-20 rounded-full p-3 sm:p-4"><i class="fas fa-book-quran text-2xl sm:text-3xl"></i>
        </div>
       </div>
      </div>
     </div>
     <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-l-4 border-indigo-600 rounded-lg shadow-md p-4 sm:p-6">
      <div class="flex items-start">
       <div class="flex-shrink-0"><i class="fas fa-info-circle text-2xl sm:text-3xl text-indigo-600"></i>
       </div>
       <div class="ml-3 sm:ml-4 flex-1 min-w-0">
        <h3 class="text-base sm:text-lg font-bold text-gray-800 mb-2">Selamat Datang di Sistem Monitoring & Manajemen Tahfidz Santri</h3>
        <p class="text-sm text-gray-600 bg-white bg-opacity-60 rounded-lg p-3 mt-3">Sistem ini membantu Pembimbing (Muhaffizh/ah) untuk mengelola dan memantau perkembangan hafalan santri secara terstruktur dan profesional.</p>
        <p class="text-sm text-gray-600 bg-white bg-opacity-60 rounded-lg p-3 mt-3"><strong>Tips 1:</strong> Mulai dengan menambahkan data pembimbing di menu <span class="font-semibold text-black-700">Kelola Pembimbing</span>, kemudian masuk ke <span class="font-semibold text-black-700">Menu Pembimbing</span> untuk mengelola santri dan input data hafalan.</p>
         <p class="text-sm text-gray-600 bg-white bg-opacity-60 rounded-lg p-3 mt-3"><strong>Tips 2:</strong> Untuk penginputan data harian <span class="font-semibold text-black-700">bisa menggunakan HP atau laptop.</span> Adapun untuk download laporan pekanan, laporan bulanan dan rapor semester, <span class="font-semibold text-black-700">disarankan untuk menggunakan LAPTOP</span> agar hasil downloadnya rapi.</p>
       </div>
      </div>
     </div>
    </div><!-- Kelola Pembimbing Page -->
    <div id="page-kelola-pembimbing" class="page-content hidden">
     <div class="bg-white border border-gray-300 rounded-lg p-4 mb-4">
      <h3 class="text-base font-bold text-gray-800 mb-3">Tambah Pembimbing</h3>
      <form id="form-pembimbing" class="space-y-3">
       <div><label for="nama-pembimbing" class="block text-sm font-medium text-gray-700 mb-1">Nama Pembimbing</label> <input type="text" id="nama-pembimbing" required class="w-full px-3 py-2 text-sm border border-gray-300 focus:border-gray-800 focus:outline-none">
       </div>
       <div><label for="nama-halaqah" class="block text-sm font-medium text-gray-700 mb-1">Nama Halaqah</label> <input type="text" id="nama-halaqah" required class="w-full px-3 py-2 text-sm border border-gray-300 focus:border-gray-800 focus:outline-none">
       </div><button type="submit" id="btn-submit-pembimbing" class="bg-gray-800 text-white px-4 py-2 text-sm font-medium hover:bg-black transition"> Simpan Pembimbing </button>
      </form>
     </div>
     <div class="bg-white border border-gray-300 rounded-lg p-4">
      <h3 class="text-base font-bold text-gray-800 mb-3">Daftar Pembimbing</h3>
      <div id="list-pembimbing" class="space-y-2"></div>
     </div>
    </div><!-- Menu Pembimbing Page -->
    <div id="page-pembimbing" class="page-content hidden">
     <div class="bg-white border border-gray-300 rounded-lg p-4 mb-4">
      <h3 class="text-base font-bold text-gray-800 mb-3">Pilih Pembimbing</h3>
      <div id="pembimbing-cards" class="grid grid-cols-1 md:grid-cols-3 gap-3"></div>
     </div>
     <div id="pembimbing-menu" class="hidden">
      <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-2 sm:gap-3 md:gap-4 mb-4 sm:mb-6 menu-grid"><button onclick="window.showSubMenu('kelola-santri')" class="bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-user-graduate text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Kelola Santri</p></button> <button onclick="window.showSubMenu('tahun-ajaran')" class="bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-calendar-alt text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Tahun Ajaran</p></button> <button onclick="window.showSubMenu('input-hafalan')" class="bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-book-quran text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Input Hafalan</p></button> <button onclick="window.showSubMenu('input-tahsin')" class="bg-gradient-to-br from-pink-500 to-pink-600 hover:from-pink-600 hover:to-pink-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-spell-check text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Input Tahsin</p></button> <button onclick="window.showSubMenu('input-murajaah')" class="bg-gradient-to-br from-yellow-500 to-yellow-600 hover:from-yellow-600 hover:to-yellow-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-redo text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Input Murajaah</p></button> <button onclick="window.showSubMenu('input-hadits')" class="bg-gradient-to-br from-red-500 to-red-600 hover:from-red-600 hover:to-red-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-scroll text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Input Hadits</p></button> <button onclick="window.showSubMenu('mutabaah')" class="bg-gradient-to-br from-indigo-500 to-indigo-600 hover:from-indigo-600 hover:to-indigo-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-check-double text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Mutaba'ah</p></button> <button onclick="window.showSubMenu('absensi')" class="bg-gradient-to-br from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-clipboard-check text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Absensi</p></button> <button onclick="window.showSubMenu('tasmi')" class="bg-gradient-to-br from-cyan-500 to-cyan-600 hover:from-cyan-600 hover:to-cyan-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-headphones text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Tasmi'</p></button> <button onclick="window.showSubMenu('laporan-pekanan')" class="bg-gradient-to-br from-orange-500 to-orange-600 hover:from-orange-600 hover:to-orange-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-file-alt text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Laporan Pekanan</p></button> <button onclick="window.showSubMenu('laporan-bulanan')" class="bg-gradient-to-br from-rose-500 to-rose-600 hover:from-rose-600 hover:to-rose-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-file-pdf text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Laporan Bulanan</p></button> <button onclick="window.showSubMenu('rapor-semester')" class="bg-gradient-to-br from-violet-500 to-violet-600 hover:from-violet-600 hover:to-violet-700 text-white rounded-lg sm:rounded-xl shadow-lg p-3 sm:p-4 md:p-6 transition transform hover:scale-105"> <i class="fas fa-graduation-cap text-2xl sm:text-3xl md:text-4xl mb-2 sm:mb-3"></i> <p class="text-xs sm:text-sm font-semibold">Rapor Semester</p></button>
      </div><!-- Sub Menus -->
      <div id="submenu-kelola-santri" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Kelola Santri</h3>
       <form id="form-santri" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label for="nis" class="block text-sm font-medium text-gray-700 mb-1">NIS</label> <input type="text" id="nis" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="nama-santri" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <input type="text" id="nama-santri" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="kelas" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label> <input type="text" id="kelas" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="nama-wali" class="block text-sm font-medium text-gray-700 mb-1">Nama Orang Tua/Wali</label> <input type="text" id="nama-wali" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="hafalan-juz" class="block text-sm font-medium text-gray-700 mb-1">Total Hafalan (Juz)</label> <input type="number" id="hafalan-juz" min="0" max="30" value="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="hafalan-halaman" class="block text-sm font-medium text-gray-700 mb-1">Total Hafalan (Halaman)</label> <input type="number" id="hafalan-halaman" min="0" max="604" value="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="total-hadits" class="block text-sm font-medium text-gray-700 mb-1">Total Hadits</label> <input type="number" id="total-hadits" min="0" value="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div><button type="submit" id="btn-submit-santri" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Santri </button>
       </form>
       <div id="list-santri" class="space-y-3"></div>
      </div>
      <div id="submenu-tahun-ajaran" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Kelola Tahun Ajaran</h3>
       <form id="form-tahun-ajaran" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div><label for="tahun-ajaran" class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label> <input type="text" id="tahun-ajaran" placeholder="2023/2024" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div><button type="submit" id="btn-submit-tahun" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Tahun Ajaran </button>
       </form>
       <div><label for="filter-tahun-ajaran" class="block text-sm font-medium text-gray-700 mb-1">Filter Tahun Ajaran</label> <select id="filter-tahun-ajaran" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Semua Tahun Ajaran --</option> </select>
       </div>
      </div>
      <div id="submenu-input-hafalan" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Hafalan Baru</h3>
       <form id="form-hafalan-baru" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-hafalan" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-hafalan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-hafalan" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-hafalan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="bg-blue-50 border border-blue-300 rounded-lg p-3 mb-2">
         <p class="text-sm text-blue-800 font-medium mb-1">ðŸ“– Range Hafalan (Dari - Sampai)</p>
         <p class="text-xs text-blue-700">Contoh: Juz 30 Hal 582 sampai Juz 30 Hal 584 = 3 halaman</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="juz-hafalan-dari" class="block text-sm font-medium text-gray-700 mb-1">Juz Dari</label> <input type="number" id="juz-hafalan-dari" min="1" max="30" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="halaman-hafalan-dari" class="block text-sm font-medium text-gray-700 mb-1">Halaman Dari</label> <input type="number" id="halaman-hafalan-dari" min="1" max="604" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="juz-hafalan-sampai" class="block text-sm font-medium text-gray-700 mb-1">Juz Sampai</label> <input type="number" id="juz-hafalan-sampai" min="1" max="30" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="halaman-hafalan-sampai" class="block text-sm font-medium text-gray-700 mb-1">Halaman Sampai</label> <input type="number" id="halaman-hafalan-sampai" min="1" max="604" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div>
        <div id="info-jumlah-hafalan" class="bg-green-50 border border-green-300 rounded-lg p-3 hidden">
         <p class="text-sm font-medium text-green-800"><i class="fas fa-check-circle mr-1"></i> Jumlah halaman: <span id="total-halaman-hafalan" class="font-bold">0</span> halaman</p>
        </div>
        <div><label for="nilai-hafalan" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label> <select id="nilai-hafalan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Nilai --</option> <option value="A">A - Mumtaz</option> <option value="B">B - Jayyid Jiddan</option> <option value="C">C - Jayyid</option> <option value="D">D - Maqbul</option> </select>
        </div><button type="submit" id="btn-submit-hafalan" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Hafalan </button>
       </form>
      </div>
      <div id="submenu-input-tahsin" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Tahsin</h3>
       <form id="form-tahsin" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-tahsin" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-tahsin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-tahsin" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-tahsin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="kategori-tahsin" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label> <select id="kategori-tahsin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Kategori --</option> <option value="Makharijul Huruf">Makharijul Huruf</option> <option value="Tajwid">Tajwid</option> </select>
        </div>
        <div><label for="nilai-tahsin" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label> <select id="nilai-tahsin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Nilai --</option> <option value="A">A - Mumtaz</option> <option value="B">B - Jayyid Jiddan</option> <option value="C">C - Jayyid</option> <option value="D">D - Maqbul</option> </select>
        </div><button type="submit" id="btn-submit-tahsin" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Tahsin </button>
       </form>
      </div>
      <div id="submenu-input-murajaah" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Murajaah</h3>
       <form id="form-murajaah" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-murajaah" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-murajaah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-murajaah" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-murajaah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="bg-blue-50 border border-blue-300 rounded-lg p-3 mb-2">
         <p class="text-sm text-blue-800 font-medium mb-1">ðŸ”„ Range Murajaah (Dari - Sampai)</p>
         <p class="text-xs text-blue-700">Contoh: Juz 1 Hal 2 sampai Juz 3 Hal 61 = 60 halaman</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="juz-murajaah-dari" class="block text-sm font-medium text-gray-700 mb-1">Juz Dari</label> <input type="number" id="juz-murajaah-dari" min="1" max="30" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="halaman-murajaah-dari" class="block text-sm font-medium text-gray-700 mb-1">Halaman Dari</label> <input type="number" id="halaman-murajaah-dari" min="1" max="604" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="juz-murajaah-sampai" class="block text-sm font-medium text-gray-700 mb-1">Juz Sampai</label> <input type="number" id="juz-murajaah-sampai" min="1" max="30" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="halaman-murajaah-sampai" class="block text-sm font-medium text-gray-700 mb-1">Halaman Sampai</label> <input type="number" id="halaman-murajaah-sampai" min="1" max="604" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div>
        <div id="info-jumlah-murajaah" class="bg-green-50 border border-green-300 rounded-lg p-3 hidden">
         <p class="text-sm font-medium text-green-800"><i class="fas fa-check-circle mr-1"></i> Jumlah halaman: <span id="total-halaman-murajaah" class="font-bold">0</span> halaman</p>
        </div>
        <div><label for="nilai-murajaah" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label> <select id="nilai-murajaah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Nilai --</option> <option value="A">A - Mumtaz</option> <option value="B">B - Jayyid Jiddan</option> <option value="C">C - Jayyid</option> <option value="D">D - Maqbul</option> </select>
        </div><button type="submit" id="btn-submit-murajaah" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Murajaah </button>
       </form>
      </div>
      <div id="submenu-input-hadits" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Hadits</h3>
       <form id="form-hadits" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-hadits" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-hadits" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-hadits" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-hadits" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="bg-blue-50 border border-blue-300 rounded-lg p-3 mb-2">
         <p class="text-sm text-blue-800 font-medium mb-1">ðŸ“œ Range Hadits (Dari - Sampai)</p>
         <p class="text-xs text-blue-700">Contoh: Hadits 1 sampai Hadits 5 = 5 hadits</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="hadits-dari" class="block text-sm font-medium text-gray-700 mb-1">Hadits Dari</label> <input type="number" id="hadits-dari" min="1" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="hadits-sampai" class="block text-sm font-medium text-gray-700 mb-1">Hadits Sampai</label> <input type="number" id="hadits-sampai" min="1" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div>
        <div id="info-jumlah-hadits" class="bg-green-50 border border-green-300 rounded-lg p-3 hidden">
         <p class="text-sm font-medium text-green-800"><i class="fas fa-check-circle mr-1"></i> Jumlah hadits: <span id="total-hadits-input" class="font-bold">0</span> hadits</p>
        </div>
        <div><label for="nilai-hadits" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label> <select id="nilai-hadits" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Nilai --</option> <option value="A">A - Mumtaz</option> <option value="B">B - Jayyid Jiddan</option> <option value="C">C - Jayyid</option> <option value="D">D - Maqbul</option> </select>
        </div><button type="submit" id="btn-submit-hadits" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Hadits </button>
       </form>
      </div>
      <div id="submenu-mutabaah" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Mutaba'ah Yaumiyah</h3>
       <form id="form-mutabaah" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-mutabaah" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-mutabaah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-mutabaah" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-mutabaah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="space-y-2">
         <p class="font-medium text-gray-700">Aktivitas Harian:</p>
         <div class="grid grid-cols-2 gap-3"><label class="flex items-center space-x-2"> <input type="checkbox" id="check-subuh" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Shalat Subuh</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-zhuhur" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Shalat Zhuhur</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-ashar" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Shalat Ashar</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-maghrib" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Shalat Maghrib</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-isya" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Shalat Isya'</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-dhuha" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Shalat Dhuha</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-qiyam" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Qiyamul Lail</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-rawatib" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Shalat Sunnah Rawatib</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-dzikir" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Dzikir Pagi-Petang</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-puasa" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Puasa Sunnah</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-hafalan-hadits" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Hafalan Hadits</span> </label>
         </div>
        </div>
        <div class="bg-indigo-50 p-3 rounded-lg">
         <p class="text-sm text-gray-700"><i class="fas fa-info-circle text-indigo-600 mr-2"></i> Nilai akan dihitung otomatis: 9-11 = A, 6-8 = B, 3-5 = C, 0-2 = D</p>
        </div><button type="submit" id="btn-submit-mutabaah" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Mutaba'ah </button>
       </form>
      </div>
      <div id="submenu-absensi" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Absensi</h3>
       <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-absensi" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-absensi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="sesi-absensi" class="block text-sm font-medium text-gray-700 mb-1">Sesi</label> <select id="sesi-absensi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Sesi --</option> </select>
        </div><button onclick="window.loadAbsensiSantri()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-list mr-2"></i>Muat Daftar Santri </button>
       </div>
       <div id="list-absensi" class="space-y-2"></div><button onclick="window.simpanAbsensi()" id="btn-simpan-absensi" class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 hidden"> <i class="fas fa-save mr-2"></i>Simpan Absensi </button>
      </div>
      <div id="submenu-tasmi" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Tasmi'</h3>
       <form id="form-tasmi" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-tasmi" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-tasmi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-tasmi" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-tasmi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="bg-blue-50 border border-blue-300 rounded-lg p-3 mb-2">
         <p class="text-sm text-blue-800 font-medium mb-1">ðŸŽ§ Range Tasmi' (Dari - Sampai)</p>
         <p class="text-xs text-blue-700">Contoh: Juz 1 sampai Juz 5 = Tasmi' 5 Juz</p>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="juz-tasmi-dari" class="block text-sm font-medium text-gray-700 mb-1">Juz Dari</label> <input type="number" id="juz-tasmi-dari" min="1" max="30" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="juz-tasmi-sampai" class="block text-sm font-medium text-gray-700 mb-1">Juz Sampai</label> <input type="number" id="juz-tasmi-sampai" min="1" max="30" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div>
        <div id="info-jumlah-tasmi" class="bg-green-50 border border-green-300 rounded-lg p-3 hidden">
         <p class="text-sm font-medium text-green-800"><i class="fas fa-check-circle mr-1"></i> Tasmi' <span id="total-juz-tasmi" class="font-bold">0</span> Juz</p>
        </div>
        <div><label for="nilai-tasmi" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label> <select id="nilai-tasmi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Nilai --</option> <option value="A">A - Mumtaz</option> <option value="B">B - Jayyid Jiddan</option> <option value="C">C - Jayyid</option> <option value="D">D - Maqbul</option> </select>
        </div><button type="submit" id="btn-submit-tasmi" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Tasmi' </button>
       </form>
      </div>
      <div id="submenu-laporan-pekanan" class="submenu-content hidden bg-white rounded-lg shadow-lg p-4 sm:p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800 text-sm sm:text-base"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">Laporan Pekanan</h3>
       <form id="form-laporan-pekanan" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg" onsubmit="event.preventDefault(); window.tampilkanLaporanPekanan();">
        <div><label for="santri-laporan-pekanan" class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label> <select id="santri-laporan-pekanan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
         <div><label for="tanggal-mulai-pekanan" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label> <input type="date" id="tanggal-mulai-pekanan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="tanggal-selesai-pekanan" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Selesai</label> <input type="date" id="tanggal-selesai-pekanan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div><button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-eye mr-2"></i>Tampilkan Laporan </button>
       </form>
       <div id="preview-laporan-pekanan" class="hidden">
        <div class="flex justify-end mb-4"><button onclick="window.cetakLaporanPekanan()" class="bg-green-600 text-white px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base font-medium hover:bg-green-700"> <i class="fas fa-print mr-2"></i>Cetak PDF </button>
        </div>
        <div class="table-responsive">
         <div id="content-laporan-pekanan" class="bg-white border border-gray-300 rounded-lg p-4 sm:p-6 md:p-8"></div>
        </div>
       </div>
      </div>
      <div id="submenu-laporan-bulanan" class="submenu-content hidden bg-white rounded-lg shadow-lg p-4 sm:p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800 text-sm sm:text-base"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">Laporan Bulanan</h3>
       <form id="form-laporan-bulanan" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg" onsubmit="event.preventDefault(); window.tampilkanLaporanBulanan();">
        <div><label for="santri-laporan-bulanan" class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label> <select id="santri-laporan-bulanan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
         <div><label for="bulan-laporan" class="block text-sm font-medium text-gray-700 mb-1">Bulan</label> <select id="bulan-laporan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Bulan --</option> <option value="1">Januari</option> <option value="2">Februari</option> <option value="3">Maret</option> <option value="4">April</option> <option value="5">Mei</option> <option value="6">Juni</option> <option value="7">Juli</option> <option value="8">Agustus</option> <option value="9">September</option> <option value="10">Oktober</option> <option value="11">November</option> <option value="12">Desember</option> </select>
         </div>
         <div><label for="tahun-laporan" class="block text-sm font-medium text-gray-700 mb-1">Tahun</label> <input type="number" id="tahun-laporan" min="2000" max="2100" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div><button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-eye mr-2"></i>Tampilkan Laporan </button>
       </form>
       <div id="preview-laporan-bulanan" class="hidden">
        <div class="flex justify-end mb-4"><button onclick="window.cetakLaporanBulanan()" class="bg-green-600 text-white px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base font-medium hover:bg-green-700"> <i class="fas fa-print mr-2"></i>Cetak PDF </button>
        </div>
        <div class="table-responsive">
         <div id="content-laporan-bulanan" class="bg-white border border-gray-300 rounded-lg p-4 sm:p-6 md:p-8"></div>
        </div>
       </div>
      </div>
      <div id="submenu-rapor-semester" class="submenu-content hidden bg-white rounded-lg shadow-lg p-4 sm:p-6"><button onclick="window.hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800 text-sm sm:text-base"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-lg sm:text-xl font-bold text-gray-800 mb-4">Rapor Semester</h3>
       <form id="form-rapor-semester" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg" onsubmit="event.preventDefault(); window.tampilkanRaporSemester();">
        <div><label for="santri-rapor" class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label> <select id="santri-rapor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
         <div><label for="semester-rapor" class="block text-sm font-medium text-gray-700 mb-1">Semester</label> <select id="semester-rapor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Semester --</option> <option value="1">Semester 1</option> <option value="2">Semester 2</option> </select>
         </div>
         <div><label for="tahun-ajaran-rapor" class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label> <select id="tahun-ajaran-rapor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Tahun Ajaran --</option> </select>
         </div>
        </div><button type="submit" class="w-full sm:w-auto bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-eye mr-2"></i>Tampilkan Rapor </button>
       </form>
       <div id="preview-rapor-semester" class="hidden">
        <div class="flex justify-end mb-4"><button onclick="window.cetakRaporSemester()" class="bg-green-600 text-white px-4 sm:px-6 py-2 rounded-lg text-sm sm:text-base font-medium hover:bg-green-700"> <i class="fas fa-print mr-2"></i>Cetak PDF </button>
        </div>
        <div class="table-responsive">
         <div id="content-rapor-semester" class="bg-white border border-gray-300 rounded-lg p-4 sm:p-6 md:p-8"></div>
        </div>
       </div>
      </div>
     </div>
    </div><!-- Kelola Sesi Page -->
    <div id="page-kelola-sesi" class="page-content hidden">
     <div class="bg-white border border-gray-300 rounded-lg p-4 mb-4">
      <h3 class="text-base font-bold text-gray-800 mb-3">Tambah Sesi</h3>
      <form id="form-sesi" class="space-y-3">
       <div><label for="nama-sesi" class="block text-sm font-medium text-gray-700 mb-1">Nama Sesi</label> <input type="text" id="nama-sesi" required class="w-full px-3 py-2 text-sm border border-gray-300 focus:border-gray-800 focus:outline-none">
       </div>
       <div class="grid grid-cols-2 gap-3">
        <div><label for="jam-mulai" class="block text-sm font-medium text-gray-700 mb-1">Jam Mulai</label> <input type="time" id="jam-mulai" required class="w-full px-3 py-2 text-sm border border-gray-300 focus:border-gray-800 focus:outline-none">
        </div>
        <div><label for="jam-selesai" class="block text-sm font-medium text-gray-700 mb-1">Jam Selesai</label> <input type="time" id="jam-selesai" required class="w-full px-3 py-2 text-sm border border-gray-300 focus:border-gray-800 focus:outline-none">
        </div>
       </div><button type="submit" id="btn-submit-sesi" class="bg-gray-800 text-white px-4 py-2 text-sm font-medium hover:bg-black transition"> Simpan Sesi </button>
      </form>
     </div>
     <div class="bg-white border border-gray-300 rounded-lg p-4">
      <h3 class="text-base font-bold text-gray-800 mb-3">Daftar Sesi</h3>
      <div id="list-sesi" class="space-y-2"></div>
     </div>
    </div>
   </div><!-- Footer -->
   <footer class="bg-white text-gray-800 py-4 text-center">
    <p class="text-sm">Â© <span id="current-year"></span> Sistem Monitoring & Manajemen Tahfidz Santri</p>
    <p class="text-xs mt-1">Created by <span class="font-bold">Muzanni</span></p>
   </footer>
  </div>
  <script type="module">
    let pembimbingData = [];
    let santriData = [];
    let tahunAjaranData = [];
    let sesiData = [];
    let currentPembimbingId = null;
    
    let currentLaporanData = null;
    
    const defaultConfig = {
      app_title: 'Sistem Monitoring Hafalan Santri',
      madrasah_name: "Ma'had Abu Bakar Ash-Shiddiq Anabanua"
    };

    async function onConfigChange(config) {
      document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('madrasah-name').textContent = config.madrasah_name || defaultConfig.madrasah_name;
    }

    async function init() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title],
            ['madrasah_name', config.madrasah_name || defaultConfig.madrasah_name]
          ])
        });
      }
      
      // Set current year in footer
      document.getElementById('current-year').textContent = new Date().getFullYear();
      
      setTodayDates();
      await loadAllData();
    }

    async function loadAllData() {
      try {
        const pembimbingSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'pembimbing'));
        pembimbingData = pembimbingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const santriSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'santri'));
        santriData = santriSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const tahunSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahun_ajaran'));
        tahunAjaranData = tahunSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const sesiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'sesi'));
        sesiData = sesiSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        updateDashboard();
        updatePembimbingList();
        updatePembimbingCards();
        updateTahunAjaranList();
        updateSesiList();
        updateSesiDropdown();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function setTodayDates() {
      const today = new Date().toISOString().split('T')[0];
      const dateInputs = ['tanggal-hafalan', 'tanggal-tahsin', 'tanggal-murajaah', 'tanggal-hadits', 'tanggal-mutabaah', 'tanggal-absensi', 'tanggal-tasmi'];
      dateInputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = today;
      });
      
      const tahunLaporan = document.getElementById('tahun-laporan');
      if (tahunLaporan) tahunLaporan.value = new Date().getFullYear();
      
      // Add event listeners for automatic calculation
      // Hafalan range calculation
      ['juz-hafalan-dari', 'halaman-hafalan-dari', 'juz-hafalan-sampai', 'halaman-hafalan-sampai'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', () => {
            const juzDari = parseInt(document.getElementById('juz-hafalan-dari').value) || 0;
            const halDari = parseInt(document.getElementById('halaman-hafalan-dari').value) || 0;
            const juzSampai = parseInt(document.getElementById('juz-hafalan-sampai').value) || 0;
            const halSampai = parseInt(document.getElementById('halaman-hafalan-sampai').value) || 0;
            
            if (juzDari && halDari && juzSampai && halSampai) {
              const totalHalaman = (halSampai - halDari) + 1;
              if (totalHalaman > 0) {
                document.getElementById('total-halaman-hafalan').textContent = totalHalaman;
                document.getElementById('info-jumlah-hafalan').classList.remove('hidden');
              }
            }
          });
        }
      });
      
      // Murajaah range calculation
      ['juz-murajaah-dari', 'halaman-murajaah-dari', 'juz-murajaah-sampai', 'halaman-murajaah-sampai'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', () => {
            const juzDari = parseInt(document.getElementById('juz-murajaah-dari').value) || 0;
            const halDari = parseInt(document.getElementById('halaman-murajaah-dari').value) || 0;
            const juzSampai = parseInt(document.getElementById('juz-murajaah-sampai').value) || 0;
            const halSampai = parseInt(document.getElementById('halaman-murajaah-sampai').value) || 0;
            
            if (juzDari && halDari && juzSampai && halSampai) {
              const totalHalaman = (halSampai - halDari) + 1;
              if (totalHalaman > 0) {
                document.getElementById('total-halaman-murajaah').textContent = totalHalaman;
                document.getElementById('info-jumlah-murajaah').classList.remove('hidden');
              }
            }
          });
        }
      });
      
      // Hadits range calculation
      ['hadits-dari', 'hadits-sampai'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', () => {
            const haditsDari = parseInt(document.getElementById('hadits-dari').value) || 0;
            const haditsSampai = parseInt(document.getElementById('hadits-sampai').value) || 0;
            
            if (haditsDari && haditsSampai && haditsSampai >= haditsDari) {
              const totalHadits = (haditsSampai - haditsDari) + 1;
              document.getElementById('total-hadits-input').textContent = totalHadits;
              document.getElementById('info-jumlah-hadits').classList.remove('hidden');
            }
          });
        }
      });
      
      // Tasmi range calculation
      ['juz-tasmi-dari', 'juz-tasmi-sampai'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('input', () => {
            const juzDari = parseInt(document.getElementById('juz-tasmi-dari').value) || 0;
            const juzSampai = parseInt(document.getElementById('juz-tasmi-sampai').value) || 0;
            
            if (juzDari && juzSampai && juzSampai >= juzDari) {
              const totalJuz = (juzSampai - juzDari) + 1;
              document.getElementById('total-juz-tasmi').textContent = totalJuz;
              document.getElementById('info-jumlah-tasmi').classList.remove('hidden');
            }
          });
        }
      });
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    window.showPage = function(pageName, event) {
      document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
      document.getElementById(`page-${pageName}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-gray-800', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      if (event && event.target) {
        const btn = event.target.closest('.nav-btn');
        if (btn) {
          btn.classList.remove('bg-gray-200', 'text-gray-700');
          btn.classList.add('bg-gray-800', 'text-white');
        }
      }
      
      hideSubMenu();
    };

    window.showSubMenu = function(menuName) {
      document.querySelectorAll('.submenu-content').forEach(m => m.classList.add('hidden'));
      document.getElementById(`submenu-${menuName}`).classList.remove('hidden');
      
      if (menuName === 'kelola-santri') {
        updateSantriList();
      }
    };

    window.hideSubMenu = function() {
      document.querySelectorAll('.submenu-content').forEach(m => m.classList.add('hidden'));
    };

    function updateDashboard() {
      document.getElementById('total-pembimbing').textContent = pembimbingData.length;
      document.getElementById('total-santri').textContent = santriData.length;
      
      if (santriData.length > 0) {
        const totalJuz = santriData.reduce((sum, s) => sum + (s.total_hafalan_juz || 0), 0);
        const avgJuz = (totalJuz / santriData.length).toFixed(1);
        document.getElementById('avg-hafalan').textContent = `${avgJuz} Juz`;
      } else {
        document.getElementById('avg-hafalan').textContent = '0 Juz';
      }
    }

    function updatePembimbingList() {
      const container = document.getElementById('list-pembimbing');
      
      if (pembimbingData.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-3 text-sm">Belum ada data pembimbing</p>';
        return;
      }
      
      container.innerHTML = pembimbingData.map(p => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded border border-gray-200">
          <div>
            <p class="font-medium text-gray-800 text-sm">${p.nama_pembimbing}</p>
            <p class="text-xs text-gray-600">Halaqah: ${p.nama_halaqah}</p>
          </div>
          <div class="flex space-x-1">
            <button onclick="window.editPembimbing('${p.id}')" class="text-gray-700 hover:text-gray-900 px-2 py-1 rounded hover:bg-gray-200 transition">
              <i class="fas fa-edit text-sm"></i>
            </button>
            <button onclick="window.deletePembimbing('${p.id}')" class="text-red-600 hover:text-red-800 px-2 py-1 rounded hover:bg-red-50 transition">
              <i class="fas fa-trash text-sm"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function updatePembimbingCards() {
      const container = document.getElementById('pembimbing-cards');
      
      if (pembimbingData.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4 col-span-3 text-sm">Belum ada data pembimbing. Silakan tambahkan pembimbing terlebih dahulu.</p>';
        return;
      }
      
      container.innerHTML = pembimbingData.map(p => `
        <div onclick="window.selectPembimbing('${p.id}')" class="pembimbing-card bg-white border border-gray-300 p-3 cursor-pointer hover:bg-gray-50" data-pembimbing-id="${p.id}">
          <p class="font-bold text-gray-800 text-sm">${p.nama_pembimbing}</p>
          <p class="text-xs text-gray-600">Halaqah: ${p.nama_halaqah}</p>
        </div>
      `).join('');
    }

    window.selectPembimbing = function(pembimbingId) {
      currentPembimbingId = pembimbingId;
      
      document.querySelectorAll('.pembimbing-card').forEach(card => {
        card.classList.remove('active');
      });
      
      const selectedCard = document.querySelector(`[data-pembimbing-id="${pembimbingId}"]`);
      if (selectedCard) {
        selectedCard.classList.add('active');
      }
      
      document.getElementById('pembimbing-menu').classList.remove('hidden');
      updateSantriDropdowns();
    };

    function updateTahunAjaranList() {
      const select = document.getElementById('filter-tahun-ajaran');
      const selectRapor = document.getElementById('tahun-ajaran-rapor');
      
      const options = '<option value="">-- Semua Tahun Ajaran --</option>' + 
        tahunAjaranData.map(t => `<option value="${t.tahun_ajaran}">${t.tahun_ajaran}</option>`).join('');
      
      const optionsRapor = '<option value="">-- Pilih Tahun Ajaran --</option>' + 
        tahunAjaranData.map(t => `<option value="${t.tahun_ajaran}">${t.tahun_ajaran}</option>`).join('');
      
      if (select) select.innerHTML = options;
      if (selectRapor) selectRapor.innerHTML = optionsRapor;
    }

    function updateSantriList() {
      const container = document.getElementById('list-santri');
      const santri = santriData.filter(s => s.id_pembimbing === currentPembimbingId);
      
      if (santri.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data santri untuk pembimbing ini</p>';
        return;
      }
      
      container.innerHTML = santri.map(s => `
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1">
              <p class="font-medium text-gray-800">${s.nama_santri}</p>
              <p class="text-sm text-gray-600">NIS: ${s.nis} | Kelas: ${s.kelas}</p>
            </div>
            <button onclick="window.deleteSantri('${s.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 rounded-lg hover:bg-red-50">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <p class="text-gray-600">Wali: ${s.nama_wali}</p>
            <p class="text-gray-600">Hafalan: ${s.total_hafalan_juz} Juz ${s.total_hafalan_halaman} Hal</p>
            <p class="text-gray-600">Hadits: ${s.total_hadits}</p>
          </div>
        </div>
      `).join('');
    }

    function updateSantriDropdowns() {
      if (!currentPembimbingId) return;
      
      const santri = santriData.filter(s => s.id_pembimbing === currentPembimbingId);
      const options = '<option value="">-- Pilih Santri --</option>' + 
        santri.map(s => `<option value="${s.id}">${s.nama_santri}</option>`).join('');
      
      const dropdowns = ['santri-hafalan', 'santri-tahsin', 'santri-murajaah', 'santri-hadits', 'santri-mutabaah', 'santri-tasmi', 'santri-laporan-pekanan', 'santri-laporan-bulanan', 'santri-rapor'];
      dropdowns.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = options;
      });
    }

    function updateSesiList() {
      const container = document.getElementById('list-sesi');
      
      if (sesiData.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data sesi</p>';
        return;
      }
      
      container.innerHTML = sesiData.map(s => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div>
            <p class="font-medium text-gray-800">${s.nama_sesi}</p>
            <p class="text-sm text-gray-600">${s.jam_mulai} - ${s.jam_selesai}</p>
          </div>
          <button onclick="window.deleteSesi('${s.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 rounded-lg hover:bg-red-50">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');
    }

    function updateSesiDropdown() {
      const select = document.getElementById('sesi-absensi');
      
      select.innerHTML = '<option value="">-- Pilih Sesi --</option>' + 
        sesiData.map(s => `<option value="${s.nama_sesi}">${s.nama_sesi} (${s.jam_mulai} - ${s.jam_selesai})</option>`).join('');
    }

    document.getElementById('form-pembimbing').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-pembimbing');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'pembimbing'), {
          nama_pembimbing: document.getElementById('nama-pembimbing').value,
          nama_halaqah: document.getElementById('nama-halaqah').value
        });
        
        showToast('Pembimbing berhasil ditambahkan');
        e.target.reset();
        await loadAllData();
      } catch (error) {
        showToast('Gagal menambahkan pembimbing', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    window.editPembimbing = function(id) {
      const pembimbing = pembimbingData.find(p => p.id === id);
      if (!pembimbing) return;
      
      document.getElementById('edit-pembimbing-id').value = id;
      document.getElementById('edit-nama-pembimbing').value = pembimbing.nama_pembimbing;
      document.getElementById('edit-nama-halaqah').value = pembimbing.nama_halaqah;
      document.getElementById('edit-modal').classList.remove('hidden');
    };

    window.closeEditModal = function() {
      document.getElementById('edit-modal').classList.add('hidden');
      document.getElementById('form-edit-pembimbing').reset();
    };

    document.getElementById('form-edit-pembimbing').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-update-pembimbing');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        const id = document.getElementById('edit-pembimbing-id').value;
        const docRef = window.firestore.doc(window.db, 'pembimbing', id);
        
        await window.firestore.updateDoc(docRef, {
          nama_pembimbing: document.getElementById('edit-nama-pembimbing').value,
          nama_halaqah: document.getElementById('edit-nama-halaqah').value
        });
        
        showToast('Pembimbing berhasil diupdate');
        closeEditModal();
        await loadAllData();
      } catch (error) {
        showToast('Gagal mengupdate pembimbing', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    window.deletePembimbing = async function(id) {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-4">
          <p class="text-gray-800 mb-4">Yakin ingin menghapus pembimbing ini?</p>
          <div class="flex space-x-2">
            <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
            <button id="confirm-delete" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Hapus</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirm-delete').addEventListener('click', async () => {
        try {
          await window.firestore.deleteDoc(window.firestore.doc(window.db, 'pembimbing', id));
          showToast('Pembimbing berhasil dihapus');
          await loadAllData();
        } catch (error) {
          showToast('Gagal menghapus pembimbing', 'error');
        }
        confirmDiv.remove();
      });
    };

    document.getElementById('form-santri').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentPembimbingId) {
        showToast('Pilih pembimbing terlebih dahulu', 'error');
        return;
      }
      
      const btn = document.getElementById('btn-submit-santri');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'santri'), {
          id_pembimbing: currentPembimbingId,
          nis: document.getElementById('nis').value,
          nama_santri: document.getElementById('nama-santri').value,
          kelas: document.getElementById('kelas').value,
          nama_wali: document.getElementById('nama-wali').value,
          total_hafalan_juz: parseInt(document.getElementById('hafalan-juz').value),
          total_hafalan_halaman: parseInt(document.getElementById('hafalan-halaman').value),
          total_hadits: parseInt(document.getElementById('total-hadits').value)
        });
        
        showToast('Santri berhasil ditambahkan');
        e.target.reset();
        await loadAllData();
        updateSantriList();
      } catch (error) {
        showToast('Gagal menambahkan santri', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    window.deleteSantri = async function(id) {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-4">
          <p class="text-gray-800 mb-4">Yakin ingin menghapus santri ini?</p>
          <div class="flex space-x-2">
            <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
            <button id="confirm-delete-santri" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Hapus</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirm-delete-santri').addEventListener('click', async () => {
        try {
          await window.firestore.deleteDoc(window.firestore.doc(window.db, 'santri', id));
          showToast('Santri berhasil dihapus');
          await loadAllData();
          updateSantriList();
        } catch (error) {
          showToast('Gagal menghapus santri', 'error');
        }
        confirmDiv.remove();
      });
    };

    document.getElementById('form-tahun-ajaran').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-tahun');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'tahun_ajaran'), {
          tahun_ajaran: document.getElementById('tahun-ajaran').value
        });
        
        showToast('Tahun ajaran berhasil ditambahkan');
        e.target.reset();
        await loadAllData();
      } catch (error) {
        showToast('Gagal menambahkan tahun ajaran', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-hafalan-baru').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-hafalan');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        const idSantri = document.getElementById('santri-hafalan').value;
        const juzDari = parseInt(document.getElementById('juz-hafalan-dari').value);
        const halDari = parseInt(document.getElementById('halaman-hafalan-dari').value);
        const juzSampai = parseInt(document.getElementById('juz-hafalan-sampai').value);
        const halSampai = parseInt(document.getElementById('halaman-hafalan-sampai').value);
        
        // Hitung jumlah halaman
        const jumlahHalaman = (halSampai - halDari) + 1;
        
        if (jumlahHalaman <= 0) {
          showToast('Range halaman tidak valid', 'error');
          btn.classList.remove('btn-loading');
          btn.disabled = false;
          return;
        }
        
        // Simpan hafalan baru dengan range
        await window.firestore.addDoc(window.firestore.collection(window.db, 'hafalan_baru'), {
          id_pembimbing: currentPembimbingId,
          id_santri: idSantri,
          tanggal: document.getElementById('tanggal-hafalan').value,
          juz_dari: juzDari,
          halaman_dari: halDari,
          juz_sampai: juzSampai,
          halaman_sampai: halSampai,
          jumlah_halaman: jumlahHalaman,
          nilai: document.getElementById('nilai-hafalan').value
        });
        
        // Update total hafalan santri (tambah jumlah halaman yang diinput)
        const santri = santriData.find(s => s.id === idSantri);
        if (santri) {
          let totalJuz = santri.total_hafalan_juz || 0;
          let totalHalaman = santri.total_hafalan_halaman || 0;
          
          // Tambah jumlah halaman
          totalHalaman += jumlahHalaman;
          
          // Jika halaman mencapai 20 (1 juz = 20 halaman), tambah juz dan reset halaman
          if (totalHalaman >= 20) {
            totalJuz += Math.floor(totalHalaman / 20);
            totalHalaman = totalHalaman % 20;
          }
          
          // Update di Firestore
          const santriRef = window.firestore.doc(window.db, 'santri', idSantri);
          await window.firestore.updateDoc(santriRef, {
            total_hafalan_juz: totalJuz,
            total_hafalan_halaman: totalHalaman
          });
          
          // Reload data
          await loadAllData();
        }
        
        showToast(`Hafalan berhasil disimpan (${jumlahHalaman} halaman) dan total hafalan diperbarui`);
        e.target.reset();
        document.getElementById('info-jumlah-hafalan').classList.add('hidden');
        setTodayDates();
      } catch (error) {
        showToast('Gagal menyimpan hafalan', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-tahsin').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-tahsin');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'tahsin'), {
          id_pembimbing: currentPembimbingId,
          id_santri: document.getElementById('santri-tahsin').value,
          tanggal: document.getElementById('tanggal-tahsin').value,
          kategori: document.getElementById('kategori-tahsin').value,
          nilai: document.getElementById('nilai-tahsin').value
        });
        
        showToast('Tahsin berhasil disimpan');
        e.target.reset();
        setTodayDates();
      } catch (error) {
        showToast('Gagal menyimpan tahsin', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-murajaah').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-murajaah');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        const juzDari = parseInt(document.getElementById('juz-murajaah-dari').value);
        const halDari = parseInt(document.getElementById('halaman-murajaah-dari').value);
        const juzSampai = parseInt(document.getElementById('juz-murajaah-sampai').value);
        const halSampai = parseInt(document.getElementById('halaman-murajaah-sampai').value);
        
        // Hitung jumlah halaman
        const jumlahHalaman = (halSampai - halDari) + 1;
        
        if (jumlahHalaman <= 0) {
          showToast('Range halaman tidak valid', 'error');
          btn.classList.remove('btn-loading');
          btn.disabled = false;
          return;
        }
        
        await window.firestore.addDoc(window.firestore.collection(window.db, 'murajaah'), {
          id_pembimbing: currentPembimbingId,
          id_santri: document.getElementById('santri-murajaah').value,
          tanggal: document.getElementById('tanggal-murajaah').value,
          juz_dari: juzDari,
          halaman_dari: halDari,
          juz_sampai: juzSampai,
          halaman_sampai: halSampai,
          jumlah_halaman: jumlahHalaman,
          nilai: document.getElementById('nilai-murajaah').value
        });
        
        showToast(`Murajaah berhasil disimpan (${jumlahHalaman} halaman)`);
        e.target.reset();
        document.getElementById('info-jumlah-murajaah').classList.add('hidden');
        setTodayDates();
      } catch (error) {
        showToast('Gagal menyimpan murajaah', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-hadits').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-hadits');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        const idSantri = document.getElementById('santri-hadits').value;
        const haditsDari = parseInt(document.getElementById('hadits-dari').value);
        const haditsSampai = parseInt(document.getElementById('hadits-sampai').value);
        
        // Hitung jumlah hadits
        const jumlahHadits = (haditsSampai - haditsDari) + 1;
        
        if (jumlahHadits <= 0) {
          showToast('Range hadits tidak valid', 'error');
          btn.classList.remove('btn-loading');
          btn.disabled = false;
          return;
        }
        
        // Simpan data hadits dengan range
        await window.firestore.addDoc(window.firestore.collection(window.db, 'hadits'), {
          id_pembimbing: currentPembimbingId,
          id_santri: idSantri,
          tanggal: document.getElementById('tanggal-hadits').value,
          hadits_dari: haditsDari,
          hadits_sampai: haditsSampai,
          jumlah_hadits: jumlahHadits,
          nilai: document.getElementById('nilai-hadits').value
        });
        
        // Update total hadits santri (tambah jumlah hadits yang diinput)
        const santri = santriData.find(s => s.id === idSantri);
        if (santri) {
          let totalHadits = (santri.total_hadits || 0) + jumlahHadits;
          
          // Update di Firestore
          const santriRef = window.firestore.doc(window.db, 'santri', idSantri);
          await window.firestore.updateDoc(santriRef, {
            total_hadits: totalHadits
          });
          
          // Reload data
          await loadAllData();
        }
        
        showToast(`Hadits berhasil disimpan (${jumlahHadits} hadits) dan total hadits diperbarui`);
        e.target.reset();
        document.getElementById('info-jumlah-hadits').classList.add('hidden');
        setTodayDates();
      } catch (error) {
        showToast('Gagal menyimpan hadits', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-mutabaah').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const checkCount = ['check-subuh', 'check-zhuhur', 'check-ashar', 'check-maghrib', 'check-isya', 'check-dhuha', 'check-qiyam', 'check-rawatib', 'check-dzikir', 'check-puasa', 'check-hafalan-hadits']
        .filter(id => document.getElementById(id).checked).length;
      
      let nilai = 'D';
      if (checkCount >= 9) nilai = 'A';
      else if (checkCount >= 6) nilai = 'B';
      else if (checkCount >= 3) nilai = 'C';
      
      const btn = document.getElementById('btn-submit-mutabaah');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'mutabaah'), {
          id_pembimbing: currentPembimbingId,
          id_santri: document.getElementById('santri-mutabaah').value,
          tanggal: document.getElementById('tanggal-mutabaah').value,
          shalat_subuh: document.getElementById('check-subuh').checked,
          shalat_zhuhur: document.getElementById('check-zhuhur').checked,
          shalat_ashar: document.getElementById('check-ashar').checked,
          shalat_maghrib: document.getElementById('check-maghrib').checked,
          shalat_isya: document.getElementById('check-isya').checked,
          shalat_dhuha: document.getElementById('check-dhuha').checked,
          qiyamul_lail: document.getElementById('check-qiyam').checked,
          rawatib: document.getElementById('check-rawatib').checked,
          dzikir: document.getElementById('check-dzikir').checked,
          puasa_sunnah: document.getElementById('check-puasa').checked,
          hafalan_hadits: document.getElementById('check-hafalan-hadits').checked,
          nilai: nilai
        });
        
        showToast(`Mutaba'ah berhasil disimpan dengan nilai ${nilai}`);
        e.target.reset();
        setTodayDates();
      } catch (error) {
        showToast("Gagal menyimpan mutaba'ah", 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    window.loadAbsensiSantri = function() {
      const tanggal = document.getElementById('tanggal-absensi').value;
      const sesi = document.getElementById('sesi-absensi').value;
      
      if (!tanggal || !sesi) {
        showToast('Pilih tanggal dan sesi terlebih dahulu', 'error');
        return;
      }
      
      const santri = santriData.filter(s => s.id_pembimbing === currentPembimbingId);
      const container = document.getElementById('list-absensi');
      
      if (santri.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada santri</p>';
        return;
      }
      
      container.innerHTML = santri.map(s => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-800">${s.nama_santri}</span>
          <div class="flex space-x-2">
            <label class="flex items-center space-x-1">
              <input type="radio" name="absensi_${s.id}" value="H" class="text-green-600 focus:ring-green-500">
              <span class="text-sm text-green-600">H</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="radio" name="absensi_${s.id}" value="I" class="text-blue-600 focus:ring-blue-500">
              <span class="text-sm text-blue-600">I</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="radio" name="absensi_${s.id}" value="S" class="text-yellow-600 focus:ring-yellow-500">
              <span class="text-sm text-yellow-600">S</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="radio" name="absensi_${s.id}" value="A" class="text-red-600 focus:ring-red-500">
              <span class="text-sm text-red-600">A</span>
            </label>
          </div>
        </div>
      `).join('');
      
      document.getElementById('btn-simpan-absensi').classList.remove('hidden');
    };

    window.simpanAbsensi = async function() {
      const tanggal = document.getElementById('tanggal-absensi').value;
      const sesi = document.getElementById('sesi-absensi').value;
      const santri = santriData.filter(s => s.id_pembimbing === currentPembimbingId);
      
      const btn = document.getElementById('btn-simpan-absensi');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        for (const s of santri) {
          const radio = document.querySelector(`input[name="absensi_${s.id}"]:checked`);
          if (radio) {
            await window.firestore.addDoc(window.firestore.collection(window.db, 'absensi'), {
              id_pembimbing: currentPembimbingId,
              id_santri: s.id,
              tanggal: tanggal,
              sesi: sesi,
              status: radio.value
            });
          }
        }
        
        showToast('Absensi berhasil disimpan');
        document.getElementById('list-absensi').innerHTML = '';
        document.getElementById('btn-simpan-absensi').classList.add('hidden');
      } catch (error) {
        showToast('Gagal menyimpan absensi', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    };

    document.getElementById('form-tasmi').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-tasmi');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        const juzDari = parseInt(document.getElementById('juz-tasmi-dari').value);
        const juzSampai = parseInt(document.getElementById('juz-tasmi-sampai').value);
        
        // Hitung jumlah juz
        const jumlahJuz = (juzSampai - juzDari) + 1;
        
        if (jumlahJuz <= 0) {
          showToast('Range juz tidak valid', 'error');
          btn.classList.remove('btn-loading');
          btn.disabled = false;
          return;
        }
        
        await window.firestore.addDoc(window.firestore.collection(window.db, 'tasmi'), {
          id_pembimbing: currentPembimbingId,
          id_santri: document.getElementById('santri-tasmi').value,
          tanggal: document.getElementById('tanggal-tasmi').value,
          juz_dari: juzDari,
          juz_sampai: juzSampai,
          jumlah_juz: jumlahJuz,
          nilai: document.getElementById('nilai-tasmi').value
        });
        
        showToast(`Tasmi' berhasil disimpan (${jumlahJuz} Juz)`);
        e.target.reset();
        document.getElementById('info-jumlah-tasmi').classList.add('hidden');
        setTodayDates();
      } catch (error) {
        showToast("Gagal menyimpan tasmi'", 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-sesi').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-sesi');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'sesi'), {
          nama_sesi: document.getElementById('nama-sesi').value,
          jam_mulai: document.getElementById('jam-mulai').value,
          jam_selesai: document.getElementById('jam-selesai').value
        });
        
        showToast('Sesi berhasil ditambahkan');
        e.target.reset();
        await loadAllData();
      } catch (error) {
        showToast('Gagal menambahkan sesi', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    window.deleteSesi = async function(id) {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-4">
          <p class="text-gray-800 mb-4">Yakin ingin menghapus sesi ini?</p>
          <div class="flex space-x-2">
            <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
            <button id="confirm-delete-sesi" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Hapus</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirm-delete-sesi').addEventListener('click', async () => {
        try {
          await window.firestore.deleteDoc(window.firestore.doc(window.db, 'sesi', id));
          showToast('Sesi berhasil dihapus');
          await loadAllData();
        } catch (error) {
          showToast('Gagal menghapus sesi', 'error');
        }
        confirmDiv.remove();
      });
    };

    // Helper functions for reports
    function hitungPersentaseNilai(dataArray) {
      if (dataArray.length === 0) return { A: 0, B: 0, C: 0, D: 0, total: 0 };
      
      const counts = { A: 0, B: 0, C: 0, D: 0 };
      dataArray.forEach(item => {
        if (counts.hasOwnProperty(item.nilai)) {
          counts[item.nilai]++;
        }
      });
      
      const total = dataArray.length;
      return {
        A: ((counts.A / total) * 100).toFixed(1),
        B: ((counts.B / total) * 100).toFixed(1),
        C: ((counts.C / total) * 100).toFixed(1),
        D: ((counts.D / total) * 100).toFixed(1),
        total: total
      };
    }
    
    function filterDataByDateRange(data, startDate, endDate, santriId) {
      return data.filter(item => {
        const itemDate = new Date(item.tanggal);
        const start = new Date(startDate);
        const end = new Date(endDate);
        return item.id_santri === santriId && itemDate >= start && itemDate <= end;
      });
    }

    function generateCatatanPekanan(data) {
      let catatan = [];
      
      if (data.hafalan.nilai.total > 0) {
        const persenA = parseFloat(data.hafalan.nilai.A);
        if (persenA >= 70) {
          catatan.push(`Alhamdulillah, hafalan baru sangat baik dengan ${persenA}% nilai A (Mumtaz).`);
        } else if (persenA >= 50) {
          catatan.push(`Hafalan baru cukup baik dengan ${persenA}% nilai A. Tingkatkan lagi fokus dan kualitas hafalan.`);
        } else {
          catatan.push(`Hafalan baru perlu ditingkatkan. Dari ${data.hafalan.nilai.total} kali input, hanya ${persenA}% yang mendapat nilai A. Perbanyak latihan dan muroja'ah.`);
        }
      }
      
      if (data.absensi.total > 0) {
        const persenHadir = ((data.absensi.counts.H / data.absensi.total) * 100).toFixed(1);
        if (persenHadir >= 90) {
          catatan.push(`Kehadiran sangat baik (${persenHadir}%). Pertahankan kedisiplinan ini.`);
        } else if (persenHadir >= 75) {
          catatan.push(`Kehadiran cukup baik (${persenHadir}%). Usahakan hadir lebih konsisten.`);
        } else {
          catatan.push(`Kehadiran masih kurang (${persenHadir}%). Tingkatkan kedisiplinan kehadiran agar pembelajaran lebih maksimal.`);
        }
      }
      
      catatan.push(`Terus semangat menghafal Al-Qur'an dan tingkatkan muroja'ah hafalan lama agar tidak mudah lupa.`);
      
      return catatan.join(' ');
    }

    function hitungRataRata(nilai) {
      if (nilai.total === 0) return '-';
      const nilaiAngka = { A: 4, B: 3, C: 2, D: 1 };
      const totalNilai = (parseFloat(nilai.A) * nilaiAngka.A + 
                        parseFloat(nilai.B) * nilaiAngka.B + 
                        parseFloat(nilai.C) * nilaiAngka.C + 
                        parseFloat(nilai.D) * nilaiAngka.D) / 100;
      
      if (totalNilai >= 3.5) return 'A';
      if (totalNilai >= 2.5) return 'B';
      if (totalNilai >= 1.5) return 'C';
      return 'D';
    }

    function generateCatatanBulanan(data) {
      let catatan = [];
      
      const nilaiAngka = { A: 4, B: 3, C: 2, D: 1 };
      let totalNilai = 0;
      let countKategori = 0;
      
      const kategoriList = [data.hafalan, data.tahsin, data.murajaah, data.hadits, data.mutabaah, data.tasmi];
      kategoriList.forEach(kategori => {
        if (kategori.rata !== '-') {
          totalNilai += nilaiAngka[kategori.rata] || 0;
          countKategori++;
        }
      });
      
      const rataRata = countKategori > 0 ? totalNilai / countKategori : 0;
      
      if (rataRata >= 3.5) {
        catatan.push(`Alhamdulillah, prestasi ${data.santri.nama_santri} pada bulan ${data.bulan} ${data.tahun} sangat memuaskan dengan rata-rata nilai Mumtaz (A).`);
      } else if (rataRata >= 2.5) {
        catatan.push(`Prestasi ${data.santri.nama_santri} pada bulan ${data.bulan} ${data.tahun} cukup baik dengan rata-rata nilai Jayyid Jiddan (B). Tingkatkan lagi untuk mencapai nilai Mumtaz.`);
      } else {
        catatan.push(`Prestasi ${data.santri.nama_santri} pada bulan ${data.bulan} ${data.tahun} perlu ditingkatkan. Perbanyak latihan dan fokus dalam menghafal.`);
      }
      
      const tambahanHafalan = data.hafalanTotal.juz - data.hafalanAwal.juz + (data.hafalanTotal.halaman - data.hafalanAwal.halaman) / 20;
      if (tambahanHafalan > 0) {
        catatan.push(`Progress hafalan bulan ini mencapai ${tambahanHafalan.toFixed(1)} juz. Alhamdulillah, tetap istiqomah.`);
      }
      
      if (data.absensi.total > 0) {
        const persenHadir = ((data.absensi.counts.H / data.absensi.total) * 100).toFixed(1);
        if (persenHadir >= 90) {
          catatan.push(`Kedisiplinan kehadiran sangat baik (${persenHadir}%).`);
        } else if (persenHadir < 75) {
          catatan.push(`Kedisiplinan kehadiran perlu ditingkatkan (${persenHadir}%). Kehadiran yang konsisten sangat penting untuk kemajuan hafalan.`);
        }
      }
      
      catatan.push(`Untuk bulan depan, tingkatkan kualitas hafalan dengan lebih banyak muroja'ah dan jaga konsistensi dalam mengikuti halaqah tahfidz.`);
      
      return catatan.join(' ');
    }

    function generateCatatanRapor(data) {
      let catatan = [];
      
      const rataAngka = parseFloat(data.rataRata.angka);
      if (rataAngka >= 3.5) {
        catatan.push(`Alhamdulillah, ${data.santri.nama_santri} menunjukkan prestasi yang sangat memuaskan pada semester ${data.semester} tahun ajaran ${data.tahunAjaran} dengan nilai rata-rata ${rataAngka.toFixed(2)} (${data.rataRata.huruf} - Mumtaz).`);
      } else if (rataAngka >= 2.5) {
        catatan.push(`${data.santri.nama_santri} menunjukkan prestasi yang baik pada semester ${data.semester} tahun ajaran ${data.tahunAjaran} dengan nilai rata-rata ${rataAngka.toFixed(2)} (${data.rataRata.huruf} - Jayyid Jiddan). Tingkatkan lagi di semester berikutnya.`);
      } else if (rataAngka >= 1.5) {
        catatan.push(`${data.santri.nama_santri} menunjukkan prestasi cukup pada semester ${data.semester} tahun ajaran ${data.tahunAjaran} dengan nilai rata-rata ${rataAngka.toFixed(2)} (${data.rataRata.huruf} - Jayyid). Perlu peningkatan yang lebih serius.`);
      } else {
        catatan.push(`${data.santri.nama_santri} perlu meningkatkan prestasi pada semester berikutnya. Nilai rata-rata semester ini ${rataAngka.toFixed(2)} (${data.rataRata.huruf}). Perbanyak latihan dan konsistensi.`);
      }
      
      const kategoriNilai = [
        { nama: 'Hafalan Baru', nilai: data.nilai.hafalan.huruf },
        { nama: 'Tahsin', nilai: data.nilai.tahsin.huruf },
        { nama: 'Murajaah', nilai: data.nilai.murajaah.huruf },
        { nama: 'Hadits', nilai: data.nilai.hadits.huruf },
        { nama: 'Mutaba\'ah', nilai: data.nilai.mutabaah.huruf },
        { nama: 'Tasmi\'', nilai: data.nilai.tasmi.huruf }
      ].filter(k => k.nilai !== '-');
      
      const terbaik = kategoriNilai.filter(k => k.nilai === 'A');
      const terlemah = kategoriNilai.filter(k => k.nilai === 'D' || k.nilai === 'C');
      
      if (terbaik.length > 0) {
        catatan.push(`Kategori terbaik adalah ${terbaik.map(k => k.nama).join(', ')} dengan nilai A (Mumtaz).`);
      }
      
      if (terlemah.length > 0) {
        catatan.push(`Perlu peningkatan pada kategori ${terlemah.map(k => k.nama).join(', ')}.`);
      }
      
      if (data.absensi.total > 0) {
        const persenHadir = ((data.absensi.counts.H / data.absensi.total) * 100).toFixed(1);
        if (persenHadir >= 90) {
          catatan.push(`Kehadiran semester ini sangat baik (${persenHadir}%), pertahankan kedisiplinan ini.`);
        } else if (persenHadir >= 75) {
          catatan.push(`Kehadiran semester ini cukup baik (${persenHadir}%), tingkatkan lagi untuk semester depan.`);
        } else {
          catatan.push(`Kehadiran semester ini masih kurang (${persenHadir}%). Kedisiplinan kehadiran sangat penting untuk kemajuan hafalan, tingkatkan di semester berikutnya.`);
        }
      }
      
      catatan.push(`Untuk semester berikutnya, fokus pada peningkatan kualitas hafalan, perbanyak muroja'ah, dan jaga konsistensi dalam mengikuti program tahfidz. Semoga Allah memudahkan dalam menghafal Al-Qur'an.`);
      
      return catatan.join(' ');
    }

    // Implement all report functions
    window.tampilkanLaporanPekanan = async function() {
      const santriId = document.getElementById('santri-laporan-pekanan').value;
      const tanggalMulai = document.getElementById('tanggal-mulai-pekanan').value;
      const tanggalSelesai = document.getElementById('tanggal-selesai-pekanan').value;
      
      if (!santriId || !tanggalMulai || !tanggalSelesai) {
        showToast('Lengkapi semua field', 'error');
        return;
      }
      
      try {
        // Reload santri data untuk mendapatkan data terkini
        const santriSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'santri'));
        const santriDataTerkini = santriSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Load all data
        const hafalanSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'hafalan_baru'));
        const hafalanData = hafalanSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const tahsinSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahsin'));
        const tahsinData = tahsinSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const murajaahSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'murajaah'));
        const murajaahData = murajaahSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const haditsSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'hadits'));
        const haditsData = haditsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const mutabaahSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'mutabaah'));
        const mutabaahData = mutabaahSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const tasmiSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'tasmi'));
        const tasmiData = tasmiSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const absensiSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'absensi'));
        const absensiData = absensiSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Filter by date range and santri
        const hafalanFiltered = filterDataByDateRange(hafalanData, tanggalMulai, tanggalSelesai, santriId);
        const tahsinFiltered = filterDataByDateRange(tahsinData, tanggalMulai, tanggalSelesai, santriId);
        const murajaahFiltered = filterDataByDateRange(murajaahData, tanggalMulai, tanggalSelesai, santriId);
        const haditsFiltered = filterDataByDateRange(haditsData, tanggalMulai, tanggalSelesai, santriId);
        const mutabaahFiltered = filterDataByDateRange(mutabaahData, tanggalMulai, tanggalSelesai, santriId);
        const tasmiFiltered = filterDataByDateRange(tasmiData, tanggalMulai, tanggalSelesai, santriId);
        const absensiFiltered = filterDataByDateRange(absensiData, tanggalMulai, tanggalSelesai, santriId);
        
        // Calculate statistics - gunakan data terkini
        const santri = santriDataTerkini.find(s => s.id === santriId);
        const pembimbing = pembimbingData.find(p => p.id === currentPembimbingId);
        
        // Hitung hafalan di AWAL periode (sebelum input periode ini)
        const tambahanHalamanPeriode = hafalanFiltered.reduce((sum, h) => sum + (h.jumlah_halaman || 0), 0);
        const tambahanHaditsPeriode = haditsFiltered.reduce((sum, h) => sum + (h.jumlah_hadits || 0), 0);
        
        // Total hafalan SAAT INI dari database santri (sudah ter-update)
        const totalJuz = santri.total_hafalan_juz || 0;
        const totalHalaman = santri.total_hafalan_halaman || 0;
        const totalHadits = santri.total_hadits || 0;
        
        // Hitung hafalan awal periode = total sekarang - tambahan periode
        let hafalanAwalJuz = totalJuz;
        let hafalanAwalHalaman = totalHalaman - tambahanHalamanPeriode;
        
        // Jika hafalanAwalHalaman negatif, kurangi juz
        while (hafalanAwalHalaman < 0) {
          hafalanAwalJuz -= 1;
          hafalanAwalHalaman += 20;
        }
        
        const haditsAwal = totalHadits - tambahanHaditsPeriode;
        
        // Hitung jumlah input dan total juz tasmi
        const jumlahInputTasmi = tasmiFiltered.length;
        const totalJuzTasmi = tasmiFiltered.reduce((sum, t) => sum + (t.jumlah_juz || 0), 0);
        
        const laporanData = {
          santri: santri,
          pembimbing: pembimbing,
          periode: {
            mulai: new Date(tanggalMulai).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' }),
            selesai: new Date(tanggalSelesai).toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' })
          },
          hafalanAwal: {
            juz: hafalanAwalJuz >= 0 ? hafalanAwalJuz : 0,
            halaman: hafalanAwalHalaman >= 0 ? hafalanAwalHalaman : 0
          },
          hafalanTotal: {
            juz: totalJuz,
            halaman: totalHalaman
          },
          haditsAwal: haditsAwal >= 0 ? haditsAwal : 0,
          haditsTotal: totalHadits,
          hafalan: {
            jumlah: hafalanFiltered.length,
            totalHalaman: tambahanHalamanPeriode,
            nilai: hitungPersentaseNilai(hafalanFiltered)
          },
          tahsin: {
            jumlah: tahsinFiltered.length,
            nilai: hitungPersentaseNilai(tahsinFiltered)
          },
          murajaah: {
            jumlah: murajaahFiltered.length,
            totalHalaman: murajaahFiltered.reduce((sum, m) => sum + (m.jumlah_halaman || 0), 0),
            nilai: hitungPersentaseNilai(murajaahFiltered)
          },
          hadits: {
            jumlah: haditsFiltered.length,
            totalHadits: tambahanHaditsPeriode,
            nilai: hitungPersentaseNilai(haditsFiltered)
          },
          mutabaah: {
            jumlah: mutabaahFiltered.length,
            nilai: hitungPersentaseNilai(mutabaahFiltered)
          },
          tasmi: {
            jumlah: jumlahInputTasmi,
            totalJuz: totalJuzTasmi,
            nilai: hitungPersentaseNilai(tasmiFiltered)
          },
          absensi: {
            total: absensiFiltered.length,
            counts: {
              H: absensiFiltered.filter(a => a.status === 'H').length,
              I: absensiFiltered.filter(a => a.status === 'I').length,
              S: absensiFiltered.filter(a => a.status === 'S').length,
              A: absensiFiltered.filter(a => a.status === 'A').length
            }
          }
        };
        
        // Generate HTML
        const html = `
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">LAPORAN PEKANAN TAHFIDZ</h2>
            <p class="text-lg text-gray-700 mt-2">Ma'had Abu Bakar Ash-Shiddiq Anabanua</p>
            <p class="text-sm text-gray-600 mt-2">Periode: ${laporanData.periode.mulai} - ${laporanData.periode.selesai}</p>
          </div>
          
          <div class="mb-6 grid grid-cols-2 gap-4 text-sm">
            <div>
              <p><span class="font-medium">Nama Santri:</span> ${laporanData.santri.nama_santri}</p>
              <p><span class="font-medium">NIS:</span> ${laporanData.santri.nis}</p>
              <p><span class="font-medium">Kelas:</span> ${laporanData.santri.kelas}</p>
            </div>
            <div>
              <p><span class="font-medium">Pembimbing:</span> ${laporanData.pembimbing.nama_pembimbing}</p>
              <p><span class="font-medium">Halaqah:</span> ${laporanData.pembimbing.nama_halaqah}</p>
            </div>
          </div>
          
          <div class="mb-4 p-4 bg-gray-100 rounded-lg border-2 border-gray-800">
            <h3 class="font-bold text-gray-800 mb-2 text-center">Progress Hafalan Al-Qur'an & Hadits:</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-gray-600 text-center">Hafalan Awal:</p>
                <p class="text-lg font-bold text-gray-800 text-center">${laporanData.hafalanAwal.juz} Juz ${laporanData.hafalanAwal.halaman} Hal</p>
              </div>
              <div>
                <p class="text-gray-600 text-center">Total Hafalan Sekarang:</p>
                <p class="text-lg font-bold text-gray-800 text-center">${laporanData.hafalanTotal.juz} Juz ${laporanData.hafalanTotal.halaman} Hal</p>
              </div>
              <div>
                <p class="text-gray-600 text-center">Hadits Awal:</p>
                <p class="text-lg font-bold text-gray-800 text-center">${laporanData.haditsAwal} Hadits</p>
              </div>
              <div>
                <p class="text-gray-600 text-center">Total Hadits Sekarang:</p>
                <p class="text-lg font-bold text-gray-800 text-center">${laporanData.haditsTotal} Hadits</p>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-400">
              <p class="text-center text-sm text-gray-700">
                <span class="font-bold text-gray-800">Tambahan pekan ini: ${laporanData.hafalan.totalHalaman} halaman Al-Qur'an, ${laporanData.hadits.totalHadits} hadits</span>
              </p>
            </div>
          </div>
          
          <table class="w-full border-collapse border border-gray-300 text-sm mb-4">
            <thead>
              <tr class="bg-gray-200">
                <th class="border border-gray-300 px-3 py-2">Kategori</th>
                <th class="border border-gray-300 px-3 py-2">Detail</th>
                <th class="border border-gray-300 px-3 py-2">A (%)</th>
                <th class="border border-gray-300 px-3 py-2">B (%)</th>
                <th class="border border-gray-300 px-3 py-2">C (%)</th>
                <th class="border border-gray-300 px-3 py-2">D (%)</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Hafalan Baru</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hafalan.totalHalaman} hal</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hafalan.nilai.A}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hafalan.nilai.B}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hafalan.nilai.C}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hafalan.nilai.D}</td>
              </tr>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Tahsin</td>
                <td class="border border-gray-300 px-3 py-2 text-center">-</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.tahsin.nilai.A}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.tahsin.nilai.B}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.tahsin.nilai.C}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.tahsin.nilai.D}</td>
              </tr>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Murajaah</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.murajaah.totalHalaman} hal</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.murajaah.nilai.A}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.murajaah.nilai.B}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.murajaah.nilai.C}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.murajaah.nilai.D}</td>
              </tr>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Hadits</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hadits.totalHadits} hadits</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hadits.nilai.A}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hadits.nilai.B}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hadits.nilai.C}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hadits.nilai.D}</td>
              </tr>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Mutaba'ah</td>
                <td class="border border-gray-300 px-3 py-2 text-center">-</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.mutabaah.nilai.A}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.mutabaah.nilai.B}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.mutabaah.nilai.C}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.mutabaah.nilai.D}</td>
              </tr>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Tasmi'</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.tasmi.totalJuz} juz</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.tasmi.nilai.A}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.tasmi.nilai.B}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.tasmi.nilai.C}</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.tasmi.nilai.D}</td>
              </tr>
            </tbody>
          </table>
          
          <div class="mb-4">
            <h3 class="font-bold text-gray-800 mb-2">Rekap Absensi:</h3>
            <div class="grid grid-cols-4 gap-2 text-sm">
              <div class="border border-gray-300 px-3 py-2 text-center">
                <p class="font-medium">Hadir (H)</p>
                <p class="text-2xl text-gray-800">${laporanData.absensi.counts.H}</p>
              </div>
              <div class="border border-gray-300 px-3 py-2 text-center">
                <p class="font-medium">Izin (I)</p>
                <p class="text-2xl text-gray-800">${laporanData.absensi.counts.I}</p>
              </div>
              <div class="border border-gray-300 px-3 py-2 text-center">
                <p class="font-medium">Sakit (S)</p>
                <p class="text-2xl text-gray-800">${laporanData.absensi.counts.S}</p>
              </div>
              <div class="border border-gray-300 px-3 py-2 text-center">
                <p class="font-medium">Alpa (A)</p>
                <p class="text-2xl text-gray-800">${laporanData.absensi.counts.A}</p>
              </div>
            </div>
          </div>
          
          <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-bold text-gray-800 mb-2">Catatan Pembimbing:</h3>
            <p class="text-sm text-gray-700 text-justify">${generateCatatanPekanan(laporanData)}</p>
          </div>
          
          <div class="mt-8 flex justify-between text-sm">
            <div class="text-center">
              <p class="mb-16">Orang Tua/Wali</p>
              <p class="border-t border-gray-800 pt-1 inline-block px-8">${laporanData.santri.nama_wali}</p>
            </div>
            <div class="text-center">
              <p class="mb-16">Pembimbing</p>
              <p class="border-t border-gray-800 pt-1 inline-block px-8">${laporanData.pembimbing.nama_pembimbing}</p>
            </div>
          </div>
        `;
        
        currentLaporanData = { type: 'pekanan', data: laporanData, html: html };
        document.getElementById('content-laporan-pekanan').innerHTML = html;
        document.getElementById('preview-laporan-pekanan').classList.remove('hidden');
        
        showToast('Laporan berhasil ditampilkan');
      } catch (error) {
        console.error(error);
        showToast('Gagal menampilkan laporan', 'error');
      }
    };

    window.tampilkanLaporanBulanan = async function() {
      const santriId = document.getElementById('santri-laporan-bulanan').value;
      const bulan = document.getElementById('bulan-laporan').value;
      const tahun = document.getElementById('tahun-laporan').value;
      
      if (!santriId || !bulan || !tahun) {
        showToast('Lengkapi semua field', 'error');
        return;
      }
      
      try {
        // Calculate date range for the month
        const tanggalMulai = new Date(tahun, bulan - 1, 1).toISOString().split('T')[0];
        const tanggalSelesai = new Date(tahun, bulan, 0).toISOString().split('T')[0];
        
        // Reload santri data untuk mendapatkan data terkini
        const santriSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'santri'));
        const santriDataTerkini = santriSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Load all data
        const hafalanSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'hafalan_baru'));
        const hafalanData = hafalanSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const tahsinSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahsin'));
        const tahsinData = tahsinSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const murajaahSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'murajaah'));
        const murajaahData = murajaahSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const haditsSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'hadits'));
        const haditsData = haditsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const mutabaahSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'mutabaah'));
        const mutabaahData = mutabaahSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const tasmiSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'tasmi'));
        const tasmiData = tasmiSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const absensiSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'absensi'));
        const absensiData = absensiSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Filter by date range and santri
        const hafalanFiltered = filterDataByDateRange(hafalanData, tanggalMulai, tanggalSelesai, santriId);
        const tahsinFiltered = filterDataByDateRange(tahsinData, tanggalMulai, tanggalSelesai, santriId);
        const murajaahFiltered = filterDataByDateRange(murajaahData, tanggalMulai, tanggalSelesai, santriId);
        const haditsFiltered = filterDataByDateRange(haditsData, tanggalMulai, tanggalSelesai, santriId);
        const mutabaahFiltered = filterDataByDateRange(mutabaahData, tanggalMulai, tanggalSelesai, santriId);
        const tasmiFiltered = filterDataByDateRange(tasmiData, tanggalMulai, tanggalSelesai, santriId);
        const absensiFiltered = filterDataByDateRange(absensiData, tanggalMulai, tanggalSelesai, santriId);
        
        // Calculate statistics - gunakan data terkini
        const santri = santriDataTerkini.find(s => s.id === santriId);
        const pembimbing = pembimbingData.find(p => p.id === currentPembimbingId);
        
        const bulanNama = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][parseInt(bulan)];
        
        // Hitung tambahan hafalan dari input bulan ini
        const tambahanHalamanBulan = hafalanFiltered.reduce((sum, h) => sum + (h.jumlah_halaman || 0), 0);
        const tambahanHaditsBulan = haditsFiltered.reduce((sum, h) => sum + (h.jumlah_hadits || 0), 0);
        
        // Total hafalan SAAT INI dari database santri (sudah ter-update)
        const totalJuz = santri.total_hafalan_juz || 0;
        const totalHalaman = santri.total_hafalan_halaman || 0;
        const totalHadits = santri.total_hadits || 0;
        
        // Hitung hafalan awal bulan = total sekarang - tambahan bulan
        let hafalanAwalJuz = totalJuz;
        let hafalanAwalHalaman = totalHalaman - tambahanHalamanBulan;
        
        // Jika hafalanAwalHalaman negatif, kurangi juz
        while (hafalanAwalHalaman < 0) {
          hafalanAwalJuz -= 1;
          hafalanAwalHalaman += 20;
        }
        
        const haditsAwal = totalHadits - tambahanHaditsBulan;
        
        const hafalanNilai = hitungPersentaseNilai(hafalanFiltered);
        const tahsinNilai = hitungPersentaseNilai(tahsinFiltered);
        const murajaahNilai = hitungPersentaseNilai(murajaahFiltered);
        const haditsNilai = hitungPersentaseNilai(haditsFiltered);
        const mutabaahNilai = hitungPersentaseNilai(mutabaahFiltered);
        const tasmiNilai = hitungPersentaseNilai(tasmiFiltered);
        
        // Hitung jumlah juz tasmi
        const totalJuzTasmi = tasmiFiltered.reduce((sum, t) => sum + (t.jumlah_juz || 0), 0);
        
        const laporanData = {
          santri: santri,
          pembimbing: pembimbing,
          bulan: bulanNama,
          tahun: tahun,
          hafalanAwal: {
            juz: hafalanAwalJuz >= 0 ? hafalanAwalJuz : 0,
            halaman: hafalanAwalHalaman >= 0 ? hafalanAwalHalaman : 0
          },
          hafalanTotal: {
            juz: totalJuz,
            halaman: totalHalaman
          },
          haditsAwal: haditsAwal >= 0 ? haditsAwal : 0,
          haditsTotal: totalHadits,
          hafalan: {
            jumlah: hafalanFiltered.length,
            totalHalaman: tambahanHalamanBulan,
            rata: hitungRataRata(hafalanNilai)
          },
          tahsin: {
            jumlah: tahsinFiltered.length,
            rata: hitungRataRata(tahsinNilai)
          },
          murajaah: {
            jumlah: murajaahFiltered.length,
            totalHalaman: murajaahFiltered.reduce((sum, m) => sum + (m.jumlah_halaman || 0), 0),
            rata: hitungRataRata(murajaahNilai)
          },
          hadits: {
            jumlah: haditsFiltered.length,
            totalHadits: tambahanHaditsBulan,
            rata: hitungRataRata(haditsNilai)
          },
          mutabaah: {
            jumlah: mutabaahFiltered.length,
            rata: hitungRataRata(mutabaahNilai)
          },
          tasmi: {
            jumlah: tasmiFiltered.length,
            totalJuz: totalJuzTasmi,
            rata: hitungRataRata(tasmiNilai)
          },
          absensi: {
            total: absensiFiltered.length,
            counts: {
              H: absensiFiltered.filter(a => a.status === 'H').length,
              I: absensiFiltered.filter(a => a.status === 'I').length,
              S: absensiFiltered.filter(a => a.status === 'S').length,
              A: absensiFiltered.filter(a => a.status === 'A').length
            }
          }
        };
        
        // Generate HTML
        const html = `
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">LAPORAN BULANAN TAHFIDZ</h2>
            <p class="text-lg text-gray-700 mt-2">Ma'had Abu Bakar Ash-Shiddiq Anabanua</p>
            <p class="text-sm text-gray-600 mt-2">Bulan: ${laporanData.bulan} ${laporanData.tahun}</p>
          </div>
          
          <div class="mb-6 grid grid-cols-2 gap-4 text-sm">
            <div>
              <p><span class="font-medium">Nama Santri:</span> ${laporanData.santri.nama_santri}</p>
              <p><span class="font-medium">NIS:</span> ${laporanData.santri.nis}</p>
              <p><span class="font-medium">Kelas:</span> ${laporanData.santri.kelas}</p>
            </div>
            <div>
              <p><span class="font-medium">Pembimbing:</span> ${laporanData.pembimbing.nama_pembimbing}</p>
              <p><span class="font-medium">Halaqah:</span> ${laporanData.pembimbing.nama_halaqah}</p>
            </div>
          </div>
          
          <div class="mb-4 p-4 bg-gray-100 rounded-lg border-2 border-gray-800">
            <h3 class="font-bold text-gray-800 mb-2 text-center">Progress Hafalan Al-Qur'an & Hadits:</h3>
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p class="text-gray-600 text-center">Hafalan Awal Bulan:</p>
                <p class="text-lg font-bold text-gray-800 text-center">${laporanData.hafalanAwal.juz} Juz ${laporanData.hafalanAwal.halaman} Hal</p>
              </div>
              <div>
                <p class="text-gray-600 text-center">Total Hafalan Sekarang:</p>
                <p class="text-lg font-bold text-gray-800 text-center">${laporanData.hafalanTotal.juz} Juz ${laporanData.hafalanTotal.halaman} Hal</p>
              </div>
              <div>
                <p class="text-gray-600 text-center">Hadits Awal Bulan:</p>
                <p class="text-lg font-bold text-gray-800 text-center">${laporanData.haditsAwal} Hadits</p>
              </div>
              <div>
                <p class="text-gray-600 text-center">Total Hadits Sekarang:</p>
                <p class="text-lg font-bold text-gray-800 text-center">${laporanData.haditsTotal} Hadits</p>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-400">
              <p class="text-center text-sm text-gray-700">
                <span class="font-bold text-gray-800">Tambahan bulan ini: ${laporanData.hafalan.jumlah} halaman Al-Qur'an, ${laporanData.hadits.jumlah} hadits</span>
              </p>
            </div>
          </div>
          
          <table class="w-full border-collapse border border-gray-300 text-sm mb-4">
            <thead>
              <tr class="bg-gray-200">
                <th class="border border-gray-300 px-3 py-2">Kategori</th>
                <th class="border border-gray-300 px-3 py-2">Detail</th>
                <th class="border border-gray-300 px-3 py-2">Rata-rata Nilai</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Hafalan Baru</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hafalan.totalHalaman} hal</td>
                <td class="border border-gray-300 px-3 py-2 text-center font-bold">${laporanData.hafalan.rata}</td>
              </tr>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Tahsin</td>
                <td class="border border-gray-300 px-3 py-2 text-center">-</td>
                <td class="border border-gray-300 px-3 py-2 text-center font-bold">${laporanData.tahsin.rata}</td>
              </tr>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Murajaah</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.murajaah.totalHalaman} hal</td>
                <td class="border border-gray-300 px-3 py-2 text-center font-bold">${laporanData.murajaah.rata}</td>
              </tr>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Hadits</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.hadits.totalHadits} hadits</td>
                <td class="border border-gray-300 px-3 py-2 text-center font-bold">${laporanData.hadits.rata}</td>
              </tr>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Mutaba'ah</td>
                <td class="border border-gray-300 px-3 py-2 text-center">-</td>
                <td class="border border-gray-300 px-3 py-2 text-center font-bold">${laporanData.mutabaah.rata}</td>
              </tr>
              <tr>
                <td class="border border-gray-300 px-3 py-2">Tasmi'</td>
                <td class="border border-gray-300 px-3 py-2 text-center">${laporanData.tasmi.totalJuz} juz</td>
                <td class="border border-gray-300 px-3 py-2 text-center font-bold">${laporanData.tasmi.rata}</td>
              </tr>
            </tbody>
          </table>
          
          <div class="mb-4">
            <h3 class="font-bold text-gray-800 mb-2">Rekap Absensi Bulanan:</h3>
            <div class="grid grid-cols-4 gap-2 text-sm">
              <div class="border border-gray-300 px-3 py-2 text-center">
                <p class="font-medium">Hadir (H)</p>
                <p class="text-2xl text-gray-800">${laporanData.absensi.counts.H}</p>
              </div>
              <div class="border border-gray-300 px-3 py-2 text-center">
                <p class="font-medium">Izin (I)</p>
                <p class="text-2xl text-gray-800">${laporanData.absensi.counts.I}</p>
              </div>
              <div class="border border-gray-300 px-3 py-2 text-center">
                <p class="font-medium">Sakit (S)</p>
                <p class="text-2xl text-gray-800">${laporanData.absensi.counts.S}</p>
              </div>
              <div class="border border-gray-300 px-3 py-2 text-center">
                <p class="font-medium">Alpa (A)</p>
                <p class="text-2xl text-gray-800">${laporanData.absensi.counts.A}</p>
              </div>
            </div>
          </div>
          
          <div class="mb-6 p-4 bg-gray-50 rounded-lg">
            <h3 class="font-bold text-gray-800 mb-2">Catatan Pembimbing:</h3>
            <p class="text-sm text-gray-700 text-justify">${generateCatatanBulanan(laporanData)}</p>
          </div>
          
          <div class="mt-8 flex justify-between text-sm">
            <div class="text-center">
              <p class="mb-16">Orang Tua/Wali</p>
              <p class="border-t border-gray-800 pt-1 inline-block px-8">${laporanData.santri.nama_wali}</p>
            </div>
            <div class="text-center">
              <p class="mb-16">Pembimbing</p>
              <p class="border-t border-gray-800 pt-1 inline-block px-8">${laporanData.pembimbing.nama_pembimbing}</p>
            </div>
          </div>
        `;
        
        currentLaporanData = { type: 'bulanan', data: laporanData, html: html };
        document.getElementById('content-laporan-bulanan').innerHTML = html;
        document.getElementById('preview-laporan-bulanan').classList.remove('hidden');
        
        showToast('Laporan bulanan berhasil ditampilkan');
      } catch (error) {
        console.error(error);
        showToast('Gagal menampilkan laporan bulanan', 'error');
      }
    };

    window.tampilkanRaporSemester = async function() {
      const santriId = document.getElementById('santri-rapor').value;
      const semester = document.getElementById('semester-rapor').value;
      const tahunAjaran = document.getElementById('tahun-ajaran-rapor').value;
      
      if (!santriId || !semester || !tahunAjaran) {
        showToast('Lengkapi semua field', 'error');
        return;
      }
      
      try {
        // Parse tahun ajaran (e.g., "2023/2024")
        const [tahunMulai, tahunSelesai] = tahunAjaran.split('/').map(t => parseInt(t));
        
        // Calculate date range based on semester and get monthly data
        let bulanList = [];
        if (semester === '1') {
          // Semester 1: Juli - Desember
          bulanList = [
            { bulan: 7, tahun: tahunMulai },
            { bulan: 8, tahun: tahunMulai },
            { bulan: 9, tahun: tahunMulai },
            { bulan: 10, tahun: tahunMulai },
            { bulan: 11, tahun: tahunMulai },
            { bulan: 12, tahun: tahunMulai }
          ];
        } else {
          // Semester 2: Januari - Juni
          bulanList = [
            { bulan: 1, tahun: tahunSelesai },
            { bulan: 2, tahun: tahunSelesai },
            { bulan: 3, tahun: tahunSelesai },
            { bulan: 4, tahun: tahunSelesai },
            { bulan: 5, tahun: tahunSelesai },
            { bulan: 6, tahun: tahunSelesai }
          ];
        }
        
        // Reload santri data untuk mendapatkan data terkini
        const santriSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'santri'));
        const santriDataTerkini = santriSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Load all data
        const hafalanSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'hafalan_baru'));
        const hafalanData = hafalanSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const tahsinSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahsin'));
        const tahsinData = tahsinSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const murajaahSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'murajaah'));
        const murajaahData = murajaahSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const haditsSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'hadits'));
        const haditsData = haditsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const mutabaahSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'mutabaah'));
        const mutabaahData = mutabaahSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const tasmiSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'tasmi'));
        const tasmiData = tasmiSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const absensiSnap = await window.firestore.getDocs(window.firestore.collection(window.db, 'absensi'));
        const absensiData = absensiSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        // Calculate date range for entire semester
        const tanggalMulaiSemester = semester === '1' 
          ? new Date(tahunMulai, 6, 1).toISOString().split('T')[0]  // Juli
          : new Date(tahunSelesai, 0, 1).toISOString().split('T')[0];  // Januari
        
        const tanggalSelesaiSemester = semester === '1'
          ? new Date(tahunMulai, 11, 31).toISOString().split('T')[0]  // Desember
          : new Date(tahunSelesai, 5, 30).toISOString().split('T')[0];  // Juni
        
        // Get all data for the semester period
        const hafalanSemester = filterDataByDateRange(hafalanData, tanggalMulaiSemester, tanggalSelesaiSemester, santriId);
        const tahsinSemester = filterDataByDateRange(tahsinData, tanggalMulaiSemester, tanggalSelesaiSemester, santriId);
        const murajaahSemester = filterDataByDateRange(murajaahData, tanggalMulaiSemester, tanggalSelesaiSemester, santriId);
        const haditsSemester = filterDataByDateRange(haditsData, tanggalMulaiSemester, tanggalSelesaiSemester, santriId);
        const mutabaahSemester = filterDataByDateRange(mutabaahData, tanggalMulaiSemester, tanggalSelesaiSemester, santriId);
        const tasmiSemester = filterDataByDateRange(tasmiData, tanggalMulaiSemester, tanggalSelesaiSemester, santriId);
        const absensiSemester = filterDataByDateRange(absensiData, tanggalMulaiSemester, tanggalSelesaiSemester, santriId);
        
        // Calculate monthly statistics for each month in semester
        const dataBulanan = [];
        for (const bulanInfo of bulanList) {
          const tanggalMulaiBulan = new Date(bulanInfo.tahun, bulanInfo.bulan - 1, 1).toISOString().split('T')[0];
          const tanggalSelesaiBulan = new Date(bulanInfo.tahun, bulanInfo.bulan, 0).toISOString().split('T')[0];
          
          const hafalanBulan = filterDataByDateRange(hafalanData, tanggalMulaiBulan, tanggalSelesaiBulan, santriId);
          const tahsinBulan = filterDataByDateRange(tahsinData, tanggalMulaiBulan, tanggalSelesaiBulan, santriId);
          const murajaahBulan = filterDataByDateRange(murajaahData, tanggalMulaiBulan, tanggalSelesaiBulan, santriId);
          const haditsBulan = filterDataByDateRange(haditsData, tanggalMulaiBulan, tanggalSelesaiBulan, santriId);
          const mutabaahBulan = filterDataByDateRange(mutabaahData, tanggalMulaiBulan, tanggalSelesaiBulan, santriId);
          const tasmiBulan = filterDataByDateRange(tasmiData, tanggalMulaiBulan, tanggalSelesaiBulan, santriId);
          
          const nilaiHafalanBulan = hitungPersentaseNilai(hafalanBulan);
          const nilaiTahsinBulan = hitungPersentaseNilai(tahsinBulan);
          const nilaiMurajaahBulan = hitungPersentaseNilai(murajaahBulan);
          const nilaiHaditsBulan = hitungPersentaseNilai(haditsBulan);
          const nilaiMutabaahBulan = hitungPersentaseNilai(mutabaahBulan);
          const nilaiTasmiBulan = hitungPersentaseNilai(tasmiBulan);
          
          dataBulanan.push({
            bulan: bulanInfo.bulan,
            tahun: bulanInfo.tahun,
            hafalan: hitungRataRata(nilaiHafalanBulan),
            tahsin: hitungRataRata(nilaiTahsinBulan),
            murajaah: hitungRataRata(nilaiMurajaahBulan),
            hadits: hitungRataRata(nilaiHaditsBulan),
            mutabaah: hitungRataRata(nilaiMutabaahBulan),
            tasmi: hitungRataRata(nilaiTasmiBulan)
          });
        }
        
        const nilaiAngka = { A: 4, B: 3, C: 2, D: 1 };
        
        // Calculate average nilai from monthly data (not semester aggregate)
        function hitungRataDariBulan(kategori) {
          const nilaiValid = dataBulanan.filter(b => b[kategori] !== '-');
          if (nilaiValid.length === 0) return { huruf: '-', angka: 0 };
          
          const totalAngka = nilaiValid.reduce((sum, b) => sum + (nilaiAngka[b[kategori]] || 0), 0);
          const rata = totalAngka / nilaiValid.length;
          
          let huruf = '-';
          if (rata >= 3.5) huruf = 'A';
          else if (rata >= 2.5) huruf = 'B';
          else if (rata >= 1.5) huruf = 'C';
          else if (rata > 0) huruf = 'D';
          
          return { huruf: huruf, angka: rata };
        }
        
        const nilai = {
          hafalan: hitungRataDariBulan('hafalan'),
          tahsin: hitungRataDariBulan('tahsin'),
          murajaah: hitungRataDariBulan('murajaah'),
          hadits: hitungRataDariBulan('hadits'),
          mutabaah: hitungRataDariBulan('mutabaah'),
          tasmi: hitungRataDariBulan('tasmi')
        };
        
        // Calculate semester statistics - gunakan data terkini
        const santri = santriDataTerkini.find(s => s.id === santriId);
        const pembimbing = pembimbingData.find(p => p.id === currentPembimbingId);
        
        // Hitung tambahan hafalan dari input semester ini
        const tambahanHalamanSemester = hafalanSemester.reduce((sum, h) => sum + (h.jumlah_halaman || 0), 0);
        const tambahanHaditsSemester = haditsSemester.reduce((sum, h) => sum + (h.jumlah_hadits || 0), 0);
        
        // Total hafalan SAAT INI dari database santri (sudah ter-update)
        const totalJuz = santri.total_hafalan_juz || 0;
        const totalHalaman = santri.total_hafalan_halaman || 0;
        const totalHadits = santri.total_hadits || 0;
        
        // Hitung hafalan awal semester = total sekarang - tambahan semester
        let hafalanAwalJuz = totalJuz;
        let hafalanAwalHalaman = totalHalaman - tambahanHalamanSemester;
        
        // Jika hafalanAwalHalaman negatif, kurangi juz
        while (hafalanAwalHalaman < 0) {
          hafalanAwalJuz -= 1;
          hafalanAwalHalaman += 20;
        }
        
        const haditsAwal = totalHadits - tambahanHaditsSemester;
        
        // Calculate overall average
        const nilaiValid = Object.values(nilai).filter(n => n.huruf !== '-');
        const totalAngka = nilaiValid.reduce((sum, n) => sum + n.angka, 0);
        const rataAngka = nilaiValid.length > 0 ? totalAngka / nilaiValid.length : 0;
        
        let rataHuruf = '-';
        if (rataAngka >= 3.5) rataHuruf = 'A';
        else if (rataAngka >= 2.5) rataHuruf = 'B';
        else if (rataAngka >= 1.5) rataHuruf = 'C';
        else if (rataAngka > 0) rataHuruf = 'D';
        
        const laporanData = {
          santri: santri,
          pembimbing: pembimbing,
          semester: semester,
          tahunAjaran: tahunAjaran,
          nilai: nilai,
          rataRata: {
            angka: rataAngka.toFixed(2),
            huruf: rataHuruf
          },
          hafalanAwal: {
            juz: hafalanAwalJuz >= 0 ? hafalanAwalJuz : 0,
            halaman: hafalanAwalHalaman >= 0 ? hafalanAwalHalaman : 0
          },
          hafalanTotal: {
            juz: totalJuz,
            halaman: totalHalaman
          },
          haditsAwal: haditsAwal >= 0 ? haditsAwal : 0,
          haditsTotal: totalHadits,
          tambahanHafalan: tambahanHalamanSemester,
          tambahanHadits: tambahanHaditsSemester,
          absensi: {
            total: absensiSemester.length,
            counts: {
              H: absensiSemester.filter(a => a.status === 'H').length,
              I: absensiSemester.filter(a => a.status === 'I').length,
              S: absensiSemester.filter(a => a.status === 'S').length,
              A: absensiSemester.filter(a => a.status === 'A').length
            }
          }
        };
        
        // Generate HTML
        const html = `
          <div class="text-center mb-6">
            <h2 class="text-2xl font-bold text-gray-800">RAPOR SEMESTER TAHFIDZ</h2>
            <p class="text-lg text-gray-700 mt-2">Ma'had Abu Bakar Ash-Shiddiq Anabanua</p>
            <p class="text-sm text-gray-600 mt-2">Semester ${laporanData.semester} - Tahun Ajaran ${laporanData.tahunAjaran}</p>
          </div>
          
          <div class="mb-6 border border-gray-300 p-4 rounded-lg">
            <div class="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p><span class="font-medium">Nama Santri:</span> ${laporanData.santri.nama_santri}</p>
                <p><span class="font-medium">NIS:</span> ${laporanData.santri.nis}</p>
                <p><span class="font-medium">Kelas:</span> ${laporanData.santri.kelas}</p>
              </div>
              <div>
                <p><span class="font-medium">Pembimbing:</span> ${laporanData.pembimbing.nama_pembimbing}</p>
                <p><span class="font-medium">Halaqah:</span> ${laporanData.pembimbing.nama_halaqah}</p>
                <p><span class="font-medium">Nama Wali:</span> ${laporanData.santri.nama_wali}</p>
              </div>
            </div>
          </div>
          
          <div class="mb-4 p-4 bg-gray-100 rounded-lg border-2 border-gray-800">
            <h3 class="font-bold text-gray-800 mb-2 text-center">Capaian Hafalan Semester Ini:</h3>
            <div class="grid grid-cols-2 gap-4 text-sm mb-3">
              <div class="text-center">
                <p class="text-gray-600">Hafalan Awal Semester:</p>
                <p class="text-xl font-bold text-gray-800">${laporanData.hafalanAwal.juz} Juz ${laporanData.hafalanAwal.halaman} Hal</p>
              </div>
              <div class="text-center">
                <p class="text-gray-600">Total Hafalan Sekarang:</p>
                <p class="text-2xl font-bold text-gray-800">${laporanData.hafalanTotal.juz} Juz ${laporanData.hafalanTotal.halaman} Hal</p>
              </div>
            </div>
            <div class="grid grid-cols-2 gap-4 text-sm pt-3 border-t border-gray-400">
              <div class="text-center">
                <p class="text-gray-600">Hadits Awal Semester:</p>
                <p class="text-xl font-bold text-gray-800">${laporanData.haditsAwal}</p>
              </div>
              <div class="text-center">
                <p class="text-gray-600">Total Hadits Sekarang:</p>
                <p class="text-2xl font-bold text-gray-800">${laporanData.haditsTotal}</p>
              </div>
            </div>
            <div class="mt-3 pt-3 border-t border-gray-400">
              <p class="text-center text-sm text-gray-700">
                <span class="font-bold text-gray-800">Tambahan semester ini: ${laporanData.tambahanHafalan} halaman Al-Qur'an, ${laporanData.tambahanHadits} hadits</span>
              </p>
            </div>
          </div>
          
          <table class="w-full border-collapse border-2 border-gray-800 text-sm mb-4">
            <thead>
              <tr class="bg-gray-800 text-white">
                <th class="border border-gray-800 px-3 py-2">Komponen Penilaian</th>
                <th class="border border-gray-800 px-3 py-2">Nilai Huruf</th>
                <th class="border border-gray-800 px-3 py-2">Keterangan</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="border border-gray-800 px-3 py-2">Hafalan Baru</td>
                <td class="border border-gray-800 px-3 py-2 text-center font-bold text-lg">${laporanData.nilai.hafalan.huruf}</td>
                <td class="border border-gray-800 px-3 py-2 text-center">${laporanData.nilai.hafalan.huruf === 'A' ? 'Mumtaz' : laporanData.nilai.hafalan.huruf === 'B' ? 'Jayyid Jiddan' : laporanData.nilai.hafalan.huruf === 'C' ? 'Jayyid' : laporanData.nilai.hafalan.huruf === 'D' ? 'Maqbul' : '-'}</td>
              </tr>
              <tr>
                <td class="border border-gray-800 px-3 py-2">Tahsin</td>
                <td class="border border-gray-800 px-3 py-2 text-center font-bold text-lg">${laporanData.nilai.tahsin.huruf}</td>
                <td class="border border-gray-800 px-3 py-2 text-center">${laporanData.nilai.tahsin.huruf === 'A' ? 'Mumtaz' : laporanData.nilai.tahsin.huruf === 'B' ? 'Jayyid Jiddan' : laporanData.nilai.tahsin.huruf === 'C' ? 'Jayyid' : laporanData.nilai.tahsin.huruf === 'D' ? 'Maqbul' : '-'}</td>
              </tr>
              <tr>
                <td class="border border-gray-800 px-3 py-2">Murajaah</td>
                <td class="border border-gray-800 px-3 py-2 text-center font-bold text-lg">${laporanData.nilai.murajaah.huruf}</td>
                <td class="border border-gray-800 px-3 py-2 text-center">${laporanData.nilai.murajaah.huruf === 'A' ? 'Mumtaz' : laporanData.nilai.murajaah.huruf === 'B' ? 'Jayyid Jiddan' : laporanData.nilai.murajaah.huruf === 'C' ? 'Jayyid' : laporanData.nilai.murajaah.huruf === 'D' ? 'Maqbul' : '-'}</td>
              </tr>
              <tr>
                <td class="border border-gray-800 px-3 py-2">Hadits</td>
                <td class="border border-gray-800 px-3 py-2 text-center font-bold text-lg">${laporanData.nilai.hadits.huruf}</td>
                <td class="border border-gray-800 px-3 py-2 text-center">${laporanData.nilai.hadits.huruf === 'A' ? 'Mumtaz' : laporanData.nilai.hadits.huruf === 'B' ? 'Jayyid Jiddan' : laporanData.nilai.hadits.huruf === 'C' ? 'Jayyid' : laporanData.nilai.hadits.huruf === 'D' ? 'Maqbul' : '-'}</td>
              </tr>
              <tr>
                <td class="border border-gray-800 px-3 py-2">Mutaba'ah Yaumiyah</td>
                <td class="border border-gray-800 px-3 py-2 text-center font-bold text-lg">${laporanData.nilai.mutabaah.huruf}</td>
                <td class="border border-gray-800 px-3 py-2 text-center">${laporanData.nilai.mutabaah.huruf === 'A' ? 'Mumtaz' : laporanData.nilai.mutabaah.huruf === 'B' ? 'Jayyid Jiddan' : laporanData.nilai.mutabaah.huruf === 'C' ? 'Jayyid' : laporanData.nilai.mutabaah.huruf === 'D' ? 'Maqbul' : '-'}</td>
              </tr>
              <tr>
                <td class="border border-gray-800 px-3 py-2">Tasmi'</td>
                <td class="border border-gray-800 px-3 py-2 text-center font-bold text-lg">${laporanData.nilai.tasmi.huruf}</td>
                <td class="border border-gray-800 px-3 py-2 text-center">${laporanData.nilai.tasmi.huruf === 'A' ? 'Mumtaz' : laporanData.nilai.tasmi.huruf === 'B' ? 'Jayyid Jiddan' : laporanData.nilai.tasmi.huruf === 'C' ? 'Jayyid' : laporanData.nilai.tasmi.huruf === 'D' ? 'Maqbul' : '-'}</td>
              </tr>
              <tr class="bg-gray-300">
                <td class="border border-gray-800 px-3 py-2 font-bold">RATA-RATA</td>
                <td class="border border-gray-800 px-3 py-2 text-center font-bold text-xl">${laporanData.rataRata.huruf}</td>
                <td class="border border-gray-800 px-3 py-2 text-center font-bold">${laporanData.rataRata.huruf === 'A' ? 'Mumtaz' : laporanData.rataRata.huruf === 'B' ? 'Jayyid Jiddan' : laporanData.rataRata.huruf === 'C' ? 'Jayyid' : laporanData.rataRata.huruf === 'D' ? 'Maqbul' : '-'} (${laporanData.rataRata.angka})</td>
              </tr>
            </tbody>
          </table>
          
          <div class="mb-4">
            <h3 class="font-bold text-gray-800 mb-2">Rekap Absensi Semester:</h3>
            <div class="grid grid-cols-4 gap-2 text-sm">
              <div class="border-2 border-gray-800 px-3 py-2 text-center bg-white">
                <p class="font-medium">Hadir (H)</p>
                <p class="text-2xl text-gray-800 font-bold">${laporanData.absensi.counts.H}</p>
              </div>
              <div class="border-2 border-gray-800 px-3 py-2 text-center bg-white">
                <p class="font-medium">Izin (I)</p>
                <p class="text-2xl text-gray-800 font-bold">${laporanData.absensi.counts.I}</p>
              </div>
              <div class="border-2 border-gray-800 px-3 py-2 text-center bg-white">
                <p class="font-medium">Sakit (S)</p>
                <p class="text-2xl text-gray-800 font-bold">${laporanData.absensi.counts.S}</p>
              </div>
              <div class="border-2 border-gray-800 px-3 py-2 text-center bg-white">
                <p class="font-medium">Alpa (A)</p>
                <p class="text-2xl text-gray-800 font-bold">${laporanData.absensi.counts.A}</p>
              </div>
            </div>
          </div>
          
          <div class="mb-6 p-4 bg-gray-50 rounded-lg border-l-4 border-gray-800">
            <h3 class="font-bold text-gray-800 mb-2">Catatan Pembimbing:</h3>
            <p class="text-sm text-gray-700 leading-relaxed text-justify">${generateCatatanRapor(laporanData)}</p>
          </div>
          
          <div class="mt-8 grid grid-cols-3 gap-8 text-sm">
            <div class="text-center">
              <p class="mb-16">Mengetahui,<br>Kepala Ma'had</p>
              <p class="border-t border-gray-800 pt-1 inline-block px-8">Marhali Abd. Rahman, S.Pd.I., M.Pd.</p>
            </div>
            <div class="text-center">
              <p class="mb-16">Pembimbing</p>
              <p class="border-t border-gray-800 pt-1 inline-block px-8">${laporanData.pembimbing.nama_pembimbing}</p>
            </div>
            <div class="text-center">
              <p class="mb-16">Orang Tua/Wali</p>
              <p class="border-t border-gray-800 pt-1 inline-block px-8">${laporanData.santri.nama_wali}</p>
            </div>
          </div>
        `;
        
        currentLaporanData = { type: 'rapor', data: laporanData, html: html };
        document.getElementById('content-rapor-semester').innerHTML = html;
        document.getElementById('preview-rapor-semester').classList.remove('hidden');
        
        showToast('Rapor semester berhasil ditampilkan');
      } catch (error) {
        console.error(error);
        showToast('Gagal menampilkan rapor semester', 'error');
      }
    };

    window.cetakLaporanPekanan = async function() {
      if (!currentLaporanData || currentLaporanData.type !== 'pekanan') {
        showToast('Tampilkan laporan terlebih dahulu', 'error');
        return;
      }
      
      try {
        const { jsPDF } = window.jspdf;
        const content = document.getElementById('content-laporan-pekanan');
        
        // Create canvas from content
        const canvas = await html2canvas(content, {
          scale: 2,
          useCORS: true,
          logging: false,
          width: content.scrollWidth,
          height: content.scrollHeight
        });
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        const doc = new jsPDF('p', 'mm', 'a4');
        let heightLeft = imgHeight;
        let position = 0;
        
        // Add first page
        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Add additional pages if content is longer than one page
        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        doc.save(`Laporan_Pekanan_${currentLaporanData.data.santri.nama_santri.replace(/\s+/g, '_')}.pdf`);
        showToast('Laporan berhasil dicetak');
      } catch (error) {
        console.error('Error generating PDF:', error);
        showToast('Gagal mencetak laporan', 'error');
      }
    };

    window.cetakLaporanBulanan = async function() {
      if (!currentLaporanData || currentLaporanData.type !== 'bulanan') {
        showToast('Tampilkan laporan terlebih dahulu', 'error');
        return;
      }
      
      try {
        const { jsPDF } = window.jspdf;
        const content = document.getElementById('content-laporan-bulanan');
        
        // Create canvas from content
        const canvas = await html2canvas(content, {
          scale: 2,
          useCORS: true,
          logging: false,
          width: content.scrollWidth,
          height: content.scrollHeight
        });
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        const doc = new jsPDF('p', 'mm', 'a4');
        let heightLeft = imgHeight;
        let position = 0;
        
        // Add first page
        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Add additional pages if content is longer than one page
        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        doc.save(`Laporan_Bulanan_${currentLaporanData.data.santri.nama_santri.replace(/\s+/g, '_')}_${currentLaporanData.data.bulan}_${currentLaporanData.data.tahun}.pdf`);
        showToast('Laporan bulanan berhasil dicetak');
      } catch (error) {
        console.error('Error generating PDF:', error);
        showToast('Gagal mencetak laporan', 'error');
      }
    };

    window.cetakRaporSemester = async function() {
      if (!currentLaporanData || currentLaporanData.type !== 'rapor') {
        showToast('Tampilkan rapor terlebih dahulu', 'error');
        return;
      }
      
      try {
        const { jsPDF } = window.jspdf;
        const content = document.getElementById('content-rapor-semester');
        
        // Create canvas from content
        const canvas = await html2canvas(content, {
          scale: 2,
          useCORS: true,
          logging: false,
          width: content.scrollWidth,
          height: content.scrollHeight
        });
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210; // A4 width in mm
        const pageHeight = 297; // A4 height in mm
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        const doc = new jsPDF('p', 'mm', 'a4');
        let heightLeft = imgHeight;
        let position = 0;
        
        // Add first page
        doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;
        
        // Add additional pages if content is longer than one page
        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          doc.addPage();
          doc.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
          heightLeft -= pageHeight;
        }
        
        doc.save(`Rapor_Semester_${currentLaporanData.data.semester}_${currentLaporanData.data.santri.nama_santri.replace(/\s+/g, '_')}.pdf`);
        showToast('Rapor semester berhasil dicetak');
      } catch (error) {
        console.error('Error generating PDF:', error);
        showToast('Gagal mencetak raporan', 'error');
      }
    };

    // Initialize app
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b92460ce3fa40f1',t:'MTc2NzYwODc0Ny4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
