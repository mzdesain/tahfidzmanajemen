<!doctype html>
<html lang="id" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistem Monitoring Hafalan Santri</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script><!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    
    const firebaseConfig = {
      apiKey: "AIzaSyAxoe-Bg6WUn59KjzaunvkCRVUbi1X95PQ",
      authDomain: "tahfidzmabash.firebaseapp.com",
      projectId: "tahfidzmabash",
      storageBucket: "tahfidzmabash.firebasestorage.app",
      messagingSenderId: "113529956394",
      appId: "1:113529956394:web:d6c9eedda4014fae937b53",
      measurementId: "G-GN5B5DLSPH"
    };
    
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    window.db = db;
    window.firestore = { collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, onSnapshot };
  </script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    .scrollable-nav {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .scrollable-nav::-webkit-scrollbar {
      display: none;
    }
    
    .toast {
      animation: slideIn 0.3s ease-out;
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
    
    .modal-backdrop {
      background-color: rgba(0, 0, 0, 0.5);
    }
    
    .btn-loading {
      position: relative;
      color: transparent;
    }
    
    .btn-loading::after {
      content: "";
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spin 0.6s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .pembimbing-card {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .pembimbing-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.15);
    }
    
    .pembimbing-card.active {
      border: 3px solid #4f46e5;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }
    
    .pembimbing-card.active .card-text {
      color: white;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div id="app" class="h-full w-full overflow-auto" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);"><!-- Top Navigation -->
   <nav class="bg-white shadow-lg sticky top-0 z-50">
    <div class="px-4 py-3">
     <div class="flex items-center justify-between mb-3">
      <div class="flex items-center space-x-4"><img src="https://ypwi.or.id/assets/setting/front/meta/image.png" alt="Logo Pondok" class="w-16 h-16 object-contain">
       <div>
        <h1 id="app-title" class="text-2xl font-bold text-gray-800">Sistem Monitoring Hafalan Santri</h1>
        <p id="madrasah-name" class="text-sm text-gray-600">Ma'had Abu Bakar Ash-Shiddiq Anabanua</p>
       </div>
      </div>
     </div>
     <div class="scrollable-nav overflow-x-auto">
      <div class="flex space-x-2 pb-2" style="min-width: max-content;"><button onclick="showPage('dashboard')" class="nav-btn px-4 py-2 rounded-lg bg-indigo-600 text-white font-medium whitespace-nowrap"> <i class="fas fa-home mr-2"></i>Dashboard </button> <button onclick="showPage('kelola-pembimbing')" class="nav-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium whitespace-nowrap hover:bg-gray-300"> <i class="fas fa-users mr-2"></i>Kelola Pembimbing </button> <button onclick="showPage('pembimbing')" class="nav-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium whitespace-nowrap hover:bg-gray-300"> <i class="fas fa-chalkboard-teacher mr-2"></i>Menu Pembimbing </button> <button onclick="showPage('kelola-sesi')" class="nav-btn px-4 py-2 rounded-lg bg-gray-200 text-gray-700 font-medium whitespace-nowrap hover:bg-gray-300"> <i class="fas fa-clock mr-2"></i>Kelola Sesi </button>
      </div>
     </div>
    </div>
   </nav><!-- Toast Container -->
   <div id="toast-container" class="fixed top-20 right-4 z-50 space-y-2"></div><!-- Edit Pembimbing Modal -->
   <div id="edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-backdrop">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4">
     <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-edit mr-2 text-indigo-600"></i>Edit Pembimbing</h3>
     <form id="form-edit-pembimbing" class="space-y-4"><input type="hidden" id="edit-pembimbing-id">
      <div><label for="edit-nama-pembimbing" class="block text-sm font-medium text-gray-700 mb-1">Nama Pembimbing</label> <input type="text" id="edit-nama-pembimbing" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>
      <div><label for="edit-nama-halaqah" class="block text-sm font-medium text-gray-700 mb-1">Nama Halaqah</label> <input type="text" id="edit-nama-halaqah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
      </div>
      <div class="flex space-x-2"><button type="submit" id="btn-update-pembimbing" class="flex-1 bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Update </button> <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-300 text-gray-700 px-6 py-2 rounded-lg font-medium hover:bg-gray-400"> <i class="fas fa-times mr-2"></i>Batal </button>
      </div>
     </form>
    </div>
   </div><!-- Main Content -->
   <div class="p-6"><!-- Dashboard Page -->
    <div id="page-dashboard" class="page-content">
     <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
      <div class="bg-white rounded-lg shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-600 text-sm font-medium">Total Pembimbing</p>
         <p id="total-pembimbing" class="text-3xl font-bold text-indigo-600 mt-2">0</p>
        </div>
        <div class="bg-indigo-100 p-4 rounded-full"><i class="fas fa-chalkboard-teacher text-3xl text-indigo-600"></i>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-600 text-sm font-medium">Total Santri</p>
         <p id="total-santri" class="text-3xl font-bold text-green-600 mt-2">0</p>
        </div>
        <div class="bg-green-100 p-4 rounded-full"><i class="fas fa-user-graduate text-3xl text-green-600"></i>
        </div>
       </div>
      </div>
      <div class="bg-white rounded-lg shadow-lg p-6">
       <div class="flex items-center justify-between">
        <div>
         <p class="text-gray-600 text-sm font-medium">Rata-rata Hafalan</p>
         <p id="avg-hafalan" class="text-3xl font-bold text-purple-600 mt-2">0 Juz</p>
        </div>
        <div class="bg-purple-100 p-4 rounded-full"><i class="fas fa-book-quran text-3xl text-purple-600"></i>
        </div>
       </div>
      </div>
     </div>
     <div class="bg-white rounded-lg shadow-lg p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-info-circle mr-2 text-indigo-600"></i>Selamat Datang</h3>
      <p class="text-gray-600 mb-4">Sistem ini membantu Anda mengelola dan memantau perkembangan hafalan santri secara terstruktur dan profesional.</p>
      <div class="bg-indigo-50 border-l-4 border-indigo-600 p-4 rounded">
       <p class="text-sm text-gray-700"><i class="fas fa-lightbulb mr-2 text-indigo-600"></i> Mulai dengan menambahkan data pembimbing di menu <strong>Kelola Pembimbing</strong>, kemudian masuk ke <strong>Menu Pembimbing</strong> untuk mengelola santri dan input data hafalan.</p>
      </div>
     </div>
    </div><!-- Kelola Pembimbing Page -->
    <div id="page-kelola-pembimbing" class="page-content hidden">
     <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-user-plus mr-2 text-indigo-600"></i>Tambah Pembimbing</h3>
      <form id="form-pembimbing" class="space-y-4">
       <div><label for="nama-pembimbing" class="block text-sm font-medium text-gray-700 mb-1">Nama Pembimbing</label> <input type="text" id="nama-pembimbing" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
       </div>
       <div><label for="nama-halaqah" class="block text-sm font-medium text-gray-700 mb-1">Nama Halaqah</label> <input type="text" id="nama-halaqah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
       </div><button type="submit" id="btn-submit-pembimbing" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700 transition"> <i class="fas fa-save mr-2"></i>Simpan Pembimbing </button>
      </form>
     </div>
     <div class="bg-white rounded-lg shadow-lg p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-list mr-2 text-indigo-600"></i>Daftar Pembimbing</h3>
      <div id="list-pembimbing" class="space-y-3"></div>
     </div>
    </div><!-- Menu Pembimbing Page -->
    <div id="page-pembimbing" class="page-content hidden">
     <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-filter mr-2 text-indigo-600"></i>Pilih Pembimbing</h3>
      <div id="pembimbing-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4"></div>
     </div>
     <div id="pembimbing-menu" class="hidden">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"><button onclick="showSubMenu('kelola-santri')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-user-graduate text-4xl text-indigo-600 mb-3"></i> <p class="font-medium text-gray-800">Kelola Santri</p></button> <button onclick="showSubMenu('tahun-ajaran')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-calendar-alt text-4xl text-green-600 mb-3"></i> <p class="font-medium text-gray-800">Tahun Ajaran</p></button> <button onclick="showSubMenu('input-hafalan')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-book-quran text-4xl text-purple-600 mb-3"></i> <p class="font-medium text-gray-800">Input Hafalan</p></button> <button onclick="showSubMenu('input-tahsin')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-spell-check text-4xl text-blue-600 mb-3"></i> <p class="font-medium text-gray-800">Input Tahsin</p></button> <button onclick="showSubMenu('input-murajaah')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-redo text-4xl text-orange-600 mb-3"></i> <p class="font-medium text-gray-800">Input Murajaah</p></button> <button onclick="showSubMenu('input-hadits')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-scroll text-4xl text-yellow-600 mb-3"></i> <p class="font-medium text-gray-800">Input Hadits</p></button> <button onclick="showSubMenu('mutabaah')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-check-double text-4xl text-teal-600 mb-3"></i> <p class="font-medium text-gray-800">Mutaba'ah</p></button> <button onclick="showSubMenu('absensi')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-clipboard-check text-4xl text-red-600 mb-3"></i> <p class="font-medium text-gray-800">Absensi</p></button> <button onclick="showSubMenu('tasmi')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-headphones text-4xl text-pink-600 mb-3"></i> <p class="font-medium text-gray-800">Tasmi'</p></button> <button onclick="showSubMenu('laporan-pekanan')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-file-alt text-4xl text-cyan-600 mb-3"></i> <p class="font-medium text-gray-800">Laporan Pekanan</p></button> <button onclick="showSubMenu('laporan-bulanan')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-file-pdf text-4xl text-lime-600 mb-3"></i> <p class="font-medium text-gray-800">Laporan Bulanan</p></button> <button onclick="showSubMenu('rapor-semester')" class="bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition text-center"> <i class="fas fa-graduation-cap text-4xl text-rose-600 mb-3"></i> <p class="font-medium text-gray-800">Rapor Semester</p></button>
      </div><!-- Sub Menus -->
      <div id="submenu-kelola-santri" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Kelola Santri</h3>
       <form id="form-santri" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
         <div><label for="nis" class="block text-sm font-medium text-gray-700 mb-1">NIS</label> <input type="text" id="nis" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="nama-santri" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <input type="text" id="nama-santri" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="kelas" class="block text-sm font-medium text-gray-700 mb-1">Kelas</label> <input type="text" id="kelas" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="nama-wali" class="block text-sm font-medium text-gray-700 mb-1">Nama Orang Tua/Wali</label> <input type="text" id="nama-wali" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="hafalan-juz" class="block text-sm font-medium text-gray-700 mb-1">Total Hafalan (Juz)</label> <input type="number" id="hafalan-juz" min="0" max="30" value="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="hafalan-halaman" class="block text-sm font-medium text-gray-700 mb-1">Total Hafalan (Halaman)</label> <input type="number" id="hafalan-halaman" min="0" max="604" value="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="total-hadits" class="block text-sm font-medium text-gray-700 mb-1">Total Hadits</label> <input type="number" id="total-hadits" min="0" value="0" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div><button type="submit" id="btn-submit-santri" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Santri </button>
       </form>
       <div id="list-santri" class="space-y-3"></div>
      </div>
      <div id="submenu-tahun-ajaran" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Kelola Tahun Ajaran</h3>
       <form id="form-tahun-ajaran" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div><label for="tahun-ajaran" class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label> <input type="text" id="tahun-ajaran" placeholder="2023/2024" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div><button type="submit" id="btn-submit-tahun" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Tahun Ajaran </button>
       </form>
       <div><label for="filter-tahun-ajaran" class="block text-sm font-medium text-gray-700 mb-1">Filter Tahun Ajaran</label> <select id="filter-tahun-ajaran" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Semua Tahun Ajaran --</option> </select>
       </div>
      </div>
      <div id="submenu-input-hafalan" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Hafalan Baru</h3>
       <form id="form-hafalan-baru" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-hafalan" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-hafalan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-hafalan" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-hafalan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="juz-hafalan" class="block text-sm font-medium text-gray-700 mb-1">Juz</label> <input type="number" id="juz-hafalan" min="1" max="30" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="halaman-hafalan" class="block text-sm font-medium text-gray-700 mb-1">Halaman</label> <input type="number" id="halaman-hafalan" min="1" max="604" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div>
        <div><label for="nilai-hafalan" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label> <select id="nilai-hafalan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Nilai --</option> <option value="A">A - Mumtaz</option> <option value="B">B - Jayyid Jiddan</option> <option value="C">C - Jayyid</option> <option value="D">D - Maqbul</option> </select>
        </div><button type="submit" id="btn-submit-hafalan" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Hafalan </button>
       </form>
      </div>
      <div id="submenu-input-tahsin" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Tahsin</h3>
       <form id="form-tahsin" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-tahsin" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-tahsin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-tahsin" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-tahsin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="kategori-tahsin" class="block text-sm font-medium text-gray-700 mb-1">Kategori</label> <select id="kategori-tahsin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Kategori --</option> <option value="Makharijul Huruf">Makharijul Huruf</option> <option value="Tajwid">Tajwid</option> </select>
        </div>
        <div><label for="nilai-tahsin" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label> <select id="nilai-tahsin" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Nilai --</option> <option value="A">A - Mumtaz</option> <option value="B">B - Jayyid Jiddan</option> <option value="C">C - Jayyid</option> <option value="D">D - Maqbul</option> </select>
        </div><button type="submit" id="btn-submit-tahsin" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Tahsin </button>
       </form>
      </div>
      <div id="submenu-input-murajaah" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Murajaah</h3>
       <form id="form-murajaah" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-murajaah" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-murajaah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-murajaah" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-murajaah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="juz-murajaah" class="block text-sm font-medium text-gray-700 mb-1">Juz</label> <input type="number" id="juz-murajaah" min="1" max="30" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="halaman-murajaah" class="block text-sm font-medium text-gray-700 mb-1">Halaman</label> <input type="number" id="halaman-murajaah" min="1" max="604" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div>
        <div><label for="nilai-murajaah" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label> <select id="nilai-murajaah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Nilai --</option> <option value="A">A - Mumtaz</option> <option value="B">B - Jayyid Jiddan</option> <option value="C">C - Jayyid</option> <option value="D">D - Maqbul</option> </select>
        </div><button type="submit" id="btn-submit-murajaah" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Murajaah </button>
       </form>
      </div>
      <div id="submenu-input-hadits" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Hadits</h3>
       <form id="form-hadits" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-hadits" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-hadits" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-hadits" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-hadits" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="hadits-ke" class="block text-sm font-medium text-gray-700 mb-1">Hadits Ke-</label> <input type="number" id="hadits-ke" min="1" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="nilai-hadits" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label> <select id="nilai-hadits" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Nilai --</option> <option value="A">A - Mumtaz</option> <option value="B">B - Jayyid Jiddan</option> <option value="C">C - Jayyid</option> <option value="D">D - Maqbul</option> </select>
        </div><button type="submit" id="btn-submit-hadits" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Hadits </button>
       </form>
      </div>
      <div id="submenu-mutabaah" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Mutaba'ah Yaumiyah</h3>
       <form id="form-mutabaah" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-mutabaah" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-mutabaah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-mutabaah" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-mutabaah" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="space-y-2">
         <p class="font-medium text-gray-700">Aktivitas Harian:</p>
         <div class="grid grid-cols-2 gap-3"><label class="flex items-center space-x-2"> <input type="checkbox" id="check-subuh" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Shalat Subuh</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-zhuhur" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Zhuhur</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-ashar" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Ashar</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-maghrib" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Maghrib</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-isya" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Isya</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-dhuha" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Dhuha</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-qiyam" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Qiyamul Lail</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-rawatib" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Rawatib</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-dzikir" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Dzikir Pagi-Petang</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-puasa" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Puasa Sunnah</span> </label> <label class="flex items-center space-x-2"> <input type="checkbox" id="check-hafalan-hadits" class="w-4 h-4 text-indigo-600 rounded focus:ring-indigo-500"> <span class="text-sm text-gray-700">Hafalan Hadits</span> </label>
         </div>
        </div>
        <div class="bg-indigo-50 p-3 rounded-lg">
         <p class="text-sm text-gray-700"><i class="fas fa-info-circle text-indigo-600 mr-2"></i> Nilai akan dihitung otomatis: 9-11 = A, 6-8 = B, 3-5 = C, 0-2 = D</p>
        </div><button type="submit" id="btn-submit-mutabaah" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Mutaba'ah </button>
       </form>
      </div>
      <div id="submenu-absensi" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Absensi</h3>
       <div class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-absensi" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-absensi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="sesi-absensi" class="block text-sm font-medium text-gray-700 mb-1">Sesi</label> <select id="sesi-absensi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Sesi --</option> </select>
        </div><button onclick="loadAbsensiSantri()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-list mr-2"></i>Muat Daftar Santri </button>
       </div>
       <div id="list-absensi" class="space-y-2"></div><button onclick="simpanAbsensi()" id="btn-simpan-absensi" class="mt-4 bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700 hidden"> <i class="fas fa-save mr-2"></i>Simpan Absensi </button>
      </div>
      <div id="submenu-tasmi" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Input Tasmi'</h3>
       <form id="form-tasmi" class="space-y-4 p-4 bg-gray-50 rounded-lg">
        <div><label for="tanggal-tasmi" class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label> <input type="date" id="tanggal-tasmi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="santri-tasmi" class="block text-sm font-medium text-gray-700 mb-1">Nama Santri</label> <select id="santri-tasmi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div><label for="juz-tasmi" class="block text-sm font-medium text-gray-700 mb-1">Juz yang Ditasmi'</label> <input type="text" id="juz-tasmi" placeholder="Contoh: 1, 2-3, atau 1 s/d 5" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         <p class="text-xs text-gray-500 mt-1">Bisa input angka tunggal (1) atau rentang (1-3, 1 s/d 5)</p>
        </div>
        <div><label for="nilai-tasmi" class="block text-sm font-medium text-gray-700 mb-1">Nilai</label> <select id="nilai-tasmi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Nilai --</option> <option value="A">A - Mumtaz</option> <option value="B">B - Jayyid Jiddan</option> <option value="C">C - Jayyid</option> <option value="D">D - Maqbul</option> </select>
        </div><button type="submit" id="btn-submit-tasmi" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Tasmi' </button>
       </form>
      </div>
      <div id="submenu-laporan-pekanan" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Laporan Pekanan</h3>
       <form id="form-laporan-pekanan" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div><label for="santri-laporan-pekanan" class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label> <select id="santri-laporan-pekanan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="tanggal-mulai-pekanan" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Mulai</label> <input type="date" id="tanggal-mulai-pekanan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
         <div><label for="tanggal-selesai-pekanan" class="block text-sm font-medium text-gray-700 mb-1">Tanggal Selesai</label> <input type="date" id="tanggal-selesai-pekanan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div><button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-eye mr-2"></i>Tampilkan Laporan </button>
       </form>
       <div id="preview-laporan-pekanan" class="hidden">
        <div class="flex justify-end mb-4"><button onclick="cetakLaporanPekanan()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700"> <i class="fas fa-print mr-2"></i>Cetak PDF </button>
        </div>
        <div id="content-laporan-pekanan" class="bg-white border border-gray-300 rounded-lg p-8"></div>
       </div>
      </div>
      <div id="submenu-laporan-bulanan" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Laporan Bulanan</h3>
       <form id="form-laporan-bulanan" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div><label for="santri-laporan-bulanan" class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label> <select id="santri-laporan-bulanan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="bulan-laporan" class="block text-sm font-medium text-gray-700 mb-1">Bulan</label> <select id="bulan-laporan" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Bulan --</option> <option value="1">Januari</option> <option value="2">Februari</option> <option value="3">Maret</option> <option value="4">April</option> <option value="5">Mei</option> <option value="6">Juni</option> <option value="7">Juli</option> <option value="8">Agustus</option> <option value="9">September</option> <option value="10">Oktober</option> <option value="11">November</option> <option value="12">Desember</option> </select>
         </div>
         <div><label for="tahun-laporan" class="block text-sm font-medium text-gray-700 mb-1">Tahun</label> <input type="number" id="tahun-laporan" min="2000" max="2100" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
         </div>
        </div><button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-eye mr-2"></i>Tampilkan Laporan </button>
       </form>
       <div id="preview-laporan-bulanan" class="hidden">
        <div class="flex justify-end mb-4"><button onclick="cetakLaporanBulanan()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700"> <i class="fas fa-print mr-2"></i>Cetak PDF </button>
        </div>
        <div id="content-laporan-bulanan" class="bg-white border border-gray-300 rounded-lg p-8"></div>
       </div>
      </div>
      <div id="submenu-rapor-semester" class="submenu-content hidden bg-white rounded-lg shadow-lg p-6"><button onclick="hideSubMenu()" class="mb-4 text-indigo-600 hover:text-indigo-800"> <i class="fas fa-arrow-left mr-2"></i>Kembali </button>
       <h3 class="text-xl font-bold text-gray-800 mb-4">Rapor Semester</h3>
       <form id="form-rapor-semester" class="space-y-4 mb-6 p-4 bg-gray-50 rounded-lg">
        <div><label for="santri-rapor" class="block text-sm font-medium text-gray-700 mb-1">Pilih Santri</label> <select id="santri-rapor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Santri --</option> </select>
        </div>
        <div class="grid grid-cols-2 gap-4">
         <div><label for="semester-rapor" class="block text-sm font-medium text-gray-700 mb-1">Semester</label> <select id="semester-rapor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Semester --</option> <option value="1">Semester 1</option> <option value="2">Semester 2</option> </select>
         </div>
         <div><label for="tahun-ajaran-rapor" class="block text-sm font-medium text-gray-700 mb-1">Tahun Ajaran</label> <select id="tahun-ajaran-rapor" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"> <option value="">-- Pilih Tahun Ajaran --</option> </select>
         </div>
        </div><button type="submit" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-eye mr-2"></i>Tampilkan Rapor </button>
       </form>
       <div id="preview-rapor-semester" class="hidden">
        <div class="flex justify-end mb-4"><button onclick="cetakRaporSemester()" class="bg-green-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-green-700"> <i class="fas fa-print mr-2"></i>Cetak PDF </button>
        </div>
        <div id="content-rapor-semester" class="bg-white border border-gray-300 rounded-lg p-8"></div>
       </div>
      </div>
     </div>
    </div><!-- Kelola Sesi Page -->
    <div id="page-kelola-sesi" class="page-content hidden">
     <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-clock mr-2 text-indigo-600"></i>Tambah Sesi</h3>
      <form id="form-sesi" class="space-y-4">
       <div><label for="nama-sesi" class="block text-sm font-medium text-gray-700 mb-1">Nama Sesi</label> <input type="text" id="nama-sesi" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
       </div>
       <div class="grid grid-cols-2 gap-4">
        <div><label for="jam-mulai" class="block text-sm font-medium text-gray-700 mb-1">Jam Mulai</label> <input type="time" id="jam-mulai" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
        <div><label for="jam-selesai" class="block text-sm font-medium text-gray-700 mb-1">Jam Selesai</label> <input type="time" id="jam-selesai" required class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
        </div>
       </div><button type="submit" id="btn-submit-sesi" class="bg-indigo-600 text-white px-6 py-2 rounded-lg font-medium hover:bg-indigo-700"> <i class="fas fa-save mr-2"></i>Simpan Sesi </button>
      </form>
     </div>
     <div class="bg-white rounded-lg shadow-lg p-6">
      <h3 class="text-xl font-bold text-gray-800 mb-4"><i class="fas fa-list mr-2 text-indigo-600"></i>Daftar Sesi</h3>
      <div id="list-sesi" class="space-y-3"></div>
     </div>
    </div>
   </div>
  </div>
  <script type="module">
    let pembimbingData = [];
    let santriData = [];
    let tahunAjaranData = [];
    let sesiData = [];
    let currentPembimbingId = null;
    
    const defaultConfig = {
      app_title: 'Sistem Monitoring Hafalan Santri',
      madrasah_name: "Ma'had Abu Bakar Ash-Shiddiq Anabanua"
    };

    async function onConfigChange(config) {
      document.getElementById('app-title').textContent = config.app_title || defaultConfig.app_title;
      document.getElementById('madrasah-name').textContent = config.madrasah_name || defaultConfig.madrasah_name;
    }

    async function init() {
      if (window.elementSdk) {
        window.elementSdk.init({
          defaultConfig,
          onConfigChange,
          mapToCapabilities: (config) => ({
            recolorables: [],
            borderables: [],
            fontEditable: undefined,
            fontSizeable: undefined
          }),
          mapToEditPanelValues: (config) => new Map([
            ['app_title', config.app_title || defaultConfig.app_title],
            ['madrasah_name', config.madrasah_name || defaultConfig.madrasah_name]
          ])
        });
      }
      
      setTodayDates();
      await loadAllData();
    }

    async function loadAllData() {
      try {
        const pembimbingSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'pembimbing'));
        pembimbingData = pembimbingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const santriSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'santri'));
        santriData = santriSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const tahunSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahun_ajaran'));
        tahunAjaranData = tahunSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        const sesiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'sesi'));
        sesiData = sesiSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        
        updateDashboard();
        updatePembimbingList();
        updatePembimbingCards();
        updateTahunAjaranList();
        updateSesiList();
        updateSesiDropdown();
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function setTodayDates() {
      const today = new Date().toISOString().split('T')[0];
      const dateInputs = ['tanggal-hafalan', 'tanggal-tahsin', 'tanggal-murajaah', 'tanggal-hadits', 'tanggal-mutabaah', 'tanggal-absensi', 'tanggal-tasmi'];
      dateInputs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = today;
      });
    }

    function showToast(message, type = 'success') {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      const bgColor = type === 'success' ? 'bg-green-600' : 'bg-red-600';
      toast.className = `toast ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
        <span>${message}</span>
      `;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    window.showPage = function(pageName) {
      document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
      document.getElementById(`page-${pageName}`).classList.remove('hidden');
      
      document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('bg-indigo-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
      });
      event.target.closest('.nav-btn').classList.remove('bg-gray-200', 'text-gray-700');
      event.target.closest('.nav-btn').classList.add('bg-indigo-600', 'text-white');
      
      hideSubMenu();
    };

    window.showSubMenu = function(menuName) {
      document.querySelectorAll('.submenu-content').forEach(m => m.classList.add('hidden'));
      document.getElementById(`submenu-${menuName}`).classList.remove('hidden');
      
      if (menuName === 'kelola-santri') {
        updateSantriList();
      }
    };

    window.hideSubMenu = function() {
      document.querySelectorAll('.submenu-content').forEach(m => m.classList.add('hidden'));
    };

    function updateDashboard() {
      document.getElementById('total-pembimbing').textContent = pembimbingData.length;
      document.getElementById('total-santri').textContent = santriData.length;
      
      if (santriData.length > 0) {
        const totalJuz = santriData.reduce((sum, s) => sum + (s.total_hafalan_juz || 0), 0);
        const avgJuz = (totalJuz / santriData.length).toFixed(1);
        document.getElementById('avg-hafalan').textContent = `${avgJuz} Juz`;
      } else {
        document.getElementById('avg-hafalan').textContent = '0 Juz';
      }
    }

    function updatePembimbingList() {
      const container = document.getElementById('list-pembimbing');
      
      if (pembimbingData.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data pembimbing</p>';
        return;
      }
      
      container.innerHTML = pembimbingData.map(p => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div>
            <p class="font-medium text-gray-800">${p.nama_pembimbing}</p>
            <p class="text-sm text-gray-600">Halaqah: ${p.nama_halaqah}</p>
          </div>
          <div class="flex space-x-2">
            <button onclick="editPembimbing('${p.id}')" class="text-blue-600 hover:text-blue-800 px-3 py-1 rounded-lg hover:bg-blue-50">
              <i class="fas fa-edit"></i>
            </button>
            <button onclick="deletePembimbing('${p.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 rounded-lg hover:bg-red-50">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </div>
      `).join('');
    }

    function updatePembimbingCards() {
      const container = document.getElementById('pembimbing-cards');
      
      if (pembimbingData.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-8 col-span-3">Belum ada data pembimbing. Silakan tambahkan pembimbing terlebih dahulu.</p>';
        return;
      }
      
      container.innerHTML = pembimbingData.map(p => `
        <div onclick="selectPembimbing('${p.id}')" class="pembimbing-card bg-white rounded-lg shadow-lg p-6 border-2 border-gray-200" data-pembimbing-id="${p.id}">
          <div class="flex items-center space-x-4">
            <div class="bg-indigo-100 p-4 rounded-full">
              <i class="fas fa-chalkboard-teacher text-2xl text-indigo-600"></i>
            </div>
            <div>
              <p class="font-bold text-gray-800 card-text">${p.nama_pembimbing}</p>
              <p class="text-sm text-gray-600 card-text">Halaqah: ${p.nama_halaqah}</p>
            </div>
          </div>
        </div>
      `).join('');
    }

    window.selectPembimbing = function(pembimbingId) {
      currentPembimbingId = pembimbingId;
      
      document.querySelectorAll('.pembimbing-card').forEach(card => {
        card.classList.remove('active');
      });
      
      const selectedCard = document.querySelector(`[data-pembimbing-id="${pembimbingId}"]`);
      if (selectedCard) {
        selectedCard.classList.add('active');
      }
      
      document.getElementById('pembimbing-menu').classList.remove('hidden');
      updateSantriDropdowns();
    };

    function updateTahunAjaranList() {
      const select = document.getElementById('filter-tahun-ajaran');
      const selectRapor = document.getElementById('tahun-ajaran-rapor');
      
      const options = '<option value="">-- Semua Tahun Ajaran --</option>' + 
        tahunAjaranData.map(t => `<option value="${t.tahun_ajaran}">${t.tahun_ajaran}</option>`).join('');
      
      const optionsRapor = '<option value="">-- Pilih Tahun Ajaran --</option>' + 
        tahunAjaranData.map(t => `<option value="${t.tahun_ajaran}">${t.tahun_ajaran}</option>`).join('');
      
      if (select) select.innerHTML = options;
      if (selectRapor) selectRapor.innerHTML = optionsRapor;
    }

    function updateSantriList() {
      const container = document.getElementById('list-santri');
      const santri = santriData.filter(s => s.id_pembimbing === currentPembimbingId);
      
      if (santri.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data santri untuk pembimbing ini</p>';
        return;
      }
      
      container.innerHTML = santri.map(s => `
        <div class="p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1">
              <p class="font-medium text-gray-800">${s.nama_santri}</p>
              <p class="text-sm text-gray-600">NIS: ${s.nis} | Kelas: ${s.kelas}</p>
            </div>
            <button onclick="deleteSantri('${s.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 rounded-lg hover:bg-red-50">
              <i class="fas fa-trash"></i>
            </button>
          </div>
          <div class="grid grid-cols-2 gap-2 text-sm">
            <p class="text-gray-600">Wali: ${s.nama_wali}</p>
            <p class="text-gray-600">Hafalan: ${s.total_hafalan_juz} Juz ${s.total_hafalan_halaman} Hal</p>
            <p class="text-gray-600">Hadits: ${s.total_hadits}</p>
          </div>
        </div>
      `).join('');
    }

    function updateSantriDropdowns() {
      if (!currentPembimbingId) return;
      
      const santri = santriData.filter(s => s.id_pembimbing === currentPembimbingId);
      const options = '<option value="">-- Pilih Santri --</option>' + 
        santri.map(s => `<option value="${s.id}">${s.nama_santri}</option>`).join('');
      
      const dropdowns = ['santri-hafalan', 'santri-tahsin', 'santri-murajaah', 'santri-hadits', 'santri-mutabaah', 'santri-tasmi', 'santri-laporan-pekanan', 'santri-laporan-bulanan', 'santri-rapor'];
      dropdowns.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = options;
      });
    }

    function updateSesiList() {
      const container = document.getElementById('list-sesi');
      
      if (sesiData.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada data sesi</p>';
        return;
      }
      
      container.innerHTML = sesiData.map(s => `
        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
          <div>
            <p class="font-medium text-gray-800">${s.nama_sesi}</p>
            <p class="text-sm text-gray-600">${s.jam_mulai} - ${s.jam_selesai}</p>
          </div>
          <button onclick="deleteSesi('${s.id}')" class="text-red-600 hover:text-red-800 px-3 py-1 rounded-lg hover:bg-red-50">
            <i class="fas fa-trash"></i>
          </button>
        </div>
      `).join('');
    }

    function updateSesiDropdown() {
      const select = document.getElementById('sesi-absensi');
      
      select.innerHTML = '<option value="">-- Pilih Sesi --</option>' + 
        sesiData.map(s => `<option value="${s.nama_sesi}">${s.nama_sesi} (${s.jam_mulai} - ${s.jam_selesai})</option>`).join('');
    }

    document.getElementById('form-pembimbing').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-pembimbing');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'pembimbing'), {
          nama_pembimbing: document.getElementById('nama-pembimbing').value,
          nama_halaqah: document.getElementById('nama-halaqah').value
        });
        
        showToast('Pembimbing berhasil ditambahkan');
        e.target.reset();
        await loadAllData();
      } catch (error) {
        showToast('Gagal menambahkan pembimbing', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    window.editPembimbing = function(id) {
      const pembimbing = pembimbingData.find(p => p.id === id);
      if (!pembimbing) return;
      
      document.getElementById('edit-pembimbing-id').value = id;
      document.getElementById('edit-nama-pembimbing').value = pembimbing.nama_pembimbing;
      document.getElementById('edit-nama-halaqah').value = pembimbing.nama_halaqah;
      document.getElementById('edit-modal').classList.remove('hidden');
    };

    window.closeEditModal = function() {
      document.getElementById('edit-modal').classList.add('hidden');
      document.getElementById('form-edit-pembimbing').reset();
    };

    document.getElementById('form-edit-pembimbing').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-update-pembimbing');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        const id = document.getElementById('edit-pembimbing-id').value;
        const docRef = window.firestore.doc(window.db, 'pembimbing', id);
        
        await window.firestore.updateDoc(docRef, {
          nama_pembimbing: document.getElementById('edit-nama-pembimbing').value,
          nama_halaqah: document.getElementById('edit-nama-halaqah').value
        });
        
        showToast('Pembimbing berhasil diupdate');
        closeEditModal();
        await loadAllData();
      } catch (error) {
        showToast('Gagal mengupdate pembimbing', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    window.deletePembimbing = async function(id) {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-4">
          <p class="text-gray-800 mb-4">Yakin ingin menghapus pembimbing ini?</p>
          <div class="flex space-x-2">
            <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
            <button id="confirm-delete" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Hapus</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirm-delete').addEventListener('click', async () => {
        try {
          await window.firestore.deleteDoc(window.firestore.doc(window.db, 'pembimbing', id));
          showToast('Pembimbing berhasil dihapus');
          await loadAllData();
        } catch (error) {
          showToast('Gagal menghapus pembimbing', 'error');
        }
        confirmDiv.remove();
      });
    };

    document.getElementById('form-santri').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      if (!currentPembimbingId) {
        showToast('Pilih pembimbing terlebih dahulu', 'error');
        return;
      }
      
      const btn = document.getElementById('btn-submit-santri');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'santri'), {
          id_pembimbing: currentPembimbingId,
          nis: document.getElementById('nis').value,
          nama_santri: document.getElementById('nama-santri').value,
          kelas: document.getElementById('kelas').value,
          nama_wali: document.getElementById('nama-wali').value,
          total_hafalan_juz: parseInt(document.getElementById('hafalan-juz').value),
          total_hafalan_halaman: parseInt(document.getElementById('hafalan-halaman').value),
          total_hadits: parseInt(document.getElementById('total-hadits').value)
        });
        
        showToast('Santri berhasil ditambahkan');
        e.target.reset();
        await loadAllData();
        updateSantriList();
      } catch (error) {
        showToast('Gagal menambahkan santri', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    window.deleteSantri = async function(id) {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-4">
          <p class="text-gray-800 mb-4">Yakin ingin menghapus santri ini?</p>
          <div class="flex space-x-2">
            <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
            <button id="confirm-delete-santri" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Hapus</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirm-delete-santri').addEventListener('click', async () => {
        try {
          await window.firestore.deleteDoc(window.firestore.doc(window.db, 'santri', id));
          showToast('Santri berhasil dihapus');
          await loadAllData();
          updateSantriList();
        } catch (error) {
          showToast('Gagal menghapus santri', 'error');
        }
        confirmDiv.remove();
      });
    };

    document.getElementById('form-tahun-ajaran').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-tahun');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'tahun_ajaran'), {
          tahun_ajaran: document.getElementById('tahun-ajaran').value
        });
        
        showToast('Tahun ajaran berhasil ditambahkan');
        e.target.reset();
        await loadAllData();
      } catch (error) {
        showToast('Gagal menambahkan tahun ajaran', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-hafalan-baru').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-hafalan');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'hafalan_baru'), {
          id_pembimbing: currentPembimbingId,
          id_santri: document.getElementById('santri-hafalan').value,
          tanggal: document.getElementById('tanggal-hafalan').value,
          juz: parseInt(document.getElementById('juz-hafalan').value),
          halaman: parseInt(document.getElementById('halaman-hafalan').value),
          nilai: document.getElementById('nilai-hafalan').value
        });
        
        showToast('Hafalan berhasil disimpan');
        e.target.reset();
        setTodayDates();
      } catch (error) {
        showToast('Gagal menyimpan hafalan', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-tahsin').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-tahsin');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'tahsin'), {
          id_pembimbing: currentPembimbingId,
          id_santri: document.getElementById('santri-tahsin').value,
          tanggal: document.getElementById('tanggal-tahsin').value,
          kategori: document.getElementById('kategori-tahsin').value,
          nilai: document.getElementById('nilai-tahsin').value
        });
        
        showToast('Tahsin berhasil disimpan');
        e.target.reset();
        setTodayDates();
      } catch (error) {
        showToast('Gagal menyimpan tahsin', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-murajaah').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-murajaah');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'murajaah'), {
          id_pembimbing: currentPembimbingId,
          id_santri: document.getElementById('santri-murajaah').value,
          tanggal: document.getElementById('tanggal-murajaah').value,
          juz: parseInt(document.getElementById('juz-murajaah').value),
          halaman: parseInt(document.getElementById('halaman-murajaah').value),
          nilai: document.getElementById('nilai-murajaah').value
        });
        
        showToast('Murajaah berhasil disimpan');
        e.target.reset();
        setTodayDates();
      } catch (error) {
        showToast('Gagal menyimpan murajaah', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-hadits').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-hadits');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'hadits'), {
          id_pembimbing: currentPembimbingId,
          id_santri: document.getElementById('santri-hadits').value,
          tanggal: document.getElementById('tanggal-hadits').value,
          hadits_ke: parseInt(document.getElementById('hadits-ke').value),
          nilai: document.getElementById('nilai-hadits').value
        });
        
        showToast('Hadits berhasil disimpan');
        e.target.reset();
        setTodayDates();
      } catch (error) {
        showToast('Gagal menyimpan hadits', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-mutabaah').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const checkCount = ['check-subuh', 'check-zhuhur', 'check-ashar', 'check-maghrib', 'check-isya', 'check-dhuha', 'check-qiyam', 'check-rawatib', 'check-dzikir', 'check-puasa', 'check-hafalan-hadits']
        .filter(id => document.getElementById(id).checked).length;
      
      let nilai = 'D';
      if (checkCount >= 9) nilai = 'A';
      else if (checkCount >= 6) nilai = 'B';
      else if (checkCount >= 3) nilai = 'C';
      
      const btn = document.getElementById('btn-submit-mutabaah');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'mutabaah'), {
          id_pembimbing: currentPembimbingId,
          id_santri: document.getElementById('santri-mutabaah').value,
          tanggal: document.getElementById('tanggal-mutabaah').value,
          shalat_subuh: document.getElementById('check-subuh').checked,
          shalat_zhuhur: document.getElementById('check-zhuhur').checked,
          shalat_ashar: document.getElementById('check-ashar').checked,
          shalat_maghrib: document.getElementById('check-maghrib').checked,
          shalat_isya: document.getElementById('check-isya').checked,
          shalat_dhuha: document.getElementById('check-dhuha').checked,
          qiyamul_lail: document.getElementById('check-qiyam').checked,
          rawatib: document.getElementById('check-rawatib').checked,
          dzikir: document.getElementById('check-dzikir').checked,
          puasa_sunnah: document.getElementById('check-puasa').checked,
          hafalan_hadits: document.getElementById('check-hafalan-hadits').checked,
          nilai: nilai
        });
        
        showToast(`Mutaba'ah berhasil disimpan dengan nilai ${nilai}`);
        e.target.reset();
        setTodayDates();
      } catch (error) {
        showToast("Gagal menyimpan mutaba'ah", 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    window.loadAbsensiSantri = function() {
      const tanggal = document.getElementById('tanggal-absensi').value;
      const sesi = document.getElementById('sesi-absensi').value;
      
      if (!tanggal || !sesi) {
        showToast('Pilih tanggal dan sesi terlebih dahulu', 'error');
        return;
      }
      
      const santri = santriData.filter(s => s.id_pembimbing === currentPembimbingId);
      const container = document.getElementById('list-absensi');
      
      if (santri.length === 0) {
        container.innerHTML = '<p class="text-gray-500 text-center py-4">Belum ada santri</p>';
        return;
      }
      
      container.innerHTML = santri.map(s => `
        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-200">
          <span class="text-gray-800">${s.nama_santri}</span>
          <div class="flex space-x-2">
            <label class="flex items-center space-x-1">
              <input type="radio" name="absensi_${s.id}" value="H" class="text-green-600 focus:ring-green-500">
              <span class="text-sm text-green-600">H</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="radio" name="absensi_${s.id}" value="I" class="text-blue-600 focus:ring-blue-500">
              <span class="text-sm text-blue-600">I</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="radio" name="absensi_${s.id}" value="S" class="text-yellow-600 focus:ring-yellow-500">
              <span class="text-sm text-yellow-600">S</span>
            </label>
            <label class="flex items-center space-x-1">
              <input type="radio" name="absensi_${s.id}" value="A" class="text-red-600 focus:ring-red-500">
              <span class="text-sm text-red-600">A</span>
            </label>
          </div>
        </div>
      `).join('');
      
      document.getElementById('btn-simpan-absensi').classList.remove('hidden');
    };

    window.simpanAbsensi = async function() {
      const tanggal = document.getElementById('tanggal-absensi').value;
      const sesi = document.getElementById('sesi-absensi').value;
      const santri = santriData.filter(s => s.id_pembimbing === currentPembimbingId);
      
      const btn = document.getElementById('btn-simpan-absensi');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        for (const s of santri) {
          const radio = document.querySelector(`input[name="absensi_${s.id}"]:checked`);
          if (radio) {
            await window.firestore.addDoc(window.firestore.collection(window.db, 'absensi'), {
              id_pembimbing: currentPembimbingId,
              id_santri: s.id,
              tanggal: tanggal,
              sesi: sesi,
              status: radio.value
            });
          }
        }
        
        showToast('Absensi berhasil disimpan');
        document.getElementById('list-absensi').innerHTML = '';
        document.getElementById('btn-simpan-absensi').classList.add('hidden');
      } catch (error) {
        showToast('Gagal menyimpan absensi', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    };

    document.getElementById('form-tasmi').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-tasmi');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'tasmi'), {
          id_pembimbing: currentPembimbingId,
          id_santri: document.getElementById('santri-tasmi').value,
          tanggal: document.getElementById('tanggal-tasmi').value,
          juz_tasmi: document.getElementById('juz-tasmi').value,
          nilai: document.getElementById('nilai-tasmi').value
        });
        
        showToast("Tasmi' berhasil disimpan");
        e.target.reset();
        setTodayDates();
      } catch (error) {
        showToast("Gagal menyimpan tasmi'", 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    document.getElementById('form-sesi').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const btn = document.getElementById('btn-submit-sesi');
      btn.classList.add('btn-loading');
      btn.disabled = true;
      
      try {
        await window.firestore.addDoc(window.firestore.collection(window.db, 'sesi'), {
          nama_sesi: document.getElementById('nama-sesi').value,
          jam_mulai: document.getElementById('jam-mulai').value,
          jam_selesai: document.getElementById('jam-selesai').value
        });
        
        showToast('Sesi berhasil ditambahkan');
        e.target.reset();
        await loadAllData();
      } catch (error) {
        showToast('Gagal menambahkan sesi', 'error');
      }
      
      btn.classList.remove('btn-loading');
      btn.disabled = false;
    });

    window.deleteSesi = async function(id) {
      const confirmDiv = document.createElement('div');
      confirmDiv.className = 'fixed inset-0 z-50 flex items-center justify-center modal-backdrop';
      confirmDiv.innerHTML = `
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-4">
          <p class="text-gray-800 mb-4">Yakin ingin menghapus sesi ini?</p>
          <div class="flex space-x-2">
            <button onclick="this.closest('.modal-backdrop').remove()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400">Batal</button>
            <button id="confirm-delete-sesi" class="flex-1 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">Hapus</button>
          </div>
        </div>
      `;
      document.body.appendChild(confirmDiv);
      
      document.getElementById('confirm-delete-sesi').addEventListener('click', async () => {
        try {
          await window.firestore.deleteDoc(window.firestore.doc(window.db, 'sesi', id));
          showToast('Sesi berhasil dihapus');
          await loadAllData();
        } catch (error) {
          showToast('Gagal menghapus sesi', 'error');
        }
        confirmDiv.remove();
      });
    };

    // Form Laporan Pekanan
    document.getElementById('form-laporan-pekanan').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const santriId = document.getElementById('santri-laporan-pekanan').value;
      const tanggalMulai = document.getElementById('tanggal-mulai-pekanan').value;
      const tanggalSelesai = document.getElementById('tanggal-selesai-pekanan').value;
      
      const santri = santriData.find(s => s.id === santriId);
      if (!santri) {
        showToast('Data santri tidak ditemukan', 'error');
        return;
      }
      
      const pembimbing = pembimbingData.find(p => p.id === santri.id_pembimbing);
      if (!pembimbing) {
        showToast('Data pembimbing tidak ditemukan', 'error');
        return;
      }
      
      try {
        const hafalanSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hafalan_baru'));
        const tahsinSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahsin'));
        const murajaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'murajaah'));
        const mutabaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'mutabaah'));
        const haditsSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hadits'));
        const absensiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'absensi'));
        const tasmiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tasmi'));
        
        const hafalan = hafalanSnapshot.docs.map(doc => doc.data()).filter(h => 
          h.id_santri === santriId && h.tanggal >= tanggalMulai && h.tanggal <= tanggalSelesai
        );
        
        const tahsin = tahsinSnapshot.docs.map(doc => doc.data()).filter(t => 
          t.id_santri === santriId && t.tanggal >= tanggalMulai && t.tanggal <= tanggalSelesai
        );
        
        const murajaah = murajaahSnapshot.docs.map(doc => doc.data()).filter(m => 
          m.id_santri === santriId && m.tanggal >= tanggalMulai && m.tanggal <= tanggalSelesai
        );
        
        const mutabaah = mutabaahSnapshot.docs.map(doc => doc.data()).filter(m => 
          m.id_santri === santriId && m.tanggal >= tanggalMulai && m.tanggal <= tanggalSelesai
        );
        
        const hadits = haditsSnapshot.docs.map(doc => doc.data()).filter(h => 
          h.id_santri === santriId && h.tanggal >= tanggalMulai && h.tanggal <= tanggalSelesai
        );
        
        const absensi = absensiSnapshot.docs.map(doc => doc.data()).filter(a => 
          a.id_santri === santriId && a.tanggal >= tanggalMulai && a.tanggal <= tanggalSelesai
        );
        
        const tasmi = tasmiSnapshot.docs.map(doc => doc.data()).filter(t => 
          t.id_santri === santriId && t.tanggal >= tanggalMulai && t.tanggal <= tanggalSelesai
        );
        
        const hadir = absensi.filter(a => a.status === 'H').length;
        const izin = absensi.filter(a => a.status === 'I').length;
        const sakit = absensi.filter(a => a.status === 'S').length;
        const alpha = absensi.filter(a => a.status === 'A').length;
        
        // Fungsi hitung nilai rata-rata dan persentase
        const hitungNilai = (data) => {
          if (data.length === 0) return { nilai: '-', persentase: '0%' };
          const nilaiMap = { 'A': 100, 'B': 85, 'C': 70, 'D': 55 };
          const total = data.reduce((sum, item) => sum + (nilaiMap[item.nilai] || 0), 0);
          const rata = total / data.length;
          let nilaiHuruf = 'D';
          if (rata >= 92.5) nilaiHuruf = 'A';
          else if (rata >= 77.5) nilaiHuruf = 'B';
          else if (rata >= 62.5) nilaiHuruf = 'C';
          return { nilai: nilaiHuruf, persentase: rata.toFixed(1) + '%' };
        };
        
        const nilaiHafalan = hitungNilai(hafalan);
        const nilaiTahsin = hitungNilai(tahsin);
        const nilaiMurajaah = hitungNilai(murajaah);
        const nilaiHadits = hitungNilai(hadits);
        const nilaiMutabaah = hitungNilai(mutabaah);
        const nilaiTasmi = hitungNilai(tasmi);
        
        // Hitung persentase kehadiran
        const totalHari = hadir + izin + sakit + alpha;
        const persenKehadiran = totalHari > 0 ? ((hadir / totalHari) * 100).toFixed(1) + '%' : '0%';
        
        // Hitung jumlah halaman baru yang ditambahkan (jumlah record hafalan)
        const jumlahHalamanBaru = hafalan.length;
        
        // Hitung total hadits baru dalam periode
        const totalHaditsBaru = hadits.length;
        
        // Hitung total hafalan keseluruhan dengan benar
        // Konversi hafalan awal ke total halaman
        const halamanAwal = ((santri.total_hafalan_juz || 0) * 20) + (santri.total_hafalan_halaman || 0);
        const totalHalamanKeseluruhan = halamanAwal + jumlahHalamanBaru;
        const totalJuzKeseluruhan = Math.floor(totalHalamanKeseluruhan / 20);
        const sisaHalaman = totalHalamanKeseluruhan % 20;
        
        const totalHaditsKeseluruhan = (santri.total_hadits || 0) + totalHaditsBaru;
        
        // Generate catatan otomatis berdasarkan capaian
        let catatan = '';
        if (jumlahHalamanBaru >= 7) {
          catatan = 'Alhamdulillah, pencapaian hafalan sangat baik dan konsisten. Pertahankan semangat dan istiqomah dalam menghafal. Tingkatkan kualitas bacaan dan pemahaman makna ayat.';
        } else if (jumlahHalamanBaru >= 4) {
          catatan = 'Mashaa Allah, progress hafalan cukup baik. Terus tingkatkan target hafalan dan jaga konsistensi murajaah agar hafalan tidak mudah lupa.';
        } else if (jumlahHalamanBaru >= 1) {
          catatan = 'Progress hafalan masih perlu ditingkatkan. Lebih fokus dan konsisten dalam menambah hafalan baru. Perbanyak murajaah hafalan lama.';
        } else {
          catatan = 'Belum ada penambahan hafalan di periode ini. Perlu peningkatan motivasi dan konsistensi dalam menghafal. Konsultasikan kendala dengan pembimbing.';
        }
        
        // Tambahan catatan untuk kehadiran
        if (totalHari > 0) {
          const rataKehadiran = (hadir / totalHari) * 100;
          if (rataKehadiran >= 90) {
            catatan += ' Kehadiran sangat baik, pertahankan kedisiplinan.';
          } else if (rataKehadiran >= 75) {
            catatan += ' Kehadiran cukup baik, usahakan lebih konsisten hadir.';
          } else {
            catatan += ' Kehadiran perlu ditingkatkan untuk mendukung progress hafalan.';
          }
        }
        
        const content = `
          <div style="font-family: 'Times New Roman', serif; color: #000; background: #fff; padding: 0; margin: 0;">
            <div style="text-align: center; margin-bottom: 25px; border-bottom: 3px double #000; padding-bottom: 15px;">
              <div style="margin-bottom: 12px;">
                <img src="https://ypwi.or.id/assets/setting/front/meta/image.png" alt="Logo" style="width: 90px; height: 90px; object-fit: contain; display: block; margin: 0 auto;">
              </div>
              <h1 style="margin: 8px 0; font-size: 20px; font-weight: bold; letter-spacing: 1px; text-transform: uppercase;">LAPORAN PERKEMBANGAN PEKANAN</h1>
              <h2 style="margin: 8px 0; font-size: 17px; font-weight: normal;">${defaultConfig.madrasah_name}</h2>
              <p style="margin: 5px 0; font-size: 11px; line-height: 1.4;">Jl. Poros Palopo Makassar, Desa Mattirowalie, Kec. Maniangpajo, Kab. Wajo, Sulawesi Selatan</p>
              <p style="margin: 10px 0 0 0; font-size: 13px; font-weight: bold;">Periode: ${tanggalMulai} s/d ${tanggalSelesai}</p>
            </div>
            
            <div style="margin-bottom: 25px;">
              <table style="width: 100%; border-collapse: collapse; font-size: 13px; line-height: 1.8;">
                <tr>
                  <td style="padding: 6px 0; width: 180px; vertical-align: top;">Nama Santri</td>
                  <td style="padding: 6px 0; width: 15px; vertical-align: top;">:</td>
                  <td style="padding: 6px 0; vertical-align: top; font-weight: bold;">${santri.nama_santri}</td>
                </tr>
                <tr>
                  <td style="padding: 6px 0; vertical-align: top;">NIS</td>
                  <td style="padding: 6px 0; vertical-align: top;">:</td>
                  <td style="padding: 6px 0; vertical-align: top;">${santri.nis}</td>
                </tr>
                <tr>
                  <td style="padding: 6px 0; vertical-align: top;">Kelas</td>
                  <td style="padding: 6px 0; vertical-align: top;">:</td>
                  <td style="padding: 6px 0; vertical-align: top;">${santri.kelas}</td>
                </tr>
                <tr>
                  <td style="padding: 6px 0; vertical-align: top;">Pembimbing</td>
                  <td style="padding: 6px 0; vertical-align: top;">:</td>
                  <td style="padding: 6px 0; vertical-align: top;">${pembimbing.nama_pembimbing}</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px 12px; margin: 0 0 0 0; font-size: 14px; font-weight: bold; letter-spacing: 0.5px;">REKAP NILAI PEMBELAJARAN</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 12px; page-break-inside: avoid;">
                <thead>
                  <tr style="background: #e8e8e8;">
                    <th style="border: 1px solid #000; padding: 10px; text-align: left;">Aspek Penilaian</th>
                    <th style="border: 1px solid #000; padding: 10px; width: 100px; text-align: center;">Nilai</th>
                    <th style="border: 1px solid #000; padding: 10px; width: 120px; text-align: center;">Persentase</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">Hafalan Baru</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${nilaiHafalan.nilai}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${nilaiHafalan.persentase}</td>
                  </tr>
                  <tr style="background: #f9f9f9;">
                    <td style="border: 1px solid #000; padding: 8px;">Tahsin</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${nilaiTahsin.nilai}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${nilaiTahsin.persentase}</td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">Murajaah</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${nilaiMurajaah.nilai}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${nilaiMurajaah.persentase}</td>
                  </tr>
                  <tr style="background: #f9f9f9;">
                    <td style="border: 1px solid #000; padding: 8px;">Hafalan Hadits</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${nilaiHadits.nilai}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${nilaiHadits.persentase}</td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">Mutaba'ah Yaumiyah</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${nilaiMutabaah.nilai}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${nilaiMutabaah.persentase}</td>
                  </tr>
                  <tr style="background: #f9f9f9;">
                    <td style="border: 1px solid #000; padding: 8px;">Tasmi' (Setoran Juz)</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${nilaiTasmi.nilai}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${nilaiTasmi.persentase}</td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">Kehadiran</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${hadir}/${totalHari}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${persenKehadiran}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div style="margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px 12px; margin: 0 0 0 0; font-size: 14px; font-weight: bold; letter-spacing: 0.5px;">HAFALAN BARU DALAM PERIODE (${hafalan.length} Halaman)</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 12px; page-break-inside: avoid;">
                <thead>
                  <tr style="background: #e8e8e8;">
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Tanggal</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Juz</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Halaman</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  ${hafalan.length > 0 ? hafalan.map((h, idx) => `
                    <tr style="${idx % 2 === 0 ? 'background: #f9f9f9;' : 'background: #fff;'}">
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${h.tanggal}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${h.juz}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${h.halaman}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${h.nilai}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="4" style="border: 1px solid #000; padding: 12px; text-align: center; font-style: italic; color: #666;">Tidak ada data hafalan dalam periode ini</td></tr>'}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 30px; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px 12px; margin: 0 0 0 0; font-size: 14px; font-weight: bold; letter-spacing: 0.5px;">TAHSIN (${tahsin.length} kali)</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 12px; page-break-inside: avoid;">
                <thead>
                  <tr style="background: #e8e8e8;">
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Tanggal</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Kategori</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  ${tahsin.length > 0 ? tahsin.map((t, idx) => `
                    <tr style="${idx % 2 === 0 ? 'background: #f9f9f9;' : 'background: #fff;'}">
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${t.tanggal}</td>
                      <td style="border: 1px solid #000; padding: 8px;">${t.kategori}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${t.nilai}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="3" style="border: 1px solid #000; padding: 12px; text-align: center; font-style: italic; color: #666;">Tidak ada data tahsin dalam periode ini</td></tr>'}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 30px; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px 12px; margin: 0 0 0 0; font-size: 14px; font-weight: bold; letter-spacing: 0.5px;">MURAJAAH (${murajaah.length} kali)</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 12px; page-break-inside: avoid;">
                <thead>
                  <tr style="background: #e8e8e8;">
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Tanggal</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Juz</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Halaman</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  ${murajaah.length > 0 ? murajaah.map((m, idx) => `
                    <tr style="${idx % 2 === 0 ? 'background: #f9f9f9;' : 'background: #fff;'}">
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${m.tanggal}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${m.juz}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${m.halaman}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${m.nilai}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="4" style="border: 1px solid #000; padding: 12px; text-align: center; font-style: italic; color: #666;">Tidak ada data murajaah dalam periode ini</td></tr>'}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 30px; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px 12px; margin: 0 0 0 0; font-size: 14px; font-weight: bold; letter-spacing: 0.5px;">HAFALAN HADITS (${hadits.length} Hadits)</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 12px; page-break-inside: avoid;">
                <thead>
                  <tr style="background: #e8e8e8;">
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Tanggal</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Hadits Ke-</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  ${hadits.length > 0 ? hadits.map((h, idx) => `
                    <tr style="${idx % 2 === 0 ? 'background: #f9f9f9;' : 'background: #fff;'}">
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${h.tanggal}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${h.hadits_ke}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${h.nilai}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="3" style="border: 1px solid #000; padding: 12px; text-align: center; font-style: italic; color: #666;">Tidak ada data hadits dalam periode ini</td></tr>'}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 30px; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px 12px; margin: 0 0 0 0; font-size: 14px; font-weight: bold; letter-spacing: 0.5px;">MUTABA'AH YAUMIYAH (${mutabaah.length} hari)</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 12px; page-break-inside: avoid;">
                <thead>
                  <tr style="background: #e8e8e8;">
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Tanggal</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  ${mutabaah.length > 0 ? mutabaah.map((m, idx) => `
                    <tr style="${idx % 2 === 0 ? 'background: #f9f9f9;' : 'background: #fff;'}">
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${m.tanggal}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${m.nilai}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="2" style="border: 1px solid #000; padding: 12px; text-align: center; font-style: italic; color: #666;">Tidak ada data mutaba\'ah dalam periode ini</td></tr>'}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 30px; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px 12px; margin: 0 0 0 0; font-size: 14px; font-weight: bold; letter-spacing: 0.5px;">TASMI' / SETORAN JUZ (${tasmi.length} kali)</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 12px; page-break-inside: avoid;">
                <thead>
                  <tr style="background: #e8e8e8;">
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Tanggal</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Juz yang Ditasmi'</th>
                    <th style="border: 1px solid #000; padding: 10px; font-weight: bold;">Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  ${tasmi.length > 0 ? tasmi.map((t, idx) => `
                    <tr style="${idx % 2 === 0 ? 'background: #f9f9f9;' : 'background: #fff;'}">
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${t.tanggal}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center;">${t.juz_tasmi}</td>
                      <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold;">${t.nilai}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="3" style="border: 1px solid #000; padding: 12px; text-align: center; font-style: italic; color: #666;">Tidak ada data tasmi\' dalam periode ini</td></tr>'}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 30px; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px 12px; margin: 0 0 0 0; font-size: 14px; font-weight: bold; letter-spacing: 0.5px;">REKAP ABSENSI</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 12px; page-break-inside: avoid;">
                <tr style="background: #f9f9f9;">
                  <td style="border: 1px solid #000; padding: 10px; width: 45%; background: #e0e0e0; font-weight: bold;">Hadir (H)</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: center;">${hadir} hari</td>
                </tr>
                <tr style="background: #fff;">
                  <td style="border: 1px solid #000; padding: 10px; background: #e0e0e0; font-weight: bold;">Izin (I)</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: center;">${izin} hari</td>
                </tr>
                <tr style="background: #f9f9f9;">
                  <td style="border: 1px solid #000; padding: 10px; background: #e0e0e0; font-weight: bold;">Sakit (S)</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: center;">${sakit} hari</td>
                </tr>
                <tr style="background: #fff;">
                  <td style="border: 1px solid #000; padding: 10px; background: #e0e0e0; font-weight: bold;">Alpha (A)</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: center;">${alpha} hari</td>
                </tr>
                <tr style="font-weight: bold; background: #d0d0d0;">
                  <td style="border: 2px solid #000; padding: 12px; font-weight: bold; font-size: 13px;">Persentase Kehadiran</td>
                  <td style="border: 2px solid #000; padding: 12px; text-align: center; font-weight: bold; font-size: 14px;">${persenKehadiran}</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-top: 30px; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px 12px; margin: 0 0 0 0; font-size: 14px; font-weight: bold; letter-spacing: 0.5px;">TOTAL HAFALAN KESELURUHAN</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 12px; page-break-inside: avoid;">
                <tr style="background: #f9f9f9;">
                  <td style="border: 1px solid #000; padding: 10px; width: 45%; font-weight: bold;">Hafalan Al-Qur'an Awal</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: center;">${santri.total_hafalan_juz} Juz ${santri.total_hafalan_halaman} Halaman</td>
                </tr>
                <tr style="background: #fff;">
                  <td style="border: 1px solid #000; padding: 10px; font-weight: bold;">Hafalan Periode Ini</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: center;">${jumlahHalamanBaru} Halaman</td>
                </tr>
                <tr style="font-weight: bold; background: #e0e0e0;">
                  <td style="border: 2px solid #000; padding: 12px; font-weight: bold; font-size: 13px;">TOTAL AL-QUR'AN</td>
                  <td style="border: 2px solid #000; padding: 12px; text-align: center; font-weight: bold; font-size: 14px;">${totalJuzKeseluruhan} Juz ${sisaHalaman} Halaman</td>
                </tr>
                <tr style="background: #f9f9f9;">
                  <td style="border: 1px solid #000; padding: 10px; font-weight: bold;">Hafalan Hadits Awal</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: center;">${santri.total_hadits} Hadits</td>
                </tr>
                <tr style="background: #fff;">
                  <td style="border: 1px solid #000; padding: 10px; font-weight: bold;">Hafalan Hadits Periode Ini</td>
                  <td style="border: 1px solid #000; padding: 10px; text-align: center;">${totalHaditsBaru} Hadits</td>
                </tr>
                <tr style="font-weight: bold; background: #e0e0e0;">
                  <td style="border: 2px solid #000; padding: 12px; font-weight: bold; font-size: 13px;">TOTAL HADITS</td>
                  <td style="border: 2px solid #000; padding: 12px; text-align: center; font-weight: bold; font-size: 14px;">${totalHaditsKeseluruhan} Hadits</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-top: 30px; margin-bottom: 25px; padding: 15px; background: #fff; border: 2px solid #000; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: bold; text-transform: uppercase;">Catatan dan Saran Pembimbing:</h3>
              <p style="margin: 0; font-size: 12px; text-align: justify; line-height: 1.8; color: #000;">${catatan}</p>
            </div>
            
            <div style="margin-top: 50px; page-break-inside: avoid; break-inside: avoid;">
              <table style="width: 100%; font-size: 12px;">
                <tr>
                  <td style="width: 50%; text-align: center; padding: 15px; vertical-align: top;">
                    <p style="margin: 0 0 80px 0; font-weight: normal;">Orang Tua/Wali</p>
                    <p style="margin: 0; font-weight: bold; border-top: 2px solid #000; display: inline-block; padding-top: 8px; min-width: 200px;">${santri.nama_wali}</p>
                  </td>
                  <td style="width: 50%; text-align: center; padding: 15px; vertical-align: top;">
                    <p style="margin: 0 0 80px 0; font-weight: normal;">Pembimbing</p>
                    <p style="margin: 0; font-weight: bold; border-top: 2px solid #000; display: inline-block; padding-top: 8px; min-width: 200px;">${pembimbing.nama_pembimbing}</p>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        `;
        
        document.getElementById('content-laporan-pekanan').innerHTML = content;
        document.getElementById('preview-laporan-pekanan').classList.remove('hidden');
        showToast('Laporan berhasil ditampilkan');
      } catch (error) {
        showToast('Gagal memuat laporan', 'error');
      }
    });

    // Form Laporan Bulanan
    document.getElementById('form-laporan-bulanan').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const santriId = document.getElementById('santri-laporan-bulanan').value;
      const bulan = document.getElementById('bulan-laporan').value;
      const tahun = document.getElementById('tahun-laporan').value;
      
      const santri = santriData.find(s => s.id === santriId);
      const pembimbing = pembimbingData.find(p => p.id === santri.id_pembimbing);
      if (!santri || !pembimbing) return;
      
      const bulanNama = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][parseInt(bulan)];
      
      try {
        const hafalanSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hafalan_baru'));
        const tahsinSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahsin'));
        const murajaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'murajaah'));
        const haditsSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hadits'));
        const mutabaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'mutabaah'));
        const absensiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'absensi'));
        
        const filterByMonth = (item) => {
          if (!item.tanggal) return false;
          const itemDate = new Date(item.tanggal);
          return item.id_santri === santriId && 
                 itemDate.getMonth() + 1 === parseInt(bulan) && 
                 itemDate.getFullYear() === parseInt(tahun);
        };
        
        const hafalan = hafalanSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        const tahsin = tahsinSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        const murajaah = murajaahSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        const hadits = haditsSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        const mutabaah = mutabaahSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        const absensi = absensiSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        
        const hadir = absensi.filter(a => a.status === 'H').length;
        const izin = absensi.filter(a => a.status === 'I').length;
        const sakit = absensi.filter(a => a.status === 'S').length;
        const alpha = absensi.filter(a => a.status === 'A').length;
        
        // Hitung jumlah halaman baru yang ditambahkan (bukan total halaman dalam periode)
        const jumlahHalamanBaru = hafalan.length;
        const totalHaditsBaru = hadits.length;
        
        // Hitung total keseluruhan dengan benar
        // Konversi hafalan awal ke total halaman
        const halamanAwal = ((santri.total_hafalan_juz || 0) * 20) + (santri.total_hafalan_halaman || 0);
        const totalHalamanKeseluruhan = halamanAwal + jumlahHalamanBaru;
        const totalJuzKeseluruhan = Math.floor(totalHalamanKeseluruhan / 20);
        const sisaHalaman = totalHalamanKeseluruhan % 20;
        
        const totalHaditsKeseluruhan = (santri.total_hadits || 0) + totalHaditsBaru;
        
        // Generate catatan otomatis bulanan
        let catatanBulanan = '';
        if (jumlahHalamanBaru >= 20) {
          catatanBulanan = 'MasyaaAllah tabarakallah! Pencapaian hafalan bulan ini sangat luar biasa dan menunjukkan dedikasi tinggi. Pertahankan konsistensi dan tingkatkan kualitas tajwid serta pemahaman makna ayat.';
        } else if (jumlahHalamanBaru >= 12) {
          catatanBulanan = 'Alhamdulillah, pencapaian hafalan bulan ini sangat baik. Terus jaga semangat dan istiqomah dalam menghafal. Perbanyak murajaah agar hafalan terjaga dengan baik.';
        } else if (jumlahHalamanBaru >= 6) {
          catatanBulanan = 'Pencapaian hafalan cukup baik, namun masih bisa ditingkatkan. Atur jadwal menghafal dengan lebih konsisten dan manfaatkan waktu dengan optimal.';
        } else if (jumlahHalamanBaru >= 1) {
          catatanBulanan = 'Pencapaian hafalan masih kurang optimal. Perlu peningkatan fokus dan konsistensi. Diskusikan kendala yang dihadapi dengan pembimbing untuk solusi yang tepat.';
        } else {
          catatanBulanan = 'Belum ada penambahan hafalan bulan ini. Sangat perlu peningkatan motivasi dan disiplin. Segera konsultasikan dengan pembimbing untuk evaluasi dan perbaikan strategi belajar.';
        }
        
        // Evaluasi murajaah
        if (murajaah.length >= 20) {
          catatanBulanan += ' Murajaah sangat baik dan konsisten.';
        } else if (murajaah.length >= 10) {
          catatanBulanan += ' Murajaah cukup baik, pertahankan.';
        } else if (murajaah.length >= 1) {
          catatanBulanan += ' Murajaah perlu ditingkatkan untuk menjaga kualitas hafalan.';
        }
        
        // Evaluasi kehadiran
        const totalHari = hadir + izin + sakit + alpha;
        if (totalHari > 0) {
          const persenKehadiran = (hadir / totalHari) * 100;
          if (persenKehadiran >= 90) {
            catatanBulanan += ' Kehadiran sangat baik, pertahankan kedisiplinan.';
          } else if (persenKehadiran >= 75) {
            catatanBulanan += ' Kehadiran cukup baik, tingkatkan lagi konsistensinya.';
          } else {
            catatanBulanan += ' Kehadiran perlu ditingkatkan untuk mendukung progress belajar.';
          }
        }
        
        const content = `
          <div style="font-family: 'Times New Roman', serif; color: #000;">
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 2px solid #000; padding-bottom: 10px;">
              <div style="display: flex; justify-content: center; margin-bottom: 10px;">
                <img src="https://ypwi.or.id/assets/setting/front/meta/image.png" alt="Logo" style="width: 80px; height: 80px; object-fit: contain;">
              </div>
              <h1 style="margin: 0; font-size: 18px; font-weight: bold;">LAPORAN BULANAN TAHFIDZ</h1>
              <h2 style="margin: 5px 0; font-size: 16px;">${defaultConfig.madrasah_name}</h2>
              <p style="margin: 3px 0; font-size: 10px;">Jl. Poros Palopo Makassar, Desa Mattirowalie, Kec. Maniangpajo, Kab. Wajo, Sulawesi Selatan</p>
              <p style="margin: 5px 0; font-size: 12px; font-weight: bold;">Bulan: ${bulanNama} ${tahun}</p>
            </div>
            
            <div style="margin-bottom: 25px;">
              <table style="width: 100%; border-collapse: collapse; font-size: 13px; line-height: 1.8;">
                <tr>
                  <td style="padding: 6px 0; width: 180px; vertical-align: top;">Nama Santri</td>
                  <td style="padding: 6px 0; width: 15px; vertical-align: top;">:</td>
                  <td style="padding: 6px 0; vertical-align: top; font-weight: bold;">${santri.nama_santri}</td>
                </tr>
                <tr>
                  <td style="padding: 6px 0; vertical-align: top;">NIS</td>
                  <td style="padding: 6px 0; vertical-align: top;">:</td>
                  <td style="padding: 6px 0; vertical-align: top;">${santri.nis}</td>
                </tr>
                <tr>
                  <td style="padding: 6px 0; vertical-align: top;">Kelas</td>
                  <td style="padding: 6px 0; vertical-align: top;">:</td>
                  <td style="padding: 6px 0; vertical-align: top;">${santri.kelas}</td>
                </tr>
                <tr>
                  <td style="padding: 6px 0; vertical-align: top;">Pembimbing</td>
                  <td style="padding: 6px 0; vertical-align: top;">:</td>
                  <td style="padding: 6px 0; vertical-align: top;">${pembimbing.nama_pembimbing}</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-bottom: 15px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 5px; margin: 0; font-size: 13px;">Rekap Kehadiran</h3>
              <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 11px; page-break-inside: avoid;">
                <tr>
                  <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0; width: 25%;"><strong>Hadir (H)</strong></td>
                  <td style="border: 1px solid #000; padding: 5px; width: 25%;">${hadir}</td>
                  <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0; width: 25%;"><strong>Izin (I)</strong></td>
                  <td style="border: 1px solid #000; padding: 5px; width: 25%;">${izin}</td>
                </tr>
                <tr>
                  <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;"><strong>Sakit (S)</strong></td>
                  <td style="border: 1px solid #000; padding: 5px;">${sakit}</td>
                  <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;"><strong>Alpha (A)</strong></td>
                  <td style="border: 1px solid #000; padding: 5px;">${alpha}</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-top: 25px; margin-bottom: 15px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 5px; margin: 0; font-size: 13px;">Hafalan Baru Bulan Ini</h3>
              <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 11px; page-break-inside: avoid;">
                <thead>
                  <tr style="background: #e0e0e0;">
                    <th style="border: 1px solid #000; padding: 5px;">Tanggal</th>
                    <th style="border: 1px solid #000; padding: 5px;">Juz</th>
                    <th style="border: 1px solid #000; padding: 5px;">Halaman</th>
                    <th style="border: 1px solid #000; padding: 5px;">Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  ${hafalan.length > 0 ? hafalan.map(h => `
                    <tr>
                      <td style="border: 1px solid #000; padding: 5px; text-align: center;">${h.tanggal}</td>
                      <td style="border: 1px solid #000; padding: 5px; text-align: center;">${h.juz}</td>
                      <td style="border: 1px solid #000; padding: 5px; text-align: center;">${h.halaman}</td>
                      <td style="border: 1px solid #000; padding: 5px; text-align: center;">${h.nilai}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="4" style="border: 1px solid #000; padding: 5px; text-align: center;">Tidak ada data</td></tr>'}
                  <tr style="background: #f0f0f0; font-weight: bold;">
                    <td colspan="2" style="border: 1px solid #000; padding: 5px; text-align: right;">Total Hafalan Bulan Ini:</td>
                    <td colspan="2" style="border: 1px solid #000; padding: 5px; text-align: center;">${jumlahHalamanBaru} Halaman</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 25px; margin-bottom: 15px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 5px; margin: 0; font-size: 13px;">Total Hafalan Al-Qur'an Keseluruhan</h3>
              <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 11px; page-break-inside: avoid;">
                <tr>
                  <td style="border: 1px solid #000; padding: 5px; width: 40%; background: #f0f0f0;"><strong>Hafalan Awal</strong></td>
                  <td style="border: 1px solid #000; padding: 5px; text-align: center;">${santri.total_hafalan_juz} Juz ${santri.total_hafalan_halaman} Halaman</td>
                </tr>
                <tr>
                  <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;"><strong>Hafalan Bulan Ini</strong></td>
                  <td style="border: 1px solid #000; padding: 5px; text-align: center;">${jumlahHalamanBaru} Halaman</td>
                </tr>
                <tr style="font-weight: bold; background: #e0e0e0;">
                  <td style="border: 1px solid #000; padding: 5px;"><strong>Total Keseluruhan</strong></td>
                  <td style="border: 1px solid #000; padding: 5px; text-align: center;">${totalJuzKeseluruhan} Juz ${sisaHalaman} Halaman</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-top: 25px; margin-bottom: 15px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 5px; margin: 0; font-size: 13px;">Murajaah (Total: ${murajaah.length} kali)</h3>
              <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 11px; page-break-inside: avoid;">
                <thead>
                  <tr style="background: #e0e0e0;">
                    <th style="border: 1px solid #000; padding: 5px;">Tanggal</th>
                    <th style="border: 1px solid #000; padding: 5px;">Juz</th>
                    <th style="border: 1px solid #000; padding: 5px;">Halaman</th>
                    <th style="border: 1px solid #000; padding: 5px;">Nilai</th>
                  </tr>
                </thead>
                <tbody>
                  ${murajaah.length > 0 ? murajaah.map(m => `
                    <tr>
                      <td style="border: 1px solid #000; padding: 5px; text-align: center;">${m.tanggal}</td>
                      <td style="border: 1px solid #000; padding: 5px; text-align: center;">${m.juz}</td>
                      <td style="border: 1px solid #000; padding: 5px; text-align: center;">${m.halaman}</td>
                      <td style="border: 1px solid #000; padding: 5px; text-align: center;">${m.nilai}</td>
                    </tr>
                  `).join('') : '<tr><td colspan="4" style="border: 1px solid #000; padding: 5px; text-align: center;">Tidak ada data</td></tr>'}
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 25px; margin-bottom: 15px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 5px; margin: 0; font-size: 13px;">Hafalan Hadits</h3>
              <table style="width: 100%; border-collapse: collapse; border: 1px solid #000; font-size: 11px; page-break-inside: avoid;">
                <tr>
                  <td style="border: 1px solid #000; padding: 5px; width: 40%; background: #f0f0f0;"><strong>Hafalan Hadits Awal</strong></td>
                  <td style="border: 1px solid #000; padding: 5px; text-align: center;">${santri.total_hadits} Hadits</td>
                </tr>
                <tr>
                  <td style="border: 1px solid #000; padding: 5px; background: #f0f0f0;"><strong>Hafalan Hadits Bulan Ini</strong></td>
                  <td style="border: 1px solid #000; padding: 5px; text-align: center;">${totalHaditsBaru} Hadits</td>
                </tr>
                <tr style="font-weight: bold; background: #e0e0e0;">
                  <td style="border: 1px solid #000; padding: 5px;"><strong>Total Hafalan Hadits</strong></td>
                  <td style="border: 1px solid #000; padding: 5px; text-align: center;">${totalHaditsKeseluruhan} Hadits</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-bottom: 20px; padding: 10px; background: #f9f9f9; border: 1px solid #000; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="margin: 0 0 8px 0; font-size: 13px; font-weight: bold;">Catatan dan Saran:</h3>
              <p style="margin: 0; font-size: 11px; text-align: justify; line-height: 1.6;">${catatanBulanan}</p>
            </div>
            
            <div style="margin-top: 40px; page-break-inside: avoid; break-inside: avoid;">
              <table style="width: 100%; font-size: 11px;">
                <tr>
                  <td style="width: 50%; text-align: center; padding: 10px;">
                    <p style="margin-bottom: 60px;">Orang Tua/Wali</p>
                    <p style="border-top: 1px solid #000; display: inline-block; padding-top: 3px; min-width: 150px;">${santri.nama_wali}</p>
                  </td>
                  <td style="width: 50%; text-align: center; padding: 10px;">
                    <p style="margin-bottom: 60px;">Pembimbing</p>
                    <p style="border-top: 1px solid #000; display: inline-block; padding-top: 3px; min-width: 150px;">${pembimbing.nama_pembimbing}</p>
                  </td>
                </tr>
              </table>
            </div>
          </div>
        `;
        
        document.getElementById('content-laporan-bulanan').innerHTML = content;
        document.getElementById('preview-laporan-bulanan').classList.remove('hidden');
        showToast('Laporan berhasil ditampilkan');
      } catch (error) {
        showToast('Gagal memuat laporan', 'error');
      }
    });

    // Form Rapor Semester
    document.getElementById('form-rapor-semester').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const santriId = document.getElementById('santri-rapor').value;
      const semester = document.getElementById('semester-rapor').value;
      const tahunAjaran = document.getElementById('tahun-ajaran-rapor').value;
      
      const santri = santriData.find(s => s.id === santriId);
      const pembimbing = pembimbingData.find(p => p.id === santri.id_pembimbing);
      if (!santri || !pembimbing) return;
      
      try {
        const hafalanSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hafalan_baru'));
        const tahsinSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahsin'));
        const murajaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'murajaah'));
        const haditsSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hadits'));
        const mutabaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'mutabaah'));
        const absensiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'absensi'));
        const tasmiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tasmi'));
        
        const hafalan = hafalanSnapshot.docs.map(doc => doc.data()).filter(h => h.id_santri === santriId);
        const tahsin = tahsinSnapshot.docs.map(doc => doc.data()).filter(t => t.id_santri === santriId);
        const murajaah = murajaahSnapshot.docs.map(doc => doc.data()).filter(m => m.id_santri === santriId);
        const hadits = haditsSnapshot.docs.map(doc => doc.data()).filter(h => h.id_santri === santriId);
        const mutabaah = mutabaahSnapshot.docs.map(doc => doc.data()).filter(m => m.id_santri === santriId);
        const absensi = absensiSnapshot.docs.map(doc => doc.data()).filter(a => a.id_santri === santriId);
        const tasmi = tasmiSnapshot.docs.map(doc => doc.data()).filter(t => t.id_santri === santriId);
        
        const hitungRataRata = (data) => {
          if (data.length === 0) return '-';
          const nilaiMap = { 'A': 4, 'B': 3, 'C': 2, 'D': 1 };
          const total = data.reduce((sum, item) => sum + (nilaiMap[item.nilai] || 0), 0);
          const rata = total / data.length;
          if (rata >= 3.5) return 'A';
          if (rata >= 2.5) return 'B';
          if (rata >= 1.5) return 'C';
          return 'D';
        };
        
        const hadir = absensi.filter(a => a.status === 'H').length;
        const izin = absensi.filter(a => a.status === 'I').length;
        const sakit = absensi.filter(a => a.status === 'S').length;
        const alpha = absensi.filter(a => a.status === 'A').length;
        
        // Hitung jumlah halaman baru semester ini (jumlah record hafalan, bukan total halaman)
        const jumlahHalamanSemester = hafalan.length;
        const totalHaditsSemester = hadits.length;
        
        // Hitung total keseluruhan dengan benar
        // Konversi hafalan awal ke total halaman
        const halamanAwal = ((santri.total_hafalan_juz || 0) * 20) + (santri.total_hafalan_halaman || 0);
        const totalHalamanKeseluruhan = halamanAwal + jumlahHalamanSemester;
        const totalJuzKeseluruhan = Math.floor(totalHalamanKeseluruhan / 20);
        const sisaHalaman = totalHalamanKeseluruhan % 20;
        
        const totalHaditsKeseluruhan = (santri.total_hadits || 0) + totalHaditsSemester;
        
        // Generate catatan otomatis untuk semester
        let catatanSemester = '';
        
        // Evaluasi hafalan semester
        if (jumlahHalamanSemester >= 60) {
          catatanSemester = 'MasyaaAllah tabarakallah! Pencapaian luar biasa selama semester ini. Santri menunjukkan dedikasi dan konsistensi yang sangat tinggi dalam menghafal Al-Qur\'an. ';
        } else if (jumlahHalamanSemester >= 40) {
          catatanSemester = 'Alhamdulillah, pencapaian hafalan semester ini sangat baik dan patut diapresiasi. Terus pertahankan semangat dan tingkatkan kualitas hafalan. ';
        } else if (jumlahHalamanSemester >= 20) {
          catatanSemester = 'Pencapaian hafalan semester ini cukup baik, namun masih ada ruang untuk peningkatan. Tingkatkan konsistensi dan fokus dalam menghafal. ';
        } else if (jumlahHalamanSemester >= 1) {
          catatanSemester = 'Pencapaian hafalan semester ini masih perlu ditingkatkan secara signifikan. Perlu evaluasi mendalam dan strategi baru untuk meningkatkan progress. ';
        } else {
          catatanSemester = 'Belum ada penambahan hafalan selama semester ini. Diperlukan perhatian khusus dan intervensi intensif untuk meningkatkan motivasi dan kemampuan menghafal. ';
        }
        
        // Evaluasi nilai rata-rata
        const nilaiHafalan = hitungRataRata(hafalan);
        const nilaiMurajaah = hitungRataRata(murajaah);
        
        if (nilaiHafalan === 'A' && nilaiMurajaah === 'A') {
          catatanSemester += 'Kualitas hafalan dan murajaah sangat baik. ';
        } else if ((nilaiHafalan === 'A' || nilaiHafalan === 'B') && (nilaiMurajaah === 'A' || nilaiMurajaah === 'B')) {
          catatanSemester += 'Kualitas hafalan dan murajaah baik. ';
        } else {
          catatanSemester += 'Kualitas hafalan dan murajaah perlu ditingkatkan. ';
        }
        
        // Evaluasi kehadiran
        const totalHariSemester = hadir + izin + sakit + alpha;
        if (totalHariSemester > 0) {
          const persenKehadiranSemester = (hadir / totalHariSemester) * 100;
          if (persenKehadiranSemester >= 90) {
            catatanSemester += 'Kehadiran sangat baik dan konsisten, pertahankan kedisiplinan ini. ';
          } else if (persenKehadiranSemester >= 75) {
            catatanSemester += 'Kehadiran cukup baik, tingkatkan konsistensi kehadiran. ';
          } else {
            catatanSemester += 'Kehadiran masih rendah dan perlu ditingkatkan secara signifikan. ';
          }
        }
        
        // Saran untuk semester depan
        catatanSemester += 'Saran untuk semester mendatang: ';
        if (jumlahHalamanSemester >= 40) {
          catatanSemester += 'Pertahankan target hafalan minimal 1 halaman per hari dan tingkatkan kualitas tajwid serta pemahaman makna.';
        } else if (jumlahHalamanSemester >= 20) {
          catatanSemester += 'Tingkatkan target hafalan menjadi minimal 1 halaman per hari dan perbanyak murajaah.';
        } else {
          catatanSemester += 'Fokus membangun rutinitas menghafal yang konsisten, mulai dari target kecil dan bertahap tingkatkan.';
        }
        
        const content = `
          <div style="font-family: 'Times New Roman', serif; color: #000;">
            <div style="text-align: center; margin-bottom: 20px; border-bottom: 3px solid #000; padding-bottom: 15px;">
              <div style="display: flex; justify-content: center; margin-bottom: 10px;">
                <img src="https://ypwi.or.id/assets/setting/front/meta/image.png" alt="Logo" style="width: 80px; height: 80px; object-fit: contain;">
              </div>
              <h1 style="margin: 0; font-size: 20px; font-weight: bold;">RAPOR TAHFIDZ AL-QUR'AN</h1>
              <h2 style="margin: 5px 0; font-size: 16px;">${defaultConfig.madrasah_name}</h2>
              <p style="margin: 3px 0; font-size: 10px;">Jl. Poros Palopo Makassar, Desa Mattirowalie, Kec. Maniangpajo, Kab. Wajo, Sulawesi Selatan</p>
              <p style="margin: 5px 0; font-size: 13px; font-weight: bold;">Semester ${semester} - Tahun Ajaran ${tahunAjaran}</p>
            </div>
            
            <div style="margin-bottom: 20px;">
              <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                <tr>
                  <td style="padding: 5px; width: 180px;">Nama Santri</td>
                  <td style="padding: 5px; width: 10px;">:</td>
                  <td style="padding: 5px; font-weight: bold;">${santri.nama_santri}</td>
                </tr>
                <tr>
                  <td style="padding: 5px;">NIS</td>
                  <td style="padding: 5px;">:</td>
                  <td style="padding: 5px;">${santri.nis}</td>
                </tr>
                <tr>
                  <td style="padding: 5px;">Kelas</td>
                  <td style="padding: 5px;">:</td>
                  <td style="padding: 5px;">${santri.kelas}</td>
                </tr>
                <tr>
                  <td style="padding: 5px;">Nama Orang Tua/Wali</td>
                  <td style="padding: 5px;">:</td>
                  <td style="padding: 5px;">${santri.nama_wali}</td>
                </tr>
                <tr>
                  <td style="padding: 5px;">Pembimbing</td>
                  <td style="padding: 5px;">:</td>
                  <td style="padding: 5px;">${pembimbing.nama_pembimbing}</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-top: 25px; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px; margin: 0; font-size: 14px;">CAPAIAN PEMBELAJARAN</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 11px; page-break-inside: avoid;">
                <thead>
                  <tr style="background: #e0e0e0;">
                    <th style="border: 1px solid #000; padding: 8px; text-align: left;">Aspek Penilaian</th>
                    <th style="border: 1px solid #000; padding: 8px; width: 100px; text-align: center;">Nilai</th>
                    <th style="border: 1px solid #000; padding: 8px; width: 120px; text-align: center;">Jumlah</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">Hafalan Baru</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${hitungRataRata(hafalan)}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${hafalan.length} kali</td>
                  </tr>
                  <tr style="background: #f9f9f9;">
                    <td style="border: 1px solid #000; padding: 8px;">Tahsin (Makharijul Huruf)</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${hitungRataRata(tahsin.filter(t => t.kategori === 'Makharijul Huruf'))}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${tahsin.filter(t => t.kategori === 'Makharijul Huruf').length} kali</td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">Tahsin (Tajwid)</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${hitungRataRata(tahsin.filter(t => t.kategori === 'Tajwid'))}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${tahsin.filter(t => t.kategori === 'Tajwid').length} kali</td>
                  </tr>
                  <tr style="background: #f9f9f9;">
                    <td style="border: 1px solid #000; padding: 8px;">Murajaah</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${hitungRataRata(murajaah)}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${murajaah.length} kali</td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">Hafalan Hadits</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${hitungRataRata(hadits)}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${hadits.length} hadits</td>
                  </tr>
                  <tr style="background: #f9f9f9;">
                    <td style="border: 1px solid #000; padding: 8px;">Mutaba'ah Yaumiyah</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${hitungRataRata(mutabaah)}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${mutabaah.length} hari</td>
                  </tr>
                  <tr>
                    <td style="border: 1px solid #000; padding: 8px;">Tasmi' (Setoran Juz)</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center; font-weight: bold; font-size: 14px;">${hitungRataRata(tasmi)}</td>
                    <td style="border: 1px solid #000; padding: 8px; text-align: center;">${tasmi.length} juz</td>
                  </tr>
                </tbody>
              </table>
            </div>
            
            <div style="margin-top: 25px; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px; margin: 0; font-size: 14px;">REKAP KEHADIRAN</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 11px; page-break-inside: avoid;">
                <tr>
                  <td style="border: 1px solid #000; padding: 8px; background: #e0e0e0; width: 25%;"><strong>Hadir</strong></td>
                  <td style="border: 1px solid #000; padding: 8px; width: 25%;">${hadir} hari</td>
                  <td style="border: 1px solid #000; padding: 8px; background: #e0e0e0; width: 25%;"><strong>Izin</strong></td>
                  <td style="border: 1px solid #000; padding: 8px; width: 25%;">${izin} hari</td>
                </tr>
                <tr>
                  <td style="border: 1px solid #000; padding: 8px; background: #e0e0e0;"><strong>Sakit</strong></td>
                  <td style="border: 1px solid #000; padding: 8px;">${sakit} hari</td>
                  <td style="border: 1px solid #000; padding: 8px; background: #e0e0e0;"><strong>Alpha</strong></td>
                  <td style="border: 1px solid #000; padding: 8px;">${alpha} hari</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-top: 25px; margin-bottom: 20px; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="background: #000; color: white; padding: 8px; margin: 0; font-size: 14px;">TOTAL HAFALAN KESELURUHAN</h3>
              <table style="width: 100%; border-collapse: collapse; border: 2px solid #000; font-size: 11px; page-break-inside: avoid;">
                <tr style="background: #f9f9f9;">
                  <td style="border: 1px solid #000; padding: 8px; width: 50%; background: #e0e0e0;"><strong>Hafalan Al-Qur'an Awal</strong></td>
                  <td style="border: 1px solid #000; padding: 8px; width: 50%;">${santri.total_hafalan_juz} Juz ${santri.total_hafalan_halaman} Halaman</td>
                </tr>
                <tr>
                  <td style="border: 1px solid #000; padding: 8px; background: #e0e0e0;"><strong>Hafalan Semester Ini</strong></td>
                  <td style="border: 1px solid #000; padding: 8px;">${jumlahHalamanSemester} Halaman</td>
                </tr>
                <tr style="background: #f0f0f0; font-weight: bold;">
                  <td style="border: 1px solid #000; padding: 8px; background: #d0d0d0;"><strong>Total Hafalan Al-Qur'an</strong></td>
                  <td style="border: 1px solid #000; padding: 8px; font-size: 13px;">${totalJuzKeseluruhan} Juz ${sisaHalaman} Halaman</td>
                </tr>
                <tr style="background: #f9f9f9;">
                  <td style="border: 1px solid #000; padding: 8px; background: #e0e0e0;"><strong>Hafalan Hadits Awal</strong></td>
                  <td style="border: 1px solid #000; padding: 8px;">${santri.total_hadits} Hadits</td>
                </tr>
                <tr>
                  <td style="border: 1px solid #000; padding: 8px; background: #e0e0e0;"><strong>Hafalan Hadits Semester Ini</strong></td>
                  <td style="border: 1px solid #000; padding: 8px;">${totalHaditsSemester} Hadits</td>
                </tr>
                <tr style="background: #f0f0f0; font-weight: bold;">
                  <td style="border: 1px solid #000; padding: 8px; background: #d0d0d0;"><strong>Total Hafalan Hadits</strong></td>
                  <td style="border: 1px solid #000; padding: 8px; font-size: 13px;">${totalHaditsKeseluruhan} Hadits</td>
                </tr>
              </table>
            </div>
            
            <div style="margin-bottom: 20px; padding: 12px; background: #f9f9f9; border: 2px solid #000; page-break-inside: avoid; break-inside: avoid;">
              <h3 style="margin: 0 0 10px 0; font-size: 13px; font-weight: bold;">CATATAN DAN SARAN PEMBIMBING:</h3>
              <p style="margin: 0; font-size: 11px; text-align: justify; line-height: 1.7;">${catatanSemester}</p>
            </div>
            
            <div style="margin-top: 40px; page-break-inside: avoid; break-inside: avoid;">
              <table style="width: 100%; font-size: 11px;">
                <tr>
                  <td style="width: 50%; text-align: center; padding: 15px;">
                    <p style="margin-bottom: 70px;">Orang Tua/Wali</p>
                    <p style="border-top: 1px solid #000; display: inline-block; padding-top: 5px; min-width: 180px; font-weight: bold;">${santri.nama_wali}</p>
                  </td>
                  <td style="width: 50%; text-align: center; padding: 15px;">
                    <p style="margin-bottom: 70px;">Pembimbing</p>
                    <p style="border-top: 1px solid #000; display: inline-block; padding-top: 5px; min-width: 180px; font-weight: bold;">${pembimbing.nama_pembimbing}</p>
                  </td>
                </tr>
              </table>
            </div>
            
            <div style="margin-top: 25px; padding: 12px; background: #f0f0f0; border: 2px solid #000; border-radius: 4px; page-break-inside: avoid; break-inside: avoid;">
              <p style="margin: 0; font-size: 11px; font-weight: bold;">Keterangan Nilai:</p>
              <p style="margin: 5px 0 0 0; font-size: 11px;">A = Mumtaz (Istimewa) | B = Jayyid Jiddan (Sangat Baik) | C = Jayyid (Baik) | D = Maqbul (Cukup)</p>
            </div>
          </div>
        `;
        
        document.getElementById('content-rapor-semester').innerHTML = content;
        document.getElementById('preview-rapor-semester').classList.remove('hidden');
        showToast('Rapor berhasil ditampilkan');
      } catch (error) {
        showToast('Gagal memuat rapor', 'error');
      }
    });

    // Fungsi Cetak PDF - Generate dokumen formal langsung tanpa screenshot
    window.cetakLaporanPekanan = async function() {
      showToast('Sedang membuat PDF...', 'success');
      
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', [210, 330]); // F4
        
        const santriId = document.getElementById('santri-laporan-pekanan').value;
        const tanggalMulai = document.getElementById('tanggal-mulai-pekanan').value;
        const tanggalSelesai = document.getElementById('tanggal-selesai-pekanan').value;
        
        const santri = santriData.find(s => s.id === santriId);
        const pembimbing = pembimbingData.find(p => p.id === santri.id_pembimbing);
        
        const hafalanSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hafalan_baru'));
        const tahsinSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahsin'));
        const murajaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'murajaah'));
        const mutabaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'mutabaah'));
        const haditsSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hadits'));
        const absensiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'absensi'));
        
        const hafalan = hafalanSnapshot.docs.map(doc => doc.data()).filter(h => 
          h.id_santri === santriId && h.tanggal >= tanggalMulai && h.tanggal <= tanggalSelesai
        );
        const tahsin = tahsinSnapshot.docs.map(doc => doc.data()).filter(t => 
          t.id_santri === santriId && t.tanggal >= tanggalMulai && t.tanggal <= tanggalSelesai
        );
        const murajaah = murajaahSnapshot.docs.map(doc => doc.data()).filter(m => 
          m.id_santri === santriId && m.tanggal >= tanggalMulai && m.tanggal <= tanggalSelesai
        );
        const mutabaah = mutabaahSnapshot.docs.map(doc => doc.data()).filter(m => 
          m.id_santri === santriId && m.tanggal >= tanggalMulai && m.tanggal <= tanggalSelesai
        );
        const hadits = haditsSnapshot.docs.map(doc => doc.data()).filter(h => 
          h.id_santri === santriId && h.tanggal >= tanggalMulai && h.tanggal <= tanggalSelesai
        );
        const absensi = absensiSnapshot.docs.map(doc => doc.data()).filter(a => 
          a.id_santri === santriId && a.tanggal >= tanggalMulai && a.tanggal <= tanggalSelesai
        );
        
        const hadir = absensi.filter(a => a.status === 'H').length;
        const izin = absensi.filter(a => a.status === 'I').length;
        const sakit = absensi.filter(a => a.status === 'S').length;
        const alpha = absensi.filter(a => a.status === 'A').length;
        
        const jumlahHalamanBaru = hafalan.length;
        const totalHaditsBaru = hadits.length;
        const halamanAwal = ((santri.total_hafalan_juz || 0) * 20) + (santri.total_hafalan_halaman || 0);
        const totalHalamanKeseluruhan = halamanAwal + jumlahHalamanBaru;
        const totalJuzKeseluruhan = Math.floor(totalHalamanKeseluruhan / 20);
        const sisaHalaman = totalHalamanKeseluruhan % 20;
        const totalHaditsKeseluruhan = (santri.total_hadits || 0) + totalHaditsBaru;
        
        let catatan = '';
        if (jumlahHalamanBaru >= 7) {
          catatan = 'Alhamdulillah, pencapaian hafalan sangat baik dan konsisten. Pertahankan semangat dan istiqomah dalam menghafal. Tingkatkan kualitas bacaan dan pemahaman makna ayat.';
        } else if (jumlahHalamanBaru >= 4) {
          catatan = 'Mashaa Allah, progress hafalan cukup baik. Terus tingkatkan target hafalan dan jaga konsistensi murajaah agar hafalan tidak mudah lupa.';
        } else if (jumlahHalamanBaru >= 1) {
          catatan = 'Progress hafalan masih perlu ditingkatkan. Lebih fokus dan konsisten dalam menambah hafalan baru. Perbanyak murajaah hafalan lama.';
        } else {
          catatan = 'Belum ada penambahan hafalan di periode ini. Perlu peningkatan motivasi dan konsistensi dalam menghafal. Konsultasikan kendala dengan pembimbing.';
        }
        
        const totalHari = hadir + izin + sakit + alpha;
        if (totalHari > 0) {
          const rataKehadiran = (hadir / totalHari) * 100;
          if (rataKehadiran >= 90) {
            catatan += ' Kehadiran sangat baik, pertahankan kedisiplinan.';
          } else if (rataKehadiran >= 75) {
            catatan += ' Kehadiran cukup baik, usahakan lebih konsisten hadir.';
          } else {
            catatan += ' Kehadiran perlu ditingkatkan untuk mendukung progress hafalan.';
          }
        }
        
        // Set font Times New Roman
        pdf.setFont('times', 'normal');
        
        let yPos = 15;
        
        // Header dengan border
        pdf.setLineWidth(0.5);
        pdf.rect(10, 10, 190, 30);
        pdf.setLineWidth(0.3);
        pdf.rect(10.5, 10.5, 189, 29);
        
        yPos += 5;
        pdf.setFontSize(14);
        pdf.setFont('times', 'bold');
        pdf.text('LAPORAN PERKEMBANGAN PEKANAN', 105, yPos, { align: 'center' });
        
        yPos += 6;
        pdf.setFontSize(12);
        pdf.setFont('times', 'normal');
        pdf.text(defaultConfig.madrasah_name, 105, yPos, { align: 'center' });
        
        yPos += 5;
        pdf.setFontSize(9);
        pdf.text('Jl. Poros Palopo Makassar, Desa Mattirowalie, Kec. Maniangpajo, Kab. Wajo, Sulawesi Selatan', 105, yPos, { align: 'center' });
        
        yPos += 5;
        pdf.setFontSize(10);
        pdf.setFont('times', 'bold');
        pdf.text(`Periode: ${tanggalMulai} s/d ${tanggalSelesai}`, 105, yPos, { align: 'center' });
        
        yPos = 52;
        
        // Data Santri
        pdf.setFont('times', 'normal');
        pdf.setFontSize(10);
        pdf.text('Nama Santri', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.setFont('times', 'bold');
        pdf.text(santri.nama_santri, 65, yPos);
        
        yPos += 6;
        pdf.setFont('times', 'normal');
        pdf.text('NIS', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.text(santri.nis, 65, yPos);
        
        yPos += 6;
        pdf.text('Kelas', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.text(santri.kelas, 65, yPos);
        
        yPos += 6;
        pdf.text('Pembimbing', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.text(pembimbing.nama_pembimbing, 65, yPos);
        
        yPos += 12;
        
        // Tabel Hafalan Baru
        pdf.setFillColor(0, 0, 0);
        pdf.rect(10, yPos, 190, 7, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFont('times', 'bold');
        pdf.setFontSize(11);
        pdf.text('HAFALAN BARU DALAM PERIODE', 15, yPos + 5);
        
        yPos += 7;
        pdf.setTextColor(0, 0, 0);
        
        // Header tabel
        pdf.setFillColor(230, 230, 230);
        pdf.rect(10, yPos, 190, 8, 'FD');
        pdf.setFont('times', 'bold');
        pdf.setFontSize(9);
        pdf.text('Tanggal', 40, yPos + 5.5, { align: 'center' });
        pdf.text('Juz', 85, yPos + 5.5, { align: 'center' });
        pdf.text('Halaman', 125, yPos + 5.5, { align: 'center' });
        pdf.text('Nilai', 170, yPos + 5.5, { align: 'center' });
        
        yPos += 8;
        pdf.setFont('times', 'normal');
        
        if (hafalan.length > 0) {
          hafalan.forEach((h, idx) => {
            if (yPos > 305) {
              pdf.addPage([210, 330]);
              yPos = 15;
            }
            
            if (idx % 2 === 0) {
              pdf.setFillColor(249, 249, 249);
              pdf.rect(10, yPos, 190, 7, 'F');
            }
            
            pdf.setLineWidth(0.1);
            pdf.rect(10, yPos, 190, 7);
            pdf.text(h.tanggal, 40, yPos + 4.5, { align: 'center' });
            pdf.text(String(h.juz), 85, yPos + 4.5, { align: 'center' });
            pdf.text(String(h.halaman), 125, yPos + 4.5, { align: 'center' });
            pdf.setFont('times', 'bold');
            pdf.text(h.nilai, 170, yPos + 4.5, { align: 'center' });
            pdf.setFont('times', 'normal');
            
            yPos += 7;
          });
        } else {
          pdf.setFont('times', 'italic');
          pdf.text('Tidak ada data hafalan dalam periode ini', 105, yPos + 4.5, { align: 'center' });
          pdf.rect(10, yPos, 190, 7);
          yPos += 7;
        }
        
        // Total
        pdf.setFillColor(224, 224, 224);
        pdf.rect(10, yPos, 190, 8, 'FD');
        pdf.setFont('times', 'bold');
        pdf.setFontSize(9);
        pdf.text('Total Hafalan Periode:', 85, yPos + 5.5, { align: 'right' });
        pdf.setFontSize(10);
        pdf.text(`${jumlahHalamanBaru} Halaman`, 170, yPos + 5.5, { align: 'center' });
        
        yPos += 15;
        
        // Total Hafalan Keseluruhan
        if (yPos > 290) {
          pdf.addPage([210, 330]);
          yPos = 15;
        }
        
        pdf.setFillColor(0, 0, 0);
        pdf.rect(10, yPos, 190, 7, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFont('times', 'bold');
        pdf.setFontSize(11);
        pdf.text('TOTAL HAFALAN AL-QUR\'AN KESELURUHAN', 15, yPos + 5);
        
        yPos += 7;
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('times', 'normal');
        pdf.setFontSize(9);
        
        // Row 1
        pdf.setFillColor(249, 249, 249);
        pdf.rect(10, yPos, 95, 7, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Hafalan Awal', 15, yPos + 4.5);
        pdf.rect(105, yPos, 95, 7, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${santri.total_hafalan_juz} Juz ${santri.total_hafalan_halaman} Halaman`, 152.5, yPos + 4.5, { align: 'center' });
        
        yPos += 7;
        
        // Row 2
        pdf.rect(10, yPos, 95, 7, 'D');
        pdf.setFont('times', 'bold');
        pdf.text('Hafalan Periode Ini', 15, yPos + 4.5);
        pdf.rect(105, yPos, 95, 7, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${jumlahHalamanBaru} Halaman`, 152.5, yPos + 4.5, { align: 'center' });
        
        yPos += 7;
        
        // Total
        pdf.setFillColor(224, 224, 224);
        pdf.rect(10, yPos, 95, 8, 'FD');
        pdf.setFont('times', 'bold');
        pdf.setFontSize(10);
        pdf.text('TOTAL KESELURUHAN', 15, yPos + 5.5);
        pdf.rect(105, yPos, 95, 8, 'FD');
        pdf.setFontSize(11);
        pdf.text(`${totalJuzKeseluruhan} Juz ${sisaHalaman} Halaman`, 152.5, yPos + 5.5, { align: 'center' });
        
        yPos += 15;
        
        // Catatan
        if (yPos > 270) {
          pdf.addPage([210, 330]);
          yPos = 15;
        }
        
        pdf.setLineWidth(0.5);
        pdf.rect(10, yPos, 190, 25);
        pdf.setFont('times', 'bold');
        pdf.setFontSize(10);
        pdf.text('Catatan dan Saran Pembimbing:', 15, yPos + 5);
        
        pdf.setFont('times', 'normal');
        pdf.setFontSize(9);
        const lines = pdf.splitTextToSize(catatan, 180);
        pdf.text(lines, 15, yPos + 11);
        
        yPos += 35;
        
        // Tanda Tangan
        if (yPos > 280) {
          pdf.addPage([210, 330]);
          yPos = 15;
        }
        
        pdf.setFont('times', 'normal');
        pdf.setFontSize(9);
        pdf.text('Orang Tua/Wali', 50, yPos, { align: 'center' });
        pdf.text('Pembimbing', 155, yPos, { align: 'center' });
        
        yPos += 20;
        
        pdf.setFont('times', 'bold');
        pdf.line(25, yPos, 75, yPos);
        pdf.text(santri.nama_wali, 50, yPos + 5, { align: 'center' });
        
        pdf.line(130, yPos, 180, yPos);
        pdf.text(pembimbing.nama_pembimbing, 155, yPos + 5, { align: 'center' });
        
        pdf.save('Laporan-Pekanan.pdf');
        showToast('PDF berhasil diunduh!', 'success');
      } catch (error) {
        console.error('Error creating PDF:', error);
        showToast('Gagal membuat PDF', 'error');
      }
    };

    window.cetakLaporanBulanan = async function() {
      showToast('Sedang membuat PDF...', 'success');
      
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', [210, 330]); // F4
        
        const santriId = document.getElementById('santri-laporan-bulanan').value;
        const bulan = document.getElementById('bulan-laporan').value;
        const tahun = document.getElementById('tahun-laporan').value;
        
        const santri = santriData.find(s => s.id === santriId);
        const pembimbing = pembimbingData.find(p => p.id === santri.id_pembimbing);
        
        const bulanNama = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'][parseInt(bulan)];
        
        const hafalanSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hafalan_baru'));
        const tahsinSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahsin'));
        const murajaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'murajaah'));
        const haditsSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hadits'));
        const mutabaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'mutabaah'));
        const absensiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'absensi'));
        
        const filterByMonth = (item) => {
          if (!item.tanggal) return false;
          const itemDate = new Date(item.tanggal);
          return item.id_santri === santriId && 
                 itemDate.getMonth() + 1 === parseInt(bulan) && 
                 itemDate.getFullYear() === parseInt(tahun);
        };
        
        const hafalan = hafalanSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        const tahsin = tahsinSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        const murajaah = murajaahSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        const hadits = haditsSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        const mutabaah = mutabaahSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        const absensi = absensiSnapshot.docs.map(doc => doc.data()).filter(filterByMonth);
        
        const hadir = absensi.filter(a => a.status === 'H').length;
        const izin = absensi.filter(a => a.status === 'I').length;
        const sakit = absensi.filter(a => a.status === 'S').length;
        const alpha = absensi.filter(a => a.status === 'A').length;
        
        const jumlahHalamanBaru = hafalan.length;
        const totalHaditsBaru = hadits.length;
        const halamanAwal = ((santri.total_hafalan_juz || 0) * 20) + (santri.total_hafalan_halaman || 0);
        const totalHalamanKeseluruhan = halamanAwal + jumlahHalamanBaru;
        const totalJuzKeseluruhan = Math.floor(totalHalamanKeseluruhan / 20);
        const sisaHalaman = totalHalamanKeseluruhan % 20;
        const totalHaditsKeseluruhan = (santri.total_hadits || 0) + totalHaditsBaru;
        
        let catatanBulanan = '';
        if (jumlahHalamanBaru >= 20) {
          catatanBulanan = 'MasyaaAllah tabarakallah! Pencapaian hafalan bulan ini sangat luar biasa dan menunjukkan dedikasi tinggi. Pertahankan konsistensi dan tingkatkan kualitas tajwid serta pemahaman makna ayat.';
        } else if (jumlahHalamanBaru >= 12) {
          catatanBulanan = 'Alhamdulillah, pencapaian hafalan bulan ini sangat baik. Terus jaga semangat dan istiqomah dalam menghafal. Perbanyak murajaah agar hafalan terjaga dengan baik.';
        } else if (jumlahHalamanBaru >= 6) {
          catatanBulanan = 'Pencapaian hafalan cukup baik, namun masih bisa ditingkatkan. Atur jadwal menghafal dengan lebih konsisten dan manfaatkan waktu dengan optimal.';
        } else if (jumlahHalamanBaru >= 1) {
          catatanBulanan = 'Pencapaian hafalan masih kurang optimal. Perlu peningkatan fokus dan konsistensi. Diskusikan kendala yang dihadapi dengan pembimbing untuk solusi yang tepat.';
        } else {
          catatanBulanan = 'Belum ada penambahan hafalan bulan ini. Sangat perlu peningkatan motivasi dan disiplin. Segera konsultasikan dengan pembimbing untuk evaluasi dan perbaikan strategi belajar.';
        }
        
        if (murajaah.length >= 20) {
          catatanBulanan += ' Murajaah sangat baik dan konsisten.';
        } else if (murajaah.length >= 10) {
          catatanBulanan += ' Murajaah cukup baik, pertahankan.';
        } else if (murajaah.length >= 1) {
          catatanBulanan += ' Murajaah perlu ditingkatkan untuk menjaga kualitas hafalan.';
        }
        
        const totalHari = hadir + izin + sakit + alpha;
        if (totalHari > 0) {
          const persenKehadiran = (hadir / totalHari) * 100;
          if (persenKehadiran >= 90) {
            catatanBulanan += ' Kehadiran sangat baik, pertahankan kedisiplinan.';
          } else if (persenKehadiran >= 75) {
            catatanBulanan += ' Kehadiran cukup baik, tingkatkan lagi konsistensinya.';
          } else {
            catatanBulanan += ' Kehadiran perlu ditingkatkan untuk mendukung progress belajar.';
          }
        }
        
        pdf.setFont('times', 'normal');
        
        let yPos = 15;
        
        // Header
        pdf.setLineWidth(0.5);
        pdf.rect(10, 10, 190, 28);
        pdf.setLineWidth(0.3);
        pdf.rect(10.5, 10.5, 189, 27);
        
        pdf.setFontSize(14);
        pdf.setFont('times', 'bold');
        pdf.text('LAPORAN BULANAN TAHFIDZ', 105, yPos, { align: 'center' });
        
        yPos += 6;
        pdf.setFontSize(12);
        pdf.setFont('times', 'normal');
        pdf.text(defaultConfig.madrasah_name, 105, yPos, { align: 'center' });
        
        yPos += 5;
        pdf.setFontSize(8);
        pdf.text('Jl. Poros Palopo Makassar, Desa Mattirowalie, Kec. Maniangpajo, Kab. Wajo, Sulawesi Selatan', 105, yPos, { align: 'center' });
        
        yPos += 5;
        pdf.setFontSize(10);
        pdf.setFont('times', 'bold');
        pdf.text(`Bulan: ${bulanNama} ${tahun}`, 105, yPos, { align: 'center' });
        
        yPos = 45;
        
        // Data Santri
        pdf.setFont('times', 'normal');
        pdf.setFontSize(10);
        pdf.text('Nama Santri', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.setFont('times', 'bold');
        pdf.text(santri.nama_santri, 65, yPos);
        
        yPos += 6;
        pdf.setFont('times', 'normal');
        pdf.text('NIS', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.text(santri.nis, 65, yPos);
        
        yPos += 6;
        pdf.text('Kelas', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.text(santri.kelas, 65, yPos);
        
        yPos += 6;
        pdf.text('Pembimbing', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.text(pembimbing.nama_pembimbing, 65, yPos);
        
        yPos += 12;
        
        // Rekap Kehadiran
        pdf.setFillColor(0, 0, 0);
        pdf.rect(10, yPos, 190, 6, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFont('times', 'bold');
        pdf.setFontSize(10);
        pdf.text('Rekap Kehadiran', 15, yPos + 4);
        
        yPos += 6;
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('times', 'normal');
        pdf.setFontSize(9);
        
        // Baris 1
        pdf.setFillColor(240, 240, 240);
        pdf.rect(10, yPos, 47.5, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Hadir (H)', 15, yPos + 4);
        pdf.rect(57.5, yPos, 47.5, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(String(hadir), 81.25, yPos + 4, { align: 'center' });
        
        pdf.setFillColor(240, 240, 240);
        pdf.rect(105, yPos, 47.5, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Izin (I)', 110, yPos + 4);
        pdf.rect(152.5, yPos, 47.5, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(String(izin), 176.25, yPos + 4, { align: 'center' });
        
        yPos += 6;
        
        // Baris 2
        pdf.setFillColor(240, 240, 240);
        pdf.rect(10, yPos, 47.5, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Sakit (S)', 15, yPos + 4);
        pdf.rect(57.5, yPos, 47.5, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(String(sakit), 81.25, yPos + 4, { align: 'center' });
        
        pdf.setFillColor(240, 240, 240);
        pdf.rect(105, yPos, 47.5, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Alpha (A)', 110, yPos + 4);
        pdf.rect(152.5, yPos, 47.5, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(String(alpha), 176.25, yPos + 4, { align: 'center' });
        
        yPos += 12;
        
        // Hafalan Baru
        pdf.setFillColor(0, 0, 0);
        pdf.rect(10, yPos, 190, 6, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFont('times', 'bold');
        pdf.text('Hafalan Baru Bulan Ini', 15, yPos + 4);
        
        yPos += 6;
        pdf.setTextColor(0, 0, 0);
        
        // Header tabel hafalan
        pdf.setFillColor(224, 224, 224);
        pdf.rect(10, yPos, 190, 7, 'FD');
        pdf.setFontSize(9);
        pdf.text('Tanggal', 40, yPos + 4.5, { align: 'center' });
        pdf.text('Juz', 85, yPos + 4.5, { align: 'center' });
        pdf.text('Halaman', 125, yPos + 4.5, { align: 'center' });
        pdf.text('Nilai', 170, yPos + 4.5, { align: 'center' });
        
        yPos += 7;
        pdf.setFont('times', 'normal');
        
        if (hafalan.length > 0) {
          hafalan.forEach((h, idx) => {
            if (yPos > 310) {
              pdf.addPage([210, 330]);
              yPos = 15;
            }
            
            if (idx % 2 === 0) {
              pdf.setFillColor(249, 249, 249);
              pdf.rect(10, yPos, 190, 6, 'F');
            }
            
            pdf.rect(10, yPos, 190, 6);
            pdf.text(h.tanggal, 40, yPos + 4, { align: 'center' });
            pdf.text(String(h.juz), 85, yPos + 4, { align: 'center' });
            pdf.text(String(h.halaman), 125, yPos + 4, { align: 'center' });
            pdf.text(h.nilai, 170, yPos + 4, { align: 'center' });
            
            yPos += 6;
          });
        } else {
          pdf.setFont('times', 'italic');
          pdf.text('Tidak ada data', 105, yPos + 4, { align: 'center' });
          pdf.rect(10, yPos, 190, 6);
          yPos += 6;
        }
        
        // Total
        pdf.setFillColor(240, 240, 240);
        pdf.rect(10, yPos, 190, 7, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Total Hafalan Bulan Ini:', 85, yPos + 4.5, { align: 'right' });
        pdf.text(`${jumlahHalamanBaru} Halaman`, 170, yPos + 4.5, { align: 'center' });
        
        yPos += 12;
        
        // Total Keseluruhan
        if (yPos > 280) {
          pdf.addPage([210, 330]);
          yPos = 15;
        }
        
        pdf.setFillColor(0, 0, 0);
        pdf.rect(10, yPos, 190, 6, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.text('Total Hafalan Al-Qur\'an Keseluruhan', 15, yPos + 4);
        
        yPos += 6;
        pdf.setTextColor(0, 0, 0);
        pdf.setFont('times', 'normal');
        
        pdf.setFillColor(240, 240, 240);
        pdf.rect(10, yPos, 95, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Hafalan Awal', 15, yPos + 4);
        pdf.rect(105, yPos, 95, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${santri.total_hafalan_juz} Juz ${santri.total_hafalan_halaman} Halaman`, 152.5, yPos + 4, { align: 'center' });
        
        yPos += 6;
        
        pdf.setFillColor(240, 240, 240);
        pdf.rect(10, yPos, 95, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Hafalan Bulan Ini', 15, yPos + 4);
        pdf.rect(105, yPos, 95, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${jumlahHalamanBaru} Halaman`, 152.5, yPos + 4, { align: 'center' });
        
        yPos += 6;
        
        pdf.setFillColor(224, 224, 224);
        pdf.rect(10, yPos, 95, 7, 'FD');
        pdf.setFont('times', 'bold');
        pdf.setFontSize(10);
        pdf.text('Total Keseluruhan', 15, yPos + 4.5);
        pdf.rect(105, yPos, 95, 7, 'FD');
        pdf.text(`${totalJuzKeseluruhan} Juz ${sisaHalaman} Halaman`, 152.5, yPos + 4.5, { align: 'center' });
        
        yPos += 12;
        
        // Catatan
        if (yPos > 270) {
          pdf.addPage([210, 330]);
          yPos = 15;
        }
        
        pdf.setLineWidth(0.5);
        pdf.rect(10, yPos, 190, 25);
        pdf.setFont('times', 'bold');
        pdf.setFontSize(10);
        pdf.text('Catatan dan Saran:', 15, yPos + 5);
        
        pdf.setFont('times', 'normal');
        pdf.setFontSize(9);
        const lines = pdf.splitTextToSize(catatanBulanan, 180);
        pdf.text(lines, 15, yPos + 11);
        
        yPos += 35;
        
        // Tanda Tangan
        if (yPos > 285) {
          pdf.addPage([210, 330]);
          yPos = 15;
        }
        
        pdf.setFont('times', 'normal');
        pdf.setFontSize(9);
        pdf.text('Orang Tua/Wali', 50, yPos, { align: 'center' });
        pdf.text('Pembimbing', 155, yPos, { align: 'center' });
        
        yPos += 18;
        
        pdf.setFont('times', 'bold');
        pdf.line(25, yPos, 75, yPos);
        pdf.text(santri.nama_wali, 50, yPos + 4, { align: 'center' });
        
        pdf.line(130, yPos, 180, yPos);
        pdf.text(pembimbing.nama_pembimbing, 155, yPos + 4, { align: 'center' });
        
        pdf.save('Laporan-Bulanan.pdf');
        showToast('PDF berhasil diunduh!', 'success');
      } catch (error) {
        console.error('Error creating PDF:', error);
        showToast('Gagal membuat PDF', 'error');
      }
    };

    window.cetakRaporSemester = async function() {
      showToast('Sedang membuat PDF...', 'success');
      
      try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', [210, 330]); // F4
        
        const santriId = document.getElementById('santri-rapor').value;
        const semester = document.getElementById('semester-rapor').value;
        const tahunAjaran = document.getElementById('tahun-ajaran-rapor').value;
        
        const santri = santriData.find(s => s.id === santriId);
        const pembimbing = pembimbingData.find(p => p.id === santri.id_pembimbing);
        
        const hafalanSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hafalan_baru'));
        const tahsinSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tahsin'));
        const murajaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'murajaah'));
        const haditsSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'hadits'));
        const mutabaahSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'mutabaah'));
        const absensiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'absensi'));
        const tasmiSnapshot = await window.firestore.getDocs(window.firestore.collection(window.db, 'tasmi'));
        
        const hafalan = hafalanSnapshot.docs.map(doc => doc.data()).filter(h => h.id_santri === santriId);
        const tahsin = tahsinSnapshot.docs.map(doc => doc.data()).filter(t => t.id_santri === santriId);
        const murajaah = murajaahSnapshot.docs.map(doc => doc.data()).filter(m => m.id_santri === santriId);
        const hadits = haditsSnapshot.docs.map(doc => doc.data()).filter(h => h.id_santri === santriId);
        const mutabaah = mutabaahSnapshot.docs.map(doc => doc.data()).filter(m => m.id_santri === santriId);
        const absensi = absensiSnapshot.docs.map(doc => doc.data()).filter(a => a.id_santri === santriId);
        const tasmi = tasmiSnapshot.docs.map(doc => doc.data()).filter(t => t.id_santri === santriId);
        
        const hitungRataRata = (data) => {
          if (data.length === 0) return '-';
          const nilaiMap = { 'A': 4, 'B': 3, 'C': 2, 'D': 1 };
          const total = data.reduce((sum, item) => sum + (nilaiMap[item.nilai] || 0), 0);
          const rata = total / data.length;
          if (rata >= 3.5) return 'A';
          if (rata >= 2.5) return 'B';
          if (rata >= 1.5) return 'C';
          return 'D';
        };
        
        const hadir = absensi.filter(a => a.status === 'H').length;
        const izin = absensi.filter(a => a.status === 'I').length;
        const sakit = absensi.filter(a => a.status === 'S').length;
        const alpha = absensi.filter(a => a.status === 'A').length;
        
        const jumlahHalamanSemester = hafalan.length;
        const totalHaditsSemester = hadits.length;
        const halamanAwal = ((santri.total_hafalan_juz || 0) * 20) + (santri.total_hafalan_halaman || 0);
        const totalHalamanKeseluruhan = halamanAwal + jumlahHalamanSemester;
        const totalJuzKeseluruhan = Math.floor(totalHalamanKeseluruhan / 20);
        const sisaHalaman = totalHalamanKeseluruhan % 20;
        const totalHaditsKeseluruhan = (santri.total_hadits || 0) + totalHaditsSemester;
        
        let catatanSemester = '';
        if (jumlahHalamanSemester >= 60) {
          catatanSemester = 'MasyaaAllah tabarakallah! Pencapaian luar biasa selama semester ini. Santri menunjukkan dedikasi dan konsistensi yang sangat tinggi dalam menghafal Al-Qur\'an. ';
        } else if (jumlahHalamanSemester >= 40) {
          catatanSemester = 'Alhamdulillah, pencapaian hafalan semester ini sangat baik dan patut diapresiasi. Terus pertahankan semangat dan tingkatkan kualitas hafalan. ';
        } else if (jumlahHalamanSemester >= 20) {
          catatanSemester = 'Pencapaian hafalan semester ini cukup baik, namun masih ada ruang untuk peningkatan. Tingkatkan konsistensi dan fokus dalam menghafal. ';
        } else if (jumlahHalamanSemester >= 1) {
          catatanSemester = 'Pencapaian hafalan semester ini masih perlu ditingkatkan secara signifikan. Perlu evaluasi mendalam dan strategi baru untuk meningkatkan progress. ';
        } else {
          catatanSemester = 'Belum ada penambahan hafalan selama semester ini. Diperlukan perhatian khusus dan intervensi intensif untuk meningkatkan motivasi dan kemampuan menghafal. ';
        }
        
        const nilaiHafalan = hitungRataRata(hafalan);
        const nilaiMurajaah = hitungRataRata(murajaah);
        
        if (nilaiHafalan === 'A' && nilaiMurajaah === 'A') {
          catatanSemester += 'Kualitas hafalan dan murajaah sangat baik. ';
        } else if ((nilaiHafalan === 'A' || nilaiHafalan === 'B') && (nilaiMurajaah === 'A' || nilaiMurajaah === 'B')) {
          catatanSemester += 'Kualitas hafalan dan murajaah baik. ';
        } else {
          catatanSemester += 'Kualitas hafalan dan murajaah perlu ditingkatkan. ';
        }
        
        const totalHariSemester = hadir + izin + sakit + alpha;
        if (totalHariSemester > 0) {
          const persenKehadiranSemester = (hadir / totalHariSemester) * 100;
          if (persenKehadiranSemester >= 90) {
            catatanSemester += 'Kehadiran sangat baik dan konsisten, pertahankan kedisiplinan ini. ';
          } else if (persenKehadiranSemester >= 75) {
            catatanSemester += 'Kehadiran cukup baik, tingkatkan konsistensi kehadiran. ';
          } else {
            catatanSemester += 'Kehadiran masih rendah dan perlu ditingkatkan secara signifikan. ';
          }
        }
        
        catatanSemester += 'Saran untuk semester mendatang: ';
        if (jumlahHalamanSemester >= 40) {
          catatanSemester += 'Pertahankan target hafalan minimal 1 halaman per hari dan tingkatkan kualitas tajwid serta pemahaman makna.';
        } else if (jumlahHalamanSemester >= 20) {
          catatanSemester += 'Tingkatkan target hafalan menjadi minimal 1 halaman per hari dan perbanyak murajaah.';
        } else {
          catatanSemester += 'Fokus membangun rutinitas menghafal yang konsisten, mulai dari target kecil dan bertahap tingkatkan.';
        }
        
        pdf.setFont('times', 'normal');
        
        let yPos = 15;
        
        // Header
        pdf.setLineWidth(0.5);
        pdf.rect(10, 10, 190, 30);
        pdf.setLineWidth(0.3);
        pdf.rect(10.5, 10.5, 189, 29);
        
        pdf.setFontSize(15);
        pdf.setFont('times', 'bold');
        pdf.text('RAPOR TAHFIDZ AL-QUR\'AN', 105, yPos, { align: 'center' });
        
        yPos += 6;
        pdf.setFontSize(12);
        pdf.setFont('times', 'normal');
        pdf.text(defaultConfig.madrasah_name, 105, yPos, { align: 'center' });
        
        yPos += 5;
        pdf.setFontSize(8);
        pdf.text('Jl. Poros Palopo Makassar, Desa Mattirowalie, Kec. Maniangpajo, Kab. Wajo, Sulawesi Selatan', 105, yPos, { align: 'center' });
        
        yPos += 5;
        pdf.setFontSize(10);
        pdf.setFont('times', 'bold');
        pdf.text(`Semester ${semester} - Tahun Ajaran ${tahunAjaran}`, 105, yPos, { align: 'center' });
        
        yPos = 47;
        
        // Data Santri
        pdf.setFont('times', 'normal');
        pdf.setFontSize(10);
        pdf.text('Nama Santri', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.setFont('times', 'bold');
        pdf.text(santri.nama_santri, 65, yPos);
        
        yPos += 6;
        pdf.setFont('times', 'normal');
        pdf.text('NIS', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.text(santri.nis, 65, yPos);
        
        yPos += 6;
        pdf.text('Kelas', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.text(santri.kelas, 65, yPos);
        
        yPos += 6;
        pdf.text('Nama Orang Tua/Wali', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.text(santri.nama_wali, 65, yPos);
        
        yPos += 6;
        pdf.text('Pembimbing', 15, yPos);
        pdf.text(':', 60, yPos);
        pdf.text(pembimbing.nama_pembimbing, 65, yPos);
        
        yPos += 12;
        
        // Capaian Pembelajaran
        pdf.setFillColor(0, 0, 0);
        pdf.rect(10, yPos, 190, 7, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFont('times', 'bold');
        pdf.setFontSize(11);
        pdf.text('CAPAIAN PEMBELAJARAN', 15, yPos + 5);
        
        yPos += 7;
        pdf.setTextColor(0, 0, 0);
        
        // Header tabel
        pdf.setFillColor(224, 224, 224);
        pdf.rect(10, yPos, 100, 7, 'FD');
        pdf.rect(110, yPos, 45, 7, 'FD');
        pdf.rect(155, yPos, 45, 7, 'FD');
        pdf.setFontSize(9);
        pdf.text('Aspek Penilaian', 15, yPos + 4.5);
        pdf.text('Nilai', 132.5, yPos + 4.5, { align: 'center' });
        pdf.text('Jumlah', 177.5, yPos + 4.5, { align: 'center' });
        
        yPos += 7;
        pdf.setFont('times', 'normal');
        
        // Data penilaian
        const penilaian = [
          ['Hafalan Baru', hitungRataRata(hafalan), `${hafalan.length} kali`],
          ['Tahsin (Makharijul Huruf)', hitungRataRata(tahsin.filter(t => t.kategori === 'Makharijul Huruf')), `${tahsin.filter(t => t.kategori === 'Makharijul Huruf').length} kali`],
          ['Tahsin (Tajwid)', hitungRataRata(tahsin.filter(t => t.kategori === 'Tajwid')), `${tahsin.filter(t => t.kategori === 'Tajwid').length} kali`],
          ['Murajaah', hitungRataRata(murajaah), `${murajaah.length} kali`],
          ['Hafalan Hadits', hitungRataRata(hadits), `${hadits.length} hadits`],
          ['Mutaba\'ah Yaumiyah', hitungRataRata(mutabaah), `${mutabaah.length} hari`],
          ['Tasmi\' (Setoran Juz)', hitungRataRata(tasmi), `${tasmi.length} juz`]
        ];
        
        penilaian.forEach((item, idx) => {
          if (idx % 2 === 0) {
            pdf.setFillColor(249, 249, 249);
            pdf.rect(10, yPos, 190, 7, 'F');
          }
          
          pdf.rect(10, yPos, 100, 7);
          pdf.rect(110, yPos, 45, 7);
          pdf.rect(155, yPos, 45, 7);
          
          pdf.text(item[0], 15, yPos + 4.5);
          pdf.setFont('times', 'bold');
          pdf.setFontSize(11);
          pdf.text(item[1], 132.5, yPos + 4.5, { align: 'center' });
          pdf.setFont('times', 'normal');
          pdf.setFontSize(9);
          pdf.text(item[2], 177.5, yPos + 4.5, { align: 'center' });
          
          yPos += 7;
        });
        
        yPos += 5;
        
        // Rekap Kehadiran
        pdf.setFillColor(0, 0, 0);
        pdf.rect(10, yPos, 190, 6, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFont('times', 'bold');
        pdf.setFontSize(11);
        pdf.text('REKAP KEHADIRAN', 15, yPos + 4.5);
        
        yPos += 6;
        pdf.setTextColor(0, 0, 0);
        pdf.setFontSize(9);
        pdf.setFont('times', 'normal');
        
        pdf.setFillColor(224, 224, 224);
        pdf.rect(10, yPos, 47.5, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Hadir', 15, yPos + 4);
        pdf.rect(57.5, yPos, 47.5, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${hadir} hari`, 81.25, yPos + 4, { align: 'center' });
        
        pdf.setFillColor(224, 224, 224);
        pdf.rect(105, yPos, 47.5, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Izin', 110, yPos + 4);
        pdf.rect(152.5, yPos, 47.5, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${izin} hari`, 176.25, yPos + 4, { align: 'center' });
        
        yPos += 6;
        
        pdf.setFillColor(224, 224, 224);
        pdf.rect(10, yPos, 47.5, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Sakit', 15, yPos + 4);
        pdf.rect(57.5, yPos, 47.5, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${sakit} hari`, 81.25, yPos + 4, { align: 'center' });
        
        pdf.setFillColor(224, 224, 224);
        pdf.rect(105, yPos, 47.5, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Alpha', 110, yPos + 4);
        pdf.rect(152.5, yPos, 47.5, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${alpha} hari`, 176.25, yPos + 4, { align: 'center' });
        
        yPos += 12;
        
        // Total Hafalan
        if (yPos > 260) {
          pdf.addPage([210, 330]);
          yPos = 15;
        }
        
        pdf.setFillColor(0, 0, 0);
        pdf.rect(10, yPos, 190, 6, 'F');
        pdf.setTextColor(255, 255, 255);
        pdf.setFont('times', 'bold');
        pdf.setFontSize(11);
        pdf.text('TOTAL HAFALAN KESELURUHAN', 15, yPos + 4.5);
        
        yPos += 6;
        pdf.setTextColor(0, 0, 0);
        pdf.setFontSize(9);
        
        pdf.setFillColor(249, 249, 249);
        pdf.rect(10, yPos, 95, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.text('Hafalan Al-Qur\'an Awal', 15, yPos + 4);
        pdf.rect(105, yPos, 95, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${santri.total_hafalan_juz} Juz ${santri.total_hafalan_halaman} Halaman`, 152.5, yPos + 4, { align: 'center' });
        
        yPos += 6;
        
        pdf.rect(10, yPos, 95, 6, 'D');
        pdf.setFont('times', 'bold');
        pdf.text('Hafalan Semester Ini', 15, yPos + 4);
        pdf.rect(105, yPos, 95, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${jumlahHalamanSemester} Halaman`, 152.5, yPos + 4, { align: 'center' });
        
        yPos += 6;
        
        pdf.setFillColor(208, 208, 208);
        pdf.rect(10, yPos, 95, 7, 'FD');
        pdf.setFont('times', 'bold');
        pdf.setFontSize(10);
        pdf.text('Total Hafalan Al-Qur\'an', 15, yPos + 4.5);
        pdf.rect(105, yPos, 95, 7, 'FD');
        pdf.text(`${totalJuzKeseluruhan} Juz ${sisaHalaman} Halaman`, 152.5, yPos + 4.5, { align: 'center' });
        
        yPos += 7;
        
        pdf.setFillColor(249, 249, 249);
        pdf.rect(10, yPos, 95, 6, 'FD');
        pdf.setFont('times', 'bold');
        pdf.setFontSize(9);
        pdf.text('Hafalan Hadits Awal', 15, yPos + 4);
        pdf.rect(105, yPos, 95, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${santri.total_hadits} Hadits`, 152.5, yPos + 4, { align: 'center' });
        
        yPos += 6;
        
        pdf.rect(10, yPos, 95, 6, 'D');
        pdf.setFont('times', 'bold');
        pdf.text('Hafalan Hadits Semester Ini', 15, yPos + 4);
        pdf.rect(105, yPos, 95, 6, 'D');
        pdf.setFont('times', 'normal');
        pdf.text(`${totalHaditsSemester} Hadits`, 152.5, yPos + 4, { align: 'center' });
        
        yPos += 6;
        
        pdf.setFillColor(208, 208, 208);
        pdf.rect(10, yPos, 95, 7, 'FD');
        pdf.setFont('times', 'bold');
        pdf.setFontSize(10);
        pdf.text('Total Hafalan Hadits', 15, yPos + 4.5);
        pdf.rect(105, yPos, 95, 7, 'FD');
        pdf.text(`${totalHaditsKeseluruhan} Hadits`, 152.5, yPos + 4.5, { align: 'center' });
        
        yPos += 12;
        
        // Catatan
        if (yPos > 260) {
          pdf.addPage([210, 330]);
          yPos = 15;
        }
        
        pdf.setLineWidth(0.5);
        pdf.rect(10, yPos, 190, 30);
        pdf.setFont('times', 'bold');
        pdf.setFontSize(10);
        pdf.text('CATATAN DAN SARAN PEMBIMBING:', 15, yPos + 5);
        
        pdf.setFont('times', 'normal');
        pdf.setFontSize(9);
        const linesRapor = pdf.splitTextToSize(catatanSemester, 180);
        pdf.text(linesRapor, 15, yPos + 11);
        
        yPos += 40;
        
        // Tanda Tangan
        if (yPos > 280) {
          pdf.addPage([210, 330]);
          yPos = 15;
        }
        
        pdf.setFont('times', 'normal');
        pdf.setFontSize(9);
        pdf.text('Orang Tua/Wali', 50, yPos, { align: 'center' });
        pdf.text('Pembimbing', 155, yPos, { align: 'center' });
        
        yPos += 20;
        
        pdf.setFont('times', 'bold');
        pdf.line(25, yPos, 75, yPos);
        pdf.text(santri.nama_wali, 50, yPos + 5, { align: 'center' });
        
        pdf.line(130, yPos, 180, yPos);
        pdf.text(pembimbing.nama_pembimbing, 155, yPos + 5, { align: 'center' });
        
        yPos += 15;
        
        // Keterangan Nilai
        pdf.setLineWidth(0.3);
        pdf.setFillColor(240, 240, 240);
        pdf.rect(10, yPos, 190, 12, 'FD');
        pdf.setFont('times', 'bold');
        pdf.setFontSize(9);
        pdf.text('Keterangan Nilai:', 15, yPos + 4);
        pdf.setFont('times', 'normal');
        pdf.text('A = Mumtaz (Istimewa) | B = Jayyid Jiddan (Sangat Baik) | C = Jayyid (Baik) | D = Maqbul (Cukup)', 15, yPos + 9);
        
        pdf.save('Rapor-Semester.pdf');
        showToast('PDF berhasil diunduh!', 'success');
      } catch (error) {
        console.error('Error creating PDF:', error);
        showToast('Gagal membuat PDF', 'error');
      }
    };

    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b8b18c9a38b2035',t:'MTc2NzUzMzQ5NC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
